!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Wang={})}(this,function(e){"use strict";class t{}function s(e,t=".wang"){return e.endsWith(t)||e.includes(".")?e:e+t}class r extends Error{constructor(e,t={type:"RuntimeError"},s){super(e),this.name="WangError",this.context=t,this.originalError=s,Error.captureStackTrace&&Error.captureStackTrace(this,r)}toString(){return this.message}getFormattedMessage(e){let t=this.message;return this.context.suggestions&&this.context.suggestions.length>0&&(t+="\n\nüí° Suggestions:\n",this.context.suggestions.forEach((e,s)=>{t+=`   ${s+1}. ${e}\n`})),this.context.variables&&Object.keys(this.context.variables).length>0&&(t+="\n\nüìä Variables in scope:\n",Object.entries(this.context.variables).forEach(([e,s])=>{const r=this.formatValue(s);t+=`   ‚Ä¢ ${e}: ${r}\n`})),this.context.stackTrace&&this.context.stackTrace.length>0&&(t+="\n\nüìç Stack trace:\n",this.context.stackTrace.forEach(e=>{t+=`   ${e}\n`})),t}formatValue(e){return null===e?"null":void 0===e?"undefined":"string"==typeof e?`"${e}"`:"number"==typeof e||"boolean"==typeof e?String(e):Array.isArray(e)?`[array of ${e.length} items]`:"object"==typeof e?`{${Object.keys(e).join(", ")}}`:typeof e}}class n extends r{constructor(e,t=[]){const s=[];if(t.length>0){const r=t.filter(t=>t.includes(e.split("/").pop()||"")).slice(0,3);r.length>0&&s.push(`Did you mean one of these? ${r.join(", ")}`)}s.push("Check that the module path is correct"),s.push("Ensure the module has been added to the resolver"),super(`Module not found: "${e}"`,{type:"ModuleError",suggestions:s})}}class o extends r{constructor(e,t,s){const r=typeof t;let n="undefined";try{n=void 0===t?"undefined":null===t?"null":JSON.stringify(t).substring(0,50)}catch(e){n=String(t).substring(0,50)}super(`Type mismatch in ${s}:\n   Expected: ${e}\n   Received: ${r} (${n})`,{type:"RuntimeError",suggestions:[`Check that the value is of type ${e}`,"Use type conversion if necessary","Verify the data source"]})}}class a extends r{constructor(e,t){const s=[],r=t.filter(t=>t.includes(e)||e.includes(t)).slice(0,3);r.length>0&&s.push(`Did you mean: ${r.join(", ")}?`),s.push("Check for typos in the variable name"),s.push("Ensure the variable is declared before use"),super(`Variable "${e}" is not defined`,{type:"RuntimeError",suggestions:s,variables:Object.fromEntries(t.slice(0,10).map(e=>[e,"..."]))})}}class i extends t{constructor(){super(),this.modules=new Map,this.metadata=new Map}addModule(e,t,r){const n=s(e);return this.modules.set(n,t),r&&this.metadata.set(n,r),this}addModules(e){return Object.entries(e).forEach(([e,t])=>{this.addModule(e,t)}),this}removeModule(e){const t=s(e);return this.metadata.delete(t),this.modules.delete(t)}async resolve(e,t){const r=function(e,t){return t&&e.startsWith(".")?function(e){const t=e.split("/"),s=[];for(const e of t)".."===e?s.pop():e&&"."!==e&&s.push(e);return s.join("/")}(t.split("/").slice(0,-1).join("/")+"/"+e):e}(e,t),o=s(r);if(this.modules.has(o))return{code:this.modules.get(o),path:o,metadata:this.metadata.get(o)};if(this.modules.has(r))return{code:this.modules.get(r),path:r,metadata:this.metadata.get(r)};const a=s(r+"/index");if(this.modules.has(a))return{code:this.modules.get(a),path:a,metadata:this.metadata.get(a)};const i=await this.list();throw new n(e,i)}async exists(e,t){try{return await this.resolve(e,t),!0}catch{return!1}}async list(e){const t=Array.from(this.modules.keys());return e?t.filter(t=>t.startsWith(e)):t}clearCache(){this.modules.clear(),this.metadata.clear()}async getMetadata(e){const t=s(e);return this.metadata.get(t)||null}get size(){return this.modules.size}get isEmpty(){return 0===this.modules.size}exportModules(){const e={};return this.modules.forEach((t,s)=>{e[s]={code:t,metadata:this.metadata.get(s)}}),e}importModules(e){return Object.entries(e).forEach(([e,{code:t,metadata:s}])=>{this.modules.set(e,t),s&&this.metadata.set(e,s)}),this}}function l(e){const t=[...e];for(let e=t.length-1;e>0;e--){const s=Math.floor(Math.random()*(e+1));[t[e],t[s]]=[t[s],t[e]]}return t}function c(e){return e.reduce((e,t)=>e+t,0)}function u(e){return new Promise(t=>setTimeout(t,e))}const p={sort_by:function(e,t){const s=[...e];if(!t)return s.sort();const r="string"==typeof t?e=>e?.[t]:t;return s.sort((e,t)=>{const s=r(e),n=r(t);return s<n?-1:s>n?1:0})},reverse:function(e){return[...e].reverse()},unique:function(e){return[...new Set(e)]},unique_by:function(e,t){const s="string"==typeof t?e=>e?.[t]:t,r=new Set,n=[];for(const t of e){const e=s(t);r.has(e)||(r.add(e),n.push(t))}return n},group_by:function(e,t){const s="string"==typeof t?e=>e?.[t]:t,r={};for(const t of e){const e=String(s(t));r[e]||(r[e]=[]),r[e].push(t)}return r},chunk:function(e,t=1){const s=[];for(let r=0;r<e.length;r+=t)s.push(e.slice(r,r+t));return s},flatten:function e(t,s=1){return s<=0?[...t]:t.reduce((t,r)=>Array.isArray(r)?t.concat(e(r,s-1)):t.concat(r),[])},first:function(e,t=1){return 1===t?e[0]:e.slice(0,t)},last:function(e,t=1){return 1===t?e[e.length-1]:e.slice(-t)},take:function(e,t){return e.slice(0,t)},drop:function(e,t){return e.slice(t)},shuffle:l,sample:function(e,t=1){const s=l(e);return 1===t?s[0]:s.slice(0,t)},zip:function(...e){const t=Math.min(...e.map(e=>e.length)),s=[];for(let r=0;r<t;r++)s.push(e.map(e=>e[r]));return s},partition:function(e,t){const s=[],r=[];for(const n of e)(t(n)?s:r).push(n);return[s,r]},keys:function(e){return Object.keys(e||{})},values:function(e){return Object.values(e||{})},entries:function(e){return Object.entries(e||{})},pick:function(e,t){const s={};for(const r of t)r in e&&(s[r]=e[r]);return s},omit:function(e,t){const s={...e};for(const e of t)delete s[e];return s},merge:function(...e){return Object.assign({},...e)},get:function(e,t,s){if("number"==typeof t){const r=e?.[t];return void 0===r?s:r}const r=String(t).split(".");let n=e;for(const e of r){if(null==n)return s;n=n[e]}return void 0===n?s:n},set:function(e,t,s){const r=t.split("."),n={...e};let o=n;for(let e=0;e<r.length-1;e++){const t=r[e];t in o&&"object"==typeof o[t]||(o[t]={}),o[t]={...o[t]},o=o[t]}return o[r[r.length-1]]=s,n},clone:function e(t){if(null===t||"object"!=typeof t)return t;if(t instanceof Date)return new Date(t.getTime());if(Array.isArray(t))return t.map(t=>e(t));const s={};for(const r in t)Object.prototype.hasOwnProperty.call(t,r)&&(s[r]=e(t[r]));return s},split:function(e,t=""){return e.split(t)},join:function(e,t=","){return e.join(t)},trim:function(e){return e.trim()},trim_start:function(e){return e.trimStart()},trim_end:function(e){return e.trimEnd()},replace_all:function(e,t,s){return e.split(t).join(s)},upper:function(e){return e.toUpperCase()},lower:function(e){return e.toLowerCase()},capitalize:function(e){return e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()},starts_with:function(e,t){return e.startsWith(t)},ends_with:function(e,t){return e.endsWith(t)},includes:function(e,t){return e.includes(t)},pad_start:function(e,t,s=" "){return e.padStart(t,s)},pad_end:function(e,t,s=" "){return e.padEnd(t,s)},truncate:function(e,t,s="..."){return e.length<=t?e:e.slice(0,t-s.length)+s},map:async function(e,t){const s=[];for(let r=0;r<e.length;r++)s.push(await t(e[r],r));return s},filter:async function(e,t){const s=[];for(let r=0;r<e.length;r++)await t(e[r],r)&&s.push(e[r]);return s},reduce:async function(e,t,s){let r=arguments.length>2?s:e[0];for(let s=arguments.length>2?0:1;s<e.length;s++)r=await t(r,e[s],s);return r},find:async function(e,t){for(let s=0;s<e.length;s++)if(await t(e[s],s))return e[s]},find_index:async function(e,t){for(let s=0;s<e.length;s++)if(await t(e[s],s))return s;return-1},every:async function(e,t){for(let s=0;s<e.length;s++)if(!await t(e[s],s))return!1;return!0},some:async function(e,t){for(let s=0;s<e.length;s++)if(await t(e[s],s))return!0;return!1},count:async function(e,t){if(!t)return e.length;let s=0;for(const r of e)await t(r)&&s++;return s},is_array:function(e){return Array.isArray(e)},is_object:function(e){return null!==e&&"object"==typeof e&&!Array.isArray(e)},is_string:function(e){return"string"==typeof e},is_number:function(e){return"number"==typeof e&&!isNaN(e)},is_boolean:function(e){return"boolean"==typeof e},is_function:function(e){return"function"==typeof e},is_null:function(e){return null===e},is_empty:function(e){return null==e||(Array.isArray(e)||"string"==typeof e?0===e.length:"object"==typeof e&&0===Object.keys(e).length)},min:function(e){return 0===e.length?1/0:Math.min(...e)},max:function(e){return 0===e.length?-1/0:Math.max(...e)},sum:c,avg:function(e){return 0===e.length?0:c(e)/e.length},median:function(e){if(0===e.length)return 0;const t=[...e].sort((e,t)=>e-t),s=Math.floor(t.length/2);return t.length%2==0?(t[s-1]+t[s])/2:t[s]},round:function(e,t=0){const s=Math.pow(10,t);return Math.round(e*s)/s},floor:function(e){return Math.floor(e)},ceil:function(e){return Math.ceil(e)},abs:function(e){return Math.abs(e)},clamp:function(e,t,s){return Math.min(Math.max(e,t),s)},range:function(e,t,s=1){void 0===t&&(t=e,e=0);const r=[];if(s>0)for(let n=e;n<t;n+=s)r.push(n);else if(s<0)for(let n=e;n>t;n+=s)r.push(n);return r},sleep:u,wait:function(e){return u(e)},uuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})},to_json:function(e,t=!1){return t?JSON.stringify(e,null,2):JSON.stringify(e)},from_json:function(e){return JSON.parse(e)},to_base64:function(e){return"undefined"!=typeof btoa?btoa(e):Buffer.from(e,"utf8").toString("base64")},from_base64:function(e){return"undefined"!=typeof atob?atob(e):Buffer.from(e,"base64").toString("utf8")}},m=(()=>{const e={exports:{}};var t,s;return t=void 0,s=function(){var e=Object.prototype.hasOwnProperty,t=Object.prototype.toString,s="boolean"==typeof(new RegExp).sticky;function r(e){return e&&"[object RegExp]"===t.call(e)}function n(e){return e&&"object"==typeof e&&!r(e)&&!Array.isArray(e)}function o(e){return new RegExp("|"+e).exec("").length-1}function a(e){return"("+e+")"}function i(e){return e.length?"(?:"+e.map(function(e){return"(?:"+e+")"}).join("|")+")":"(?!)"}function l(e){if("string"==typeof e)return"(?:"+e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")+")";if(r(e)){if(e.ignoreCase)throw new Error("RegExp /i flag not allowed");if(e.global)throw new Error("RegExp /g flag is implied");if(e.sticky)throw new Error("RegExp /y flag is implied");if(e.multiline)throw new Error("RegExp /m flag is implied");return e.source}throw new Error("Not a pattern: "+e)}function c(e,t){return e.length>t?e:Array(t-e.length+1).join(" ")+e}function u(t,s){if(n(s)||(s={match:s}),s.include)throw new Error("Matching rules cannot also include states");var o={defaultType:t,lineBreaks:!!s.error||!!s.fallback,pop:!1,next:null,push:null,error:!1,fallback:!1,value:null,type:null,shouldThrow:!1};for(var a in s)e.call(s,a)&&(o[a]=s[a]);if("string"==typeof o.type&&t!==o.type)throw new Error("Type transform cannot be a string (type '"+o.type+"' for token '"+t+"')");var i=o.match;return o.match=Array.isArray(i)?i:i?[i]:[],o.match.sort(function(e,t){return r(e)&&r(t)?0:r(t)?-1:r(e)?1:t.length-e.length}),o}function p(e){return Array.isArray(e)?function(e){for(var t=[],s=0;s<e.length;s++){var r=e[s];if(r.include)for(var n=[].concat(r.include),o=0;o<n.length;o++)t.push({include:n[o]});else{if(!r.type)throw new Error("Rule has no type: "+JSON.stringify(r));t.push(u(r.type,r))}}return t}(e):function(e){for(var t=Object.getOwnPropertyNames(e),s=[],r=0;r<t.length;r++){var o=t[r],a=e[o],i=[].concat(a);if("include"!==o){var l=[];i.forEach(function(e){n(e)?(l.length&&s.push(u(o,l)),s.push(u(o,e)),l=[]):l.push(e)}),l.length&&s.push(u(o,l))}else for(var c=0;c<i.length;c++)s.push({include:i[c]})}return s}(e)}var m=u("error",{lineBreaks:!0,shouldThrow:!0});function h(e,t){for(var n=null,c=Object.create(null),u=!0,p=null,h=[],f=[],y=0;y<e.length;y++)e[y].fallback&&(u=!1);for(y=0;y<e.length;y++){var b=e[y];if(b.include)throw new Error("Inheritance is not allowed in stateless lexers");if(b.error||b.fallback){if(n)throw!b.fallback==!n.fallback?new Error("Multiple "+(b.fallback?"fallback":"error")+" rules not allowed (for token '"+b.defaultType+"')"):new Error("fallback and error are mutually exclusive (for token '"+b.defaultType+"')");n=b}var d=b.match.slice();if(u)for(;d.length&&"string"==typeof d[0]&&1===d[0].length;)c[d.shift().charCodeAt(0)]=b;if(b.pop||b.push||b.next){if(!t)throw new Error("State-switching options are not allowed in stateless lexers (for token '"+b.defaultType+"')");if(b.fallback)throw new Error("State-switching options are not allowed on fallback tokens (for token '"+b.defaultType+"')")}if(0!==d.length){u=!1,h.push(b);for(var x=0;x<d.length;x++){var v=d[x];if(r(v))if(null===p)p=v.unicode;else if(p!==v.unicode&&!1===b.fallback)throw new Error("If one rule is /u then all must be")}var g=i(d.map(l)),E=new RegExp(g);if(E.test(""))throw new Error("RegExp matches empty string: "+E);if(o(g)>0)throw new Error("RegExp has capture groups: "+E+"\nUse (?: ‚Ä¶ ) instead");if(!b.lineBreaks&&E.test("\n"))throw new Error("Rule should declare lineBreaks: "+E);f.push(a(g))}}var w=n&&n.fallback,$=s&&!w?"ym":"gm",S=s||w?"":"|";return!0===p&&($+="u"),{regexp:new RegExp(i(f)+S,$),groups:h,fast:c,error:n||m}}function f(e,t,s){var r=e&&(e.push||e.next);if(r&&!s[r])throw new Error("Missing state '"+r+"' (in token '"+e.defaultType+"' of state '"+t+"')");if(e&&e.pop&&1!==+e.pop)throw new Error("pop must be 1 (in token '"+e.defaultType+"' of state '"+t+"')")}var y=function(e,t){this.startState=t,this.states=e,this.buffer="",this.stack=[],this.reset()};y.prototype.reset=function(e,t){return this.buffer=e||"",this.index=0,this.line=t?t.line:1,this.col=t?t.col:1,this.queuedToken=t?t.queuedToken:null,this.queuedText=t?t.queuedText:"",this.queuedThrow=t?t.queuedThrow:null,this.setState(t?t.state:this.startState),this.stack=t&&t.stack?t.stack.slice():[],this},y.prototype.save=function(){return{line:this.line,col:this.col,state:this.state,stack:this.stack.slice(),queuedToken:this.queuedToken,queuedText:this.queuedText,queuedThrow:this.queuedThrow}},y.prototype.setState=function(e){if(e&&this.state!==e){this.state=e;var t=this.states[e];this.groups=t.groups,this.error=t.error,this.re=t.regexp,this.fast=t.fast}},y.prototype.popState=function(){this.setState(this.stack.pop())},y.prototype.pushState=function(e){this.stack.push(this.state),this.setState(e)};var b=s?function(e,t){return e.exec(t)}:function(e,t){var s=e.exec(t);return 0===s[0].length?null:s};function d(){return this.value}if(y.prototype._getGroup=function(e){for(var t=this.groups.length,s=0;s<t;s++)if(void 0!==e[s+1])return this.groups[s];throw new Error("Cannot find token type for matched text")},y.prototype.next=function(){var e=this.index;if(this.queuedGroup){var t=this._token(this.queuedGroup,this.queuedText,e);return this.queuedGroup=null,this.queuedText="",t}var s=this.buffer;if(e!==s.length){if(a=this.fast[s.charCodeAt(e)])return this._token(a,s.charAt(e),e);var r=this.re;r.lastIndex=e;var n=b(r,s),o=this.error;if(null==n)return this._token(o,s.slice(e,s.length),e);var a=this._getGroup(n),i=n[0];return o.fallback&&n.index!==e?(this.queuedGroup=a,this.queuedText=i,this._token(o,s.slice(e,n.index),e)):this._token(a,i,e)}},y.prototype._token=function(e,t,s){var r=0;if(e.lineBreaks){var n=/\n/g,o=1;if("\n"===t)r=1;else for(;n.exec(t);)r++,o=n.lastIndex}var a={type:"function"==typeof e.type&&e.type(t)||e.defaultType,value:"function"==typeof e.value?e.value(t):t,text:t,toString:d,offset:s,lineBreaks:r,line:this.line,col:this.col},i=t.length;if(this.index+=i,this.line+=r,0!==r?this.col=i-o+1:this.col+=i,e.shouldThrow)throw new Error(this.formatError(a,"invalid syntax"));return e.pop?this.popState():e.push?this.pushState(e.push):e.next&&this.setState(e.next),a},"undefined"!=typeof Symbol&&Symbol.iterator){var x=function(e){this.lexer=e};x.prototype.next=function(){var e=this.lexer.next();return{value:e,done:!e}},x.prototype[Symbol.iterator]=function(){return this},y.prototype[Symbol.iterator]=function(){return new x(this)}}return y.prototype.formatError=function(e,t){if(null==e){var s=this.buffer.slice(this.index);e={text:s,offset:this.index,lineBreaks:-1===s.indexOf("\n")?0:1,line:this.line,col:this.col}}var r=Math.max(e.line-2,1),n=e.line+2,o=String(n).length,a=function(e,t){for(var s=e.length,r=0;;){var n=e.lastIndexOf("\n",s-1);if(-1===n)break;if(s=n,++r===t)break;if(0===s)break}var o=r<t?0:s+1;return e.substring(o).split("\n")}(this.buffer,this.line-e.line+2+1).slice(0,5),i=[];i.push(t+" at line "+e.line+" col "+e.col+":"),i.push("");for(var l=0;l<a.length;l++){var u=a[l],p=r+l;i.push(c(String(p),o)+"  "+u),p===e.line&&i.push(c("",o+e.col+1)+"^")}return i.join("\n")},y.prototype.clone=function(){return new y(this.states,this.state)},y.prototype.has=function(e){return!0},{compile:function(e){var t=h(p(e));return new y({start:t},"start")},states:function(e,t){var s=e.$all?p(e.$all):[];delete e.$all;var r=Object.getOwnPropertyNames(e);t||(t=r[0]);for(var n=Object.create(null),o=0;o<r.length;o++)n[v=r[o]]=p(e[v]).concat(s);for(o=0;o<r.length;o++)for(var a=n[v=r[o]],i=Object.create(null),l=0;l<a.length;l++){var c=a[l];if(c.include){var u=[l,1];if(c.include!==v&&!i[c.include]){i[c.include]=!0;var m=n[c.include];if(!m)throw new Error("Cannot include nonexistent state '"+c.include+"' (in state '"+v+"')");for(var b=0;b<m.length;b++){var d=m[b];-1===a.indexOf(d)&&u.push(d)}}a.splice.apply(a,u),l--}}var x=Object.create(null);for(o=0;o<r.length;o++){var v;x[v=r[o]]=h(n[v],!0)}for(o=0;o<r.length;o++){var g=r[o],E=x[g],w=E.groups;for(l=0;l<w.length;l++)f(w[l],g,x);var $=Object.getOwnPropertyNames(E.fast);for(l=0;l<$.length;l++)f(E.fast[$[l]],g,x)}return new y(x,t)},error:Object.freeze({error:!0}),fallback:Object.freeze({fallback:!0}),keywords:function(e){for(var t="undefined"!=typeof Map,s=t?new Map:Object.create(null),r=Object.getOwnPropertyNames(e),n=0;n<r.length;n++){var o=r[n],a=e[o];(Array.isArray(a)?a:[a]).forEach(function(e){if("string"!=typeof e)throw new Error("keyword must be string (in keyword '"+o+"')");t?s.set(e,o):s[e]=o})}return function(e){return t?s.get(e):s[e]}}}},"function"==typeof define&&define.amd?define([],s):"object"==typeof e&&e.exports?e.exports=s():t.moo=s(),e.exports})(),h=function(){function e(t,s,r){return this.id=++e.highestId,this.name=t,this.symbols=s,this.postprocess=r,this}function t(e,t,s,r){this.rule=e,this.dot=t,this.reference=s,this.data=[],this.wantedBy=r,this.isComplete=this.dot===e.symbols.length}function s(e,t){this.grammar=e,this.index=t,this.states=[],this.wants={},this.scannable=[],this.completed={}}function r(e,t){this.rules=e,this.start=t||this.rules[0].name;var s=this.byName={};this.rules.forEach(function(e){s.hasOwnProperty(e.name)||(s[e.name]=[]),s[e.name].push(e)})}function n(){this.reset("")}function o(e,t,o){if(e instanceof r){var a=e;o=t}else a=r.fromCompiled(e,t);for(var i in this.grammar=a,this.options={keepHistory:!1,lexer:a.lexer||new n},o||{})this.options[i]=o[i];this.lexer=this.options.lexer,this.lexerState=void 0;var l=new s(a,0);this.table=[l],l.wants[a.start]=[],l.predict(a.start),l.process(),this.current=0}function a(e){var t=typeof e;if("string"===t)return e;if("object"===t){if(e.literal)return JSON.stringify(e.literal);if(e instanceof RegExp)return e.toString();if(e.type)return"%"+e.type;if(e.test)return"<"+String(e.test)+">";throw new Error("Unknown symbol type: "+e)}}return e.highestId=0,e.prototype.toString=function(e){var t=void 0===e?this.symbols.map(a).join(" "):this.symbols.slice(0,e).map(a).join(" ")+" ‚óè "+this.symbols.slice(e).map(a).join(" ");return this.name+" ‚Üí "+t},t.prototype.toString=function(){return"{"+this.rule.toString(this.dot)+"}, from: "+(this.reference||0)},t.prototype.nextState=function(e){var s=new t(this.rule,this.dot+1,this.reference,this.wantedBy);return s.left=this,s.right=e,s.isComplete&&(s.data=s.build(),s.right=void 0),s},t.prototype.build=function(){var e=[],t=this;do{e.push(t.right.data),t=t.left}while(t.left);return e.reverse(),e},t.prototype.finish=function(){this.rule.postprocess&&(this.data=this.rule.postprocess(this.data,this.reference,o.fail))},s.prototype.process=function(e){for(var t=this.states,s=this.wants,r=this.completed,n=0;n<t.length;n++){var a=t[n];if(a.isComplete){if(a.finish(),a.data!==o.fail){for(var i=a.wantedBy,l=i.length;l--;){var c=i[l];this.complete(c,a)}if(a.reference===this.index){var u=a.rule.name;(this.completed[u]=this.completed[u]||[]).push(a)}}}else{if("string"!=typeof(u=a.rule.symbols[a.dot])){this.scannable.push(a);continue}if(s[u]){if(s[u].push(a),r.hasOwnProperty(u)){var p=r[u];for(l=0;l<p.length;l++){var m=p[l];this.complete(a,m)}}}else s[u]=[a],this.predict(u)}}},s.prototype.predict=function(e){for(var s=this.grammar.byName[e]||[],r=0;r<s.length;r++){var n=s[r],o=this.wants[e],a=new t(n,0,this.index,o);this.states.push(a)}},s.prototype.complete=function(e,t){var s=e.nextState(t);this.states.push(s)},r.fromCompiled=function(t,s){var n=t.Lexer;t.ParserStart&&(s=t.ParserStart,t=t.ParserRules);var o=new r(t=t.map(function(t){return new e(t.name,t.symbols,t.postprocess)}),s);return o.lexer=n,o},n.prototype.reset=function(e,t){this.buffer=e,this.index=0,this.line=t?t.line:1,this.lastLineBreak=t?-t.col:0},n.prototype.next=function(){if(this.index<this.buffer.length){var e=this.buffer[this.index++];return"\n"===e&&(this.line+=1,this.lastLineBreak=this.index),{value:e}}},n.prototype.save=function(){return{line:this.line,col:this.index-this.lastLineBreak}},n.prototype.formatError=function(e,t){var s=this.buffer;if("string"==typeof s){var r=s.split("\n").slice(Math.max(0,this.line-5),this.line),n=s.indexOf("\n",this.index);-1===n&&(n=s.length);var o=this.index-this.lastLineBreak,a=String(this.line).length;return t+=" at line "+this.line+" col "+o+":\n\n",t+=r.map(function(e,t){return i(this.line-r.length+t+1,a)+" "+e},this).join("\n"),t+="\n"+i("",a+o)+"^\n"}return t+" at index "+(this.index-1);function i(e,t){var s=String(e);return Array(t-s.length+1).join(" ")+s}},o.fail={},o.prototype.feed=function(e){var t,r=this.lexer;for(r.reset(e,this.lexerState);;){try{if(!(t=r.next()))break}catch(e){var o=new s(this.grammar,this.current+1);throw this.table.push(o),(l=new Error(this.reportLexerError(e))).offset=this.current,l.token=e.token,l}var a=this.table[this.current];this.options.keepHistory||delete this.table[this.current-1];var i=this.current+1;o=new s(this.grammar,i);this.table.push(o);for(var l,c=void 0!==t.text?t.text:t.value,u=r.constructor===n?t.value:t,p=a.scannable,m=p.length;m--;){var h=p[m],f=h.rule.symbols[h.dot];if(f.test?f.test(u):f.type?f.type===t.type:f.literal===c){var y=h.nextState({data:u,token:t,isToken:!0,reference:i-1});o.states.push(y)}}if(o.process(),0===o.states.length)throw(l=new Error(this.reportError(t))).offset=this.current,l.token=t,l;this.options.keepHistory&&(a.lexerState=r.save()),this.current++}return a&&(this.lexerState=r.save()),this.results=this.finish(),this},o.prototype.reportLexerError=function(e){var t,s,r=e.token;return r?(t="input "+JSON.stringify(r.text[0])+" (lexer error)",s=this.lexer.formatError(r,"Syntax error")):(t="input (lexer error)",s=e.message),this.reportErrorCommon(s,t)},o.prototype.reportError=function(e){var t=(e.type?e.type+" token: ":"")+JSON.stringify(void 0!==e.value?e.value:e),s=this.lexer.formatError(e,"Syntax error");return this.reportErrorCommon(s,t)},o.prototype.reportErrorCommon=function(e,t){var s=[];s.push(e);var r=this.table.length-2,n=this.table[r],o=n.states.filter(function(e){var t=e.rule.symbols[e.dot];return t&&"string"!=typeof t});0===o.length?(s.push("Unexpected "+t+". I did not expect any more input. Here is the state of my parse table:\n"),this.displayStateStack(n.states,s)):(s.push("Unexpected "+t+". Instead, I was expecting to see one of the following:\n"),o.map(function(e){return this.buildFirstStateStack(e,[])||[e]},this).forEach(function(e){var t=e[0],r=t.rule.symbols[t.dot],n=this.getSymbolDisplay(r);s.push("A "+n+" based on:"),this.displayStateStack(e,s)},this));return s.push(""),s.join("\n")},o.prototype.displayStateStack=function(e,t){for(var s,r=0,n=0;n<e.length;n++){var o=e[n],a=o.rule.toString(o.dot);a===s?r++:(r>0&&t.push("    ^ "+r+" more lines identical to this"),r=0,t.push("    "+a)),s=a}},o.prototype.getSymbolDisplay=function(e){return function(e){var t=typeof e;if("string"===t)return e;if("object"===t){if(e.literal)return JSON.stringify(e.literal);if(e instanceof RegExp)return"character matching "+e;if(e.type)return e.type+" token";if(e.test)return"token matching "+String(e.test);throw new Error("Unknown symbol type: "+e)}}(e)},o.prototype.buildFirstStateStack=function(e,t){if(-1!==t.indexOf(e))return null;if(0===e.wantedBy.length)return[e];var s=e.wantedBy[0],r=[e].concat(t),n=this.buildFirstStateStack(s,r);return null===n?null:[e].concat(n)},o.prototype.save=function(){var e=this.table[this.current];return e.lexerState=this.lexerState,e},o.prototype.restore=function(e){var t=e.index;this.current=t,this.table[t]=e,this.table.splice(t+1),this.lexerState=e.lexerState,this.results=this.finish()},o.prototype.rewind=function(e){if(!this.options.keepHistory)throw new Error("set option `keepHistory` to enable rewinding");this.restore(this.table[e])},o.prototype.finish=function(){var e=[],t=this.grammar.start;return this.table[this.table.length-1].states.forEach(function(s){s.rule.name===t&&s.dot===s.rule.symbols.length&&0===s.reference&&s.data!==o.fail&&e.push(s)}),e.map(function(e){return e.data})},{Parser:o,Grammar:r,Rule:e}}();function f(e){return e[0]}const y=m.compile({WS:/[ \t\r]+/u,NL:{match:/\n/u,lineBreaks:!0},lineComment:/\/\/.*$/u,blockComment:{match:/\/\*[^]*?\*\//u,lineBreaks:!0},string:[{match:/"(?:[^"\\]|\\[^])*"/u,value:e=>e.slice(1,-1).replace(/\\(.)/g,(e,t)=>{switch(t){case"n":return"\n";case"t":return"\t";case"r":return"\r";case"\\":return"\\";case'"':return'"';case"'":return"'";default:return t}})},{match:/'(?:[^'\\]|\\[^])*'/u,value:e=>e.slice(1,-1).replace(/\\(.)/g,(e,t)=>{switch(t){case"n":return"\n";case"t":return"\t";case"r":return"\r";case"\\":return"\\";case'"':return'"';case"'":return"'";default:return t}})}],templateLiteral:{match:/`(?:[^`\\]|\\[^])*`/u,value:e=>e.slice(1,-1)},regex:{match:/\/(?:\\[^]|[^\s\/])(?:[^\/\\\r\n]|\\[^])*\/[gimsuy]*/u,value:e=>{const t=e.lastIndexOf("/");return{pattern:e.slice(1,t),flags:e.slice(t+1)}}},number:{match:/(?:0|[1-9]\d*)(?:\.\d+)?(?:[eE][+-]?\d+)?/u,value:e=>parseFloat(e)},identifier:{match:/[\p{L}\p{Nl}$_][\p{L}\p{Mn}\p{Mc}\p{Nd}\p{Pc}$_]*/u,type:m.keywords({let:"let",const:"const",var:"var",if:"if",else:"else",for:"for",while:"while",do:"do",break:"break",continue:"continue",return:"return",function:"function",class:"class",extends:"extends",constructor:"constructor",async:"async",await:"await",import:"import",export:"export",from:"from",as:"as",try:"try",catch:"catch",finally:"finally",throw:"throw",true:"true",false:"false",null:"null",undefined:"undefined",this:"this",super:"super",new:"new",typeof:"typeof",instanceof:"instanceof",in:"in",of:"of"})},"+=":/\+=/u,"-=":/-=/u,"*=":/\*=/u,"/=":/\/=/u,"===":/===/u,"!==":/!==/u,"==":/==/u,"!=":/!=/u,"<=":/<=/u,">=":/>=/u,"<<":/<</u,">>":/>>/u,">>>":/>>>/u,"&&":/&&/u,"||":/\|\|/u,"??":/\?\?/u,"?.":/\?\./u,"...":/\.\.\./u,"++":/\+\+/u,"--":/--/u,"**":/\*\*/u,"|>":/\|>/u,"->":/->/u,"=>":/=>/u,"=":/=/u,"<":/</u,">":/>/u,"+":/\+/u,"-":/-/u,"*":/\*/u,"/":/\//u,"%":/%/u,"&":/&/u,"|":/\|/u,"^":/\^/u,"~":/~/u,"!":/!/u,"?":/\?/u,":":/:/u,"(":/\(/u,")":/\)/u,"[":/\[/u,"]":/\]/u,"{":/\{/u,"}":/\}/u,",":/,/u,".":/\./u,";":/;/u});var b;function d(e,t={}){return{type:e,...t}}function x(e,t,s){return d("BinaryExpression",{operator:t,left:e,right:s})}function v(e){return d("Identifier",{name:e})}function g(e,t){return d("Literal",{value:e,raw:t})}y.next=(b=y.next,()=>{let e;for(;(e=b.call(y))&&("WS"===e.type||"lineComment"===e.type||"blockComment"===e.type););return e});var E={Lexer:y,ParserRules:[{name:"Program",symbols:["StatementList"],postprocess:e=>d("Program",{body:e[0]})},{name:"StatementList",symbols:[],postprocess:()=>[]},{name:"StatementList",symbols:["Statement"],postprocess:e=>[e[0]]},{name:"StatementList",symbols:["StatementList",y.has("NL")?{type:"NL"}:NL,"Statement"],postprocess:e=>[...e[0],e[2]]},{name:"StatementList",symbols:["StatementList",y.has("NL")?{type:"NL"}:NL],postprocess:e=>e[0]},{name:"Statement",symbols:["Declaration"],postprocess:f},{name:"Statement",symbols:["LabeledStatement"],postprocess:f},{name:"Statement",symbols:["ControlStatement"],postprocess:f},{name:"Statement",symbols:["ExpressionStatement"],postprocess:f},{name:"Statement",symbols:["Block"],postprocess:f},{name:"Statement",symbols:["PipelineContinuation"],postprocess:f},{name:"Statement",symbols:["MemberContinuation"],postprocess:f},{name:"PipelineContinuation$subexpression$1",symbols:[{literal:"|>"}]},{name:"PipelineContinuation$subexpression$1",symbols:[{literal:"->"}]},{name:"PipelineContinuation$ebnf$1",symbols:[]},{name:"PipelineContinuation$ebnf$1",symbols:["PipelineContinuation$ebnf$1",y.has("NL")?{type:"NL"}:NL],postprocess:function(e){return e[0].concat([e[1]])}},{name:"PipelineContinuation",symbols:["PipelineContinuation$subexpression$1","PipelineContinuation$ebnf$1","AssignmentExpression"],postprocess:e=>d("PipelineContinuation",{operator:e[0][0].value,right:e[2]})},{name:"MemberContinuation$ebnf$1",symbols:["Arguments"],postprocess:f},{name:"MemberContinuation$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"MemberContinuation",symbols:[{literal:"."},"PropertyName","MemberContinuation$ebnf$1"],postprocess:e=>d("MemberContinuation",{property:v(e[1].value),arguments:e[2]||null})},{name:"MemberContinuation$ebnf$2",symbols:["Arguments"],postprocess:f},{name:"MemberContinuation$ebnf$2",symbols:[],postprocess:function(e){return null}},{name:"MemberContinuation",symbols:[{literal:"?."},"PropertyName","MemberContinuation$ebnf$2"],postprocess:e=>d("MemberContinuation",{property:v(e[1].value),arguments:e[2]||null,optional:!0})},{name:"LabeledStatement",symbols:[y.has("identifier")?{type:"identifier"}:identifier,{literal:":"},"LoopStatement"],postprocess:e=>d("LabeledStatement",{label:v(e[0].value),body:e[2]})},{name:"LoopStatement",symbols:["WhileStatement"],postprocess:f},{name:"LoopStatement",symbols:["DoWhileStatement"],postprocess:f},{name:"LoopStatement",symbols:["ForStatement"],postprocess:f},{name:"Declaration",symbols:["VariableDeclaration"],postprocess:f},{name:"Declaration",symbols:["FunctionDeclaration"],postprocess:f},{name:"Declaration",symbols:["ClassDeclaration"],postprocess:f},{name:"Declaration",symbols:["ImportDeclaration"],postprocess:f},{name:"Declaration",symbols:["ExportDeclaration"],postprocess:f},{name:"VariableDeclaration$subexpression$1",symbols:[{literal:"let"}]},{name:"VariableDeclaration$subexpression$1",symbols:[{literal:"const"}]},{name:"VariableDeclaration$subexpression$1",symbols:[{literal:"var"}]},{name:"VariableDeclaration",symbols:["VariableDeclaration$subexpression$1","VariableDeclaratorList"],postprocess:e=>d("VariableDeclaration",{kind:e[0][0].value,declarations:e[1]})},{name:"VariableDeclaratorList",symbols:["VariableDeclarator"],postprocess:e=>[e[0]]},{name:"VariableDeclaratorList",symbols:["VariableDeclaratorList",{literal:","},"VariableDeclarator"],postprocess:e=>[...e[0],e[2]]},{name:"VariableDeclarator$ebnf$1$subexpression$1",symbols:[{literal:"="},"AssignmentExpression"]},{name:"VariableDeclarator$ebnf$1",symbols:["VariableDeclarator$ebnf$1$subexpression$1"],postprocess:f},{name:"VariableDeclarator$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"VariableDeclarator",symbols:["BindingPattern","VariableDeclarator$ebnf$1"],postprocess:e=>d("VariableDeclarator",{id:e[0],init:e[1]?e[1][1]:null})},{name:"BindingPattern",symbols:[y.has("identifier")?{type:"identifier"}:identifier],postprocess:e=>v(e[0].value)},{name:"BindingPattern",symbols:["ArrayPattern"],postprocess:f},{name:"BindingPattern",symbols:["ObjectPattern"],postprocess:f},{name:"ArrayPattern",symbols:[{literal:"["},"ArrayPatternElementList",{literal:"]"}],postprocess:e=>d("ArrayPattern",{elements:e[1]})},{name:"ArrayPatternElementList",symbols:[],postprocess:()=>[]},{name:"ArrayPatternElementList",symbols:["ArrayPatternElement"],postprocess:e=>[e[0]]},{name:"ArrayPatternElementList",symbols:["ArrayPatternElementList",{literal:","},"ArrayPatternElement"],postprocess:e=>[...e[0],e[2]]},{name:"ArrayPatternElementList",symbols:["ArrayPatternElementList",{literal:","}],postprocess:e=>[...e[0],null]},{name:"ArrayPatternElement",symbols:["BindingPattern"],postprocess:f},{name:"ArrayPatternElement",symbols:[{literal:"..."},"BindingPattern"],postprocess:e=>d("RestElement",{argument:e[1]})},{name:"ObjectPattern",symbols:[{literal:"{"},"ObjectPatternPropertyList",{literal:"}"}],postprocess:e=>d("ObjectPattern",{properties:e[1]})},{name:"ObjectPatternPropertyList",symbols:[],postprocess:()=>[]},{name:"ObjectPatternPropertyList",symbols:["ObjectPatternProperty"],postprocess:e=>[e[0]]},{name:"ObjectPatternPropertyList",symbols:["ObjectPatternPropertyList",{literal:","},"ObjectPatternProperty"],postprocess:e=>[...e[0],e[2]]},{name:"ObjectPatternProperty",symbols:[y.has("identifier")?{type:"identifier"}:identifier],postprocess:e=>d("Property",{key:v(e[0].value),value:v(e[0].value),shorthand:!0})},{name:"ObjectPatternProperty",symbols:["PropertyKey",{literal:":"},"BindingPattern"],postprocess:e=>d("Property",{key:e[0],value:e[2],shorthand:!1})},{name:"FunctionDeclaration$ebnf$1",symbols:[{literal:"async"}],postprocess:f},{name:"FunctionDeclaration$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"FunctionDeclaration",symbols:["FunctionDeclaration$ebnf$1",{literal:"function"},y.has("identifier")?{type:"identifier"}:identifier,{literal:"("},"ParameterList",{literal:")"},"Block"],postprocess:e=>d("FunctionDeclaration",{async:!!e[0],id:v(e[2].value),params:e[4],body:e[6]})},{name:"ParameterList",symbols:[],postprocess:()=>[]},{name:"ParameterList",symbols:["Parameter"],postprocess:e=>[e[0]]},{name:"ParameterList",symbols:["ParameterList",{literal:","},"Parameter"],postprocess:e=>[...e[0],e[2]]},{name:"Parameter",symbols:["BindingPattern"],postprocess:f},{name:"Parameter",symbols:["BindingPattern",{literal:"="},"AssignmentExpression"],postprocess:e=>d("AssignmentPattern",{left:e[0],right:e[2]})},{name:"Parameter",symbols:[{literal:"..."},"BindingPattern"],postprocess:e=>d("RestElement",{argument:e[1]})},{name:"ClassDeclaration$ebnf$1$subexpression$1",symbols:[{literal:"extends"},y.has("identifier")?{type:"identifier"}:identifier]},{name:"ClassDeclaration$ebnf$1",symbols:["ClassDeclaration$ebnf$1$subexpression$1"],postprocess:f},{name:"ClassDeclaration$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"ClassDeclaration",symbols:[{literal:"class"},y.has("identifier")?{type:"identifier"}:identifier,"ClassDeclaration$ebnf$1","ClassBody"],postprocess:e=>d("ClassDeclaration",{id:v(e[1].value),superClass:e[2]?v(e[2][1].value):null,body:e[3]})},{name:"ClassBody",symbols:[{literal:"{"},"ClassMemberListWithNewlines",{literal:"}"}],postprocess:e=>d("ClassBody",{body:e[1]})},{name:"ClassMemberListWithNewlines$ebnf$1",symbols:[]},{name:"ClassMemberListWithNewlines$ebnf$1",symbols:["ClassMemberListWithNewlines$ebnf$1",y.has("NL")?{type:"NL"}:NL],postprocess:function(e){return e[0].concat([e[1]])}},{name:"ClassMemberListWithNewlines$ebnf$2",symbols:["ClassMemberNonEmpty"],postprocess:f},{name:"ClassMemberListWithNewlines$ebnf$2",symbols:[],postprocess:function(e){return null}},{name:"ClassMemberListWithNewlines$ebnf$3",symbols:[]},{name:"ClassMemberListWithNewlines$ebnf$3",symbols:["ClassMemberListWithNewlines$ebnf$3",y.has("NL")?{type:"NL"}:NL],postprocess:function(e){return e[0].concat([e[1]])}},{name:"ClassMemberListWithNewlines",symbols:["ClassMemberListWithNewlines$ebnf$1","ClassMemberListWithNewlines$ebnf$2","ClassMemberListWithNewlines$ebnf$3"],postprocess:e=>e[1]?e[1]:[]},{name:"ClassMemberNonEmpty",symbols:["ClassMember"],postprocess:e=>[e[0]]},{name:"ClassMemberNonEmpty$ebnf$1",symbols:[y.has("NL")?{type:"NL"}:NL]},{name:"ClassMemberNonEmpty$ebnf$1",symbols:["ClassMemberNonEmpty$ebnf$1",y.has("NL")?{type:"NL"}:NL],postprocess:function(e){return e[0].concat([e[1]])}},{name:"ClassMemberNonEmpty",symbols:["ClassMember","ClassMemberNonEmpty$ebnf$1","ClassMemberNonEmpty"],postprocess:e=>[e[0],...e[2]]},{name:"ClassMember",symbols:["MethodDefinition"],postprocess:f},{name:"ClassMember",symbols:["PropertyDefinition"],postprocess:f},{name:"MethodDefinition$ebnf$1",symbols:[{literal:"async"}],postprocess:f},{name:"MethodDefinition$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"MethodDefinition",symbols:["MethodDefinition$ebnf$1","PropertyKey",{literal:"("},"ParameterList",{literal:")"},"Block"],postprocess:e=>d("MethodDefinition",{async:!!e[0],kind:"method",key:e[1],params:e[3],body:e[5]})},{name:"MethodDefinition",symbols:[{literal:"constructor"},{literal:"("},"ParameterList",{literal:")"},"Block"],postprocess:e=>d("MethodDefinition",{kind:"constructor",key:v("constructor"),params:e[2],body:e[4]})},{name:"PropertyDefinition",symbols:["PropertyKey",{literal:"="},"AssignmentExpression"],postprocess:e=>d("PropertyDefinition",{key:e[0],value:e[2]})},{name:"ImportDeclaration",symbols:[{literal:"import"},{literal:"{"},"ImportsList",{literal:"}"},{literal:"from"},y.has("string")?{type:"string"}:string],postprocess:e=>d("ImportDeclaration",{specifiers:e[2],source:g(e[5].value,e[5].text)})},{name:"ImportsList",symbols:[],postprocess:()=>[]},{name:"ImportsList",symbols:["ImportSpecifier"],postprocess:e=>[e[0]]},{name:"ImportsList",symbols:["ImportsList",{literal:","},"ImportSpecifier"],postprocess:e=>[...e[0],e[2]]},{name:"ImportSpecifier$ebnf$1$subexpression$1",symbols:[{literal:"as"},y.has("identifier")?{type:"identifier"}:identifier]},{name:"ImportSpecifier$ebnf$1",symbols:["ImportSpecifier$ebnf$1$subexpression$1"],postprocess:f},{name:"ImportSpecifier$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"ImportSpecifier",symbols:[y.has("identifier")?{type:"identifier"}:identifier,"ImportSpecifier$ebnf$1"],postprocess:e=>d("ImportSpecifier",{imported:v(e[0].value),local:v(e[1]?e[1][1].value:e[0].value)})},{name:"ExportDeclaration",symbols:[{literal:"export"},"Declaration"],postprocess:e=>d("ExportNamedDeclaration",{declaration:e[1]})},{name:"ExportDeclaration",symbols:[{literal:"export"},{literal:"{"},"ExportsList",{literal:"}"}],postprocess:e=>d("ExportNamedDeclaration",{specifiers:e[2],source:null})},{name:"ExportsList",symbols:[],postprocess:()=>[]},{name:"ExportsList",symbols:["ExportSpecifier"],postprocess:e=>[e[0]]},{name:"ExportsList",symbols:["ExportsList",{literal:","},"ExportSpecifier"],postprocess:e=>[...e[0],e[2]]},{name:"ExportSpecifier$ebnf$1$subexpression$1",symbols:[{literal:"as"},y.has("identifier")?{type:"identifier"}:identifier]},{name:"ExportSpecifier$ebnf$1",symbols:["ExportSpecifier$ebnf$1$subexpression$1"],postprocess:f},{name:"ExportSpecifier$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"ExportSpecifier",symbols:[y.has("identifier")?{type:"identifier"}:identifier,"ExportSpecifier$ebnf$1"],postprocess:e=>d("ExportSpecifier",{local:v(e[0].value),exported:v(e[1]?e[1][1].value:e[0].value)})},{name:"ControlStatement",symbols:["IfStatement"],postprocess:f},{name:"ControlStatement",symbols:["WhileStatement"],postprocess:f},{name:"ControlStatement",symbols:["DoWhileStatement"],postprocess:f},{name:"ControlStatement",symbols:["ForStatement"],postprocess:f},{name:"ControlStatement",symbols:["TryStatement"],postprocess:f},{name:"ControlStatement",symbols:["ThrowStatement"],postprocess:f},{name:"ControlStatement",symbols:["ReturnStatement"],postprocess:f},{name:"ControlStatement",symbols:["BreakStatement"],postprocess:f},{name:"ControlStatement",symbols:["ContinueStatement"],postprocess:f},{name:"IfStatement$ebnf$1$subexpression$1",symbols:[{literal:"else"},"Statement"]},{name:"IfStatement$ebnf$1",symbols:["IfStatement$ebnf$1$subexpression$1"],postprocess:f},{name:"IfStatement$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"IfStatement",symbols:[{literal:"if"},{literal:"("},"Expression",{literal:")"},"Statement","IfStatement$ebnf$1"],postprocess:e=>d("IfStatement",{test:e[2],consequent:e[4],alternate:e[5]?e[5][1]:null})},{name:"WhileStatement",symbols:[{literal:"while"},{literal:"("},"Expression",{literal:")"},"Statement"],postprocess:e=>d("WhileStatement",{test:e[2],body:e[4]})},{name:"DoWhileStatement",symbols:[{literal:"do"},"Statement",{literal:"while"},{literal:"("},"Expression",{literal:")"}],postprocess:e=>d("DoWhileStatement",{body:e[1],test:e[4]})},{name:"ForStatement$subexpression$1",symbols:["VariableDeclaration"]},{name:"ForStatement$subexpression$1",symbols:["Expression"]},{name:"ForStatement$subexpression$1",symbols:[]},{name:"ForStatement$subexpression$2",symbols:["Expression"]},{name:"ForStatement$subexpression$2",symbols:[]},{name:"ForStatement$subexpression$3",symbols:["Expression"]},{name:"ForStatement$subexpression$3",symbols:[]},{name:"ForStatement",symbols:[{literal:"for"},{literal:"("},"ForStatement$subexpression$1",{literal:";"},"ForStatement$subexpression$2",{literal:";"},"ForStatement$subexpression$3",{literal:")"},"Statement"],postprocess:e=>d("ForStatement",{init:e[2]?e[2][0]:null,test:e[4]?e[4][0]:null,update:e[6]?e[6][0]:null,body:e[8]})},{name:"ForStatement$subexpression$4",symbols:[{literal:"let"}]},{name:"ForStatement$subexpression$4",symbols:[{literal:"const"}]},{name:"ForStatement$subexpression$4",symbols:[{literal:"var"}]},{name:"ForStatement",symbols:[{literal:"for"},{literal:"("},"ForStatement$subexpression$4","BindingPattern",{literal:"of"},"Expression",{literal:")"},"Statement"],postprocess:e=>d("ForOfStatement",{left:d("VariableDeclaration",{kind:e[2][0].value,declarations:[d("VariableDeclarator",{id:e[3],init:null})]}),right:e[5],body:e[7]})},{name:"TryStatement",symbols:[{literal:"try"},"Block","CatchFinally"],postprocess:e=>d("TryStatement",{block:e[1],handler:e[2].handler,finalizer:e[2].finalizer})},{name:"CatchFinally$ebnf$1$subexpression$1",symbols:[{literal:"("},"BindingPattern",{literal:")"}]},{name:"CatchFinally$ebnf$1",symbols:["CatchFinally$ebnf$1$subexpression$1"],postprocess:f},{name:"CatchFinally$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"CatchFinally$ebnf$2$subexpression$1",symbols:[{literal:"finally"},"Block"]},{name:"CatchFinally$ebnf$2",symbols:["CatchFinally$ebnf$2$subexpression$1"],postprocess:f},{name:"CatchFinally$ebnf$2",symbols:[],postprocess:function(e){return null}},{name:"CatchFinally",symbols:[{literal:"catch"},"CatchFinally$ebnf$1","Block","CatchFinally$ebnf$2"],postprocess:e=>({handler:d("CatchClause",{param:e[1]?e[1][1]:null,body:e[2]}),finalizer:e[3]?e[3][1]:null})},{name:"CatchFinally",symbols:[{literal:"finally"},"Block"],postprocess:e=>({handler:null,finalizer:e[1]})},{name:"ThrowStatement",symbols:[{literal:"throw"},"Expression"],postprocess:e=>d("ThrowStatement",{argument:e[1]})},{name:"ReturnStatement$ebnf$1",symbols:["Expression"],postprocess:f},{name:"ReturnStatement$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"ReturnStatement",symbols:[{literal:"return"},"ReturnStatement$ebnf$1"],postprocess:e=>d("ReturnStatement",{argument:e[1]})},{name:"BreakStatement$ebnf$1",symbols:[y.has("identifier")?{type:"identifier"}:identifier],postprocess:f},{name:"BreakStatement$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"BreakStatement",symbols:[{literal:"break"},"BreakStatement$ebnf$1"],postprocess:e=>d("BreakStatement",{label:e[1]?v(e[1].value):null})},{name:"ContinueStatement$ebnf$1",symbols:[y.has("identifier")?{type:"identifier"}:identifier],postprocess:f},{name:"ContinueStatement$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"ContinueStatement",symbols:[{literal:"continue"},"ContinueStatement$ebnf$1"],postprocess:e=>d("ContinueStatement",{label:e[1]?v(e[1].value):null})},{name:"ExpressionStatement",symbols:["Expression"],postprocess:e=>d("ExpressionStatement",{expression:e[0]})},{name:"Expression",symbols:["AssignmentExpression"],postprocess:f},{name:"AssignmentExpression",symbols:["PipelineExpression"],postprocess:f},{name:"AssignmentExpression",symbols:["ArrowFunction"],postprocess:f},{name:"AssignmentExpression",symbols:["LeftHandSideExpression","AssignmentOperator","AssignmentExpression"],postprocess:e=>d("AssignmentExpression",{operator:e[1],left:e[0],right:e[2]})},{name:"PipelineExpression",symbols:["ConditionalExpression"],postprocess:f},{name:"PipelineExpression$subexpression$1",symbols:[{literal:"|>"}]},{name:"PipelineExpression$subexpression$1",symbols:[{literal:"->"}]},{name:"PipelineExpression",symbols:["PipelineExpression","PipelineExpression$subexpression$1","ConditionalExpression"],postprocess:e=>{return t=e[0],s=e[1][0].value,r=e[2],d("PipelineExpression",{operator:s,left:t,right:r});var t,s,r}},{name:"AssignmentOperator",symbols:[{literal:"="}],postprocess:e=>e[0].value},{name:"AssignmentOperator",symbols:[{literal:"+="}],postprocess:e=>e[0].value},{name:"AssignmentOperator",symbols:[{literal:"-="}],postprocess:e=>e[0].value},{name:"AssignmentOperator",symbols:[{literal:"*="}],postprocess:e=>e[0].value},{name:"AssignmentOperator",symbols:[{literal:"/="}],postprocess:e=>e[0].value},{name:"ArrowFunction",symbols:["ArrowParameters",{literal:"=>"},"ArrowBody"],postprocess:e=>d("ArrowFunctionExpression",{async:!1,params:e[0],body:e[2]})},{name:"ArrowFunction",symbols:[{literal:"async"},"ArrowParameters",{literal:"=>"},"ArrowBody"],postprocess:e=>d("ArrowFunctionExpression",{async:!0,params:e[1],body:e[3]})},{name:"ArrowParameters",symbols:[y.has("identifier")?{type:"identifier"}:identifier],postprocess:e=>[v(e[0].value)]},{name:"ArrowParameters",symbols:[{literal:"("},"ParameterList",{literal:")"}],postprocess:e=>e[1]},{name:"ArrowBody",symbols:["Block"],postprocess:f},{name:"ArrowBody",symbols:["AssignmentExpression"],postprocess:f},{name:"ConditionalExpression",symbols:["LogicalOrExpression"],postprocess:f},{name:"ConditionalExpression",symbols:["LogicalOrExpression",{literal:"?"},"AssignmentExpression",{literal:":"},"ConditionalExpression"],postprocess:e=>d("ConditionalExpression",{test:e[0],consequent:e[2],alternate:e[4]})},{name:"LogicalOrExpression",symbols:["LogicalAndExpression"],postprocess:f},{name:"LogicalOrExpression$subexpression$1",symbols:[{literal:"||"}]},{name:"LogicalOrExpression$subexpression$1",symbols:[{literal:"??"}]},{name:"LogicalOrExpression",symbols:["LogicalOrExpression","LogicalOrExpression$subexpression$1","LogicalAndExpression"],postprocess:e=>x(e[0],e[1][0].value,e[2])},{name:"LogicalAndExpression",symbols:["EqualityExpression"],postprocess:f},{name:"LogicalAndExpression",symbols:["LogicalAndExpression",{literal:"&&"},"EqualityExpression"],postprocess:e=>x(e[0],e[1].value,e[2])},{name:"EqualityExpression",symbols:["RelationalExpression"],postprocess:f},{name:"EqualityExpression$subexpression$1",symbols:[{literal:"=="}]},{name:"EqualityExpression$subexpression$1",symbols:[{literal:"!="}]},{name:"EqualityExpression$subexpression$1",symbols:[{literal:"==="}]},{name:"EqualityExpression$subexpression$1",symbols:[{literal:"!=="}]},{name:"EqualityExpression",symbols:["EqualityExpression","EqualityExpression$subexpression$1","RelationalExpression"],postprocess:e=>x(e[0],e[1][0].value,e[2])},{name:"RelationalExpression",symbols:["AdditiveExpression"],postprocess:f},{name:"RelationalExpression$subexpression$1",symbols:[{literal:"<"}]},{name:"RelationalExpression$subexpression$1",symbols:[{literal:">"}]},{name:"RelationalExpression$subexpression$1",symbols:[{literal:"<="}]},{name:"RelationalExpression$subexpression$1",symbols:[{literal:">="}]},{name:"RelationalExpression",symbols:["RelationalExpression","RelationalExpression$subexpression$1","AdditiveExpression"],postprocess:e=>x(e[0],e[1][0].value,e[2])},{name:"RelationalExpression$subexpression$2",symbols:[{literal:"instanceof"}]},{name:"RelationalExpression$subexpression$2",symbols:[{literal:"in"}]},{name:"RelationalExpression",symbols:["RelationalExpression","RelationalExpression$subexpression$2","AdditiveExpression"],postprocess:e=>x(e[0],e[1][0].value,e[2])},{name:"AdditiveExpression",symbols:["MultiplicativeExpression"],postprocess:f},{name:"AdditiveExpression$subexpression$1",symbols:[{literal:"+"}]},{name:"AdditiveExpression$subexpression$1",symbols:[{literal:"-"}]},{name:"AdditiveExpression",symbols:["AdditiveExpression","AdditiveExpression$subexpression$1","MultiplicativeExpression"],postprocess:e=>x(e[0],e[1][0].value,e[2])},{name:"MultiplicativeExpression",symbols:["ExponentiationExpression"],postprocess:f},{name:"MultiplicativeExpression$subexpression$1",symbols:[{literal:"*"}]},{name:"MultiplicativeExpression$subexpression$1",symbols:[{literal:"/"}]},{name:"MultiplicativeExpression$subexpression$1",symbols:[{literal:"%"}]},{name:"MultiplicativeExpression",symbols:["MultiplicativeExpression","MultiplicativeExpression$subexpression$1","ExponentiationExpression"],postprocess:e=>x(e[0],e[1][0].value,e[2])},{name:"ExponentiationExpression",symbols:["UnaryExpression"],postprocess:f},{name:"ExponentiationExpression",symbols:["UnaryExpression",{literal:"**"},"ExponentiationExpression"],postprocess:e=>x(e[0],e[1].value,e[2])},{name:"UnaryExpression",symbols:["PostfixExpression"],postprocess:f},{name:"UnaryExpression$subexpression$1",symbols:[{literal:"!"}]},{name:"UnaryExpression$subexpression$1",symbols:[{literal:"+"}]},{name:"UnaryExpression$subexpression$1",symbols:[{literal:"-"}]},{name:"UnaryExpression$subexpression$1",symbols:[{literal:"~"}]},{name:"UnaryExpression$subexpression$1",symbols:[{literal:"typeof"}]},{name:"UnaryExpression$subexpression$1",symbols:[{literal:"await"}]},{name:"UnaryExpression",symbols:["UnaryExpression$subexpression$1","UnaryExpression"],postprocess:e=>function(e,t,s=!0){return d("UnaryExpression",{operator:e,argument:t,prefix:s})}(e[0][0].value,e[1])},{name:"UnaryExpression$subexpression$2",symbols:[{literal:"++"}]},{name:"UnaryExpression$subexpression$2",symbols:[{literal:"--"}]},{name:"UnaryExpression",symbols:["UnaryExpression$subexpression$2","UnaryExpression"],postprocess:e=>d("UpdateExpression",{operator:e[0][0].value,argument:e[1],prefix:!0})},{name:"PostfixExpression",symbols:["LeftHandSideExpression"],postprocess:f},{name:"PostfixExpression$subexpression$1",symbols:[{literal:"++"}]},{name:"PostfixExpression$subexpression$1",symbols:[{literal:"--"}]},{name:"PostfixExpression",symbols:["LeftHandSideExpression","PostfixExpression$subexpression$1"],postprocess:e=>d("UpdateExpression",{operator:e[1][0].value,argument:e[0],prefix:!1})},{name:"LeftHandSideExpression",symbols:["CallExpression"],postprocess:f},{name:"LeftHandSideExpression",symbols:["NewExpression"],postprocess:f},{name:"CallExpression",symbols:["MemberExpression","Arguments"],postprocess:e=>d("CallExpression",{callee:e[0],arguments:e[1]})},{name:"CallExpression",symbols:["CallExpression","Arguments"],postprocess:e=>d("CallExpression",{callee:e[0],arguments:e[1]})},{name:"CallExpression",symbols:["CallExpression",{literal:"["},"Expression",{literal:"]"}],postprocess:e=>d("MemberExpression",{object:e[0],property:e[2],computed:!0})},{name:"CallExpression$ebnf$1",symbols:[]},{name:"CallExpression$ebnf$1",symbols:["CallExpression$ebnf$1",y.has("NL")?{type:"NL"}:NL],postprocess:function(e){return e[0].concat([e[1]])}},{name:"CallExpression",symbols:["CallExpression","CallExpression$ebnf$1",{literal:"."},"PropertyName"],postprocess:e=>d("MemberExpression",{object:e[0],property:v(e[3].value),computed:!1})},{name:"CallExpression$ebnf$2",symbols:[]},{name:"CallExpression$ebnf$2",symbols:["CallExpression$ebnf$2",y.has("NL")?{type:"NL"}:NL],postprocess:function(e){return e[0].concat([e[1]])}},{name:"CallExpression",symbols:["CallExpression","CallExpression$ebnf$2",{literal:"?."},"OptionalMemberAccess"],postprocess:e=>d("MemberExpression",{object:e[0],property:e[3].property,computed:e[3].computed,optional:!0})},{name:"NewExpression$ebnf$1",symbols:["Arguments"],postprocess:f},{name:"NewExpression$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"NewExpression",symbols:[{literal:"new"},"MemberExpression","NewExpression$ebnf$1"],postprocess:e=>d("NewExpression",{callee:e[1],arguments:e[2]||[]})},{name:"NewExpression",symbols:["MemberExpression"],postprocess:f},{name:"MemberExpression",symbols:["PrimaryExpression"],postprocess:f},{name:"MemberExpression",symbols:["MemberExpression",{literal:"["},"Expression",{literal:"]"}],postprocess:e=>d("MemberExpression",{object:e[0],property:e[2],computed:!0})},{name:"MemberExpression$ebnf$1",symbols:[]},{name:"MemberExpression$ebnf$1",symbols:["MemberExpression$ebnf$1",y.has("NL")?{type:"NL"}:NL],postprocess:function(e){return e[0].concat([e[1]])}},{name:"MemberExpression",symbols:["MemberExpression","MemberExpression$ebnf$1",{literal:"."},"PropertyName"],postprocess:e=>d("MemberExpression",{object:e[0],property:v(e[3].value),computed:!1})},{name:"MemberExpression$ebnf$2",symbols:[]},{name:"MemberExpression$ebnf$2",symbols:["MemberExpression$ebnf$2",y.has("NL")?{type:"NL"}:NL],postprocess:function(e){return e[0].concat([e[1]])}},{name:"MemberExpression",symbols:["MemberExpression","MemberExpression$ebnf$2",{literal:"?."},"OptionalMemberAccess"],postprocess:e=>d("MemberExpression",{object:e[0],property:e[3].property,computed:e[3].computed,optional:!0})},{name:"OptionalMemberAccess",symbols:["PropertyName"],postprocess:e=>({property:v(e[0].value),computed:!1})},{name:"OptionalMemberAccess",symbols:[{literal:"["},"Expression",{literal:"]"}],postprocess:e=>({property:e[1],computed:!0})},{name:"PropertyName",symbols:[y.has("identifier")?{type:"identifier"}:identifier],postprocess:e=>e[0]},{name:"PropertyName",symbols:["ReservedKeyword"],postprocess:e=>e[0]},{name:"ReservedKeyword",symbols:[{literal:"let"}],postprocess:e=>({value:"let"})},{name:"ReservedKeyword",symbols:[{literal:"const"}],postprocess:e=>({value:"const"})},{name:"ReservedKeyword",symbols:[{literal:"var"}],postprocess:e=>({value:"var"})},{name:"ReservedKeyword",symbols:[{literal:"if"}],postprocess:e=>({value:"if"})},{name:"ReservedKeyword",symbols:[{literal:"else"}],postprocess:e=>({value:"else"})},{name:"ReservedKeyword",symbols:[{literal:"for"}],postprocess:e=>({value:"for"})},{name:"ReservedKeyword",symbols:[{literal:"while"}],postprocess:e=>({value:"while"})},{name:"ReservedKeyword",symbols:[{literal:"do"}],postprocess:e=>({value:"do"})},{name:"ReservedKeyword",symbols:[{literal:"break"}],postprocess:e=>({value:"break"})},{name:"ReservedKeyword",symbols:[{literal:"continue"}],postprocess:e=>({value:"continue"})},{name:"ReservedKeyword",symbols:[{literal:"return"}],postprocess:e=>({value:"return"})},{name:"ReservedKeyword",symbols:[{literal:"function"}],postprocess:e=>({value:"function"})},{name:"ReservedKeyword",symbols:[{literal:"class"}],postprocess:e=>({value:"class"})},{name:"ReservedKeyword",symbols:[{literal:"extends"}],postprocess:e=>({value:"extends"})},{name:"ReservedKeyword",symbols:[{literal:"constructor"}],postprocess:e=>({value:"constructor"})},{name:"ReservedKeyword",symbols:[{literal:"async"}],postprocess:e=>({value:"async"})},{name:"ReservedKeyword",symbols:[{literal:"await"}],postprocess:e=>({value:"await"})},{name:"ReservedKeyword",symbols:[{literal:"import"}],postprocess:e=>({value:"import"})},{name:"ReservedKeyword",symbols:[{literal:"export"}],postprocess:e=>({value:"export"})},{name:"ReservedKeyword",symbols:[{literal:"from"}],postprocess:e=>({value:"from"})},{name:"ReservedKeyword",symbols:[{literal:"as"}],postprocess:e=>({value:"as"})},{name:"ReservedKeyword",symbols:[{literal:"try"}],postprocess:e=>({value:"try"})},{name:"ReservedKeyword",symbols:[{literal:"catch"}],postprocess:e=>({value:"catch"})},{name:"ReservedKeyword",symbols:[{literal:"finally"}],postprocess:e=>({value:"finally"})},{name:"ReservedKeyword",symbols:[{literal:"throw"}],postprocess:e=>({value:"throw"})},{name:"ReservedKeyword",symbols:[{literal:"true"}],postprocess:e=>({value:"true"})},{name:"ReservedKeyword",symbols:[{literal:"false"}],postprocess:e=>({value:"false"})},{name:"ReservedKeyword",symbols:[{literal:"null"}],postprocess:e=>({value:"null"})},{name:"ReservedKeyword",symbols:[{literal:"undefined"}],postprocess:e=>({value:"undefined"})},{name:"ReservedKeyword",symbols:[{literal:"this"}],postprocess:e=>({value:"this"})},{name:"ReservedKeyword",symbols:[{literal:"super"}],postprocess:e=>({value:"super"})},{name:"ReservedKeyword",symbols:[{literal:"new"}],postprocess:e=>({value:"new"})},{name:"ReservedKeyword",symbols:[{literal:"typeof"}],postprocess:e=>({value:"typeof"})},{name:"ReservedKeyword",symbols:[{literal:"instanceof"}],postprocess:e=>({value:"instanceof"})},{name:"ReservedKeyword",symbols:[{literal:"in"}],postprocess:e=>({value:"in"})},{name:"ReservedKeyword",symbols:[{literal:"of"}],postprocess:e=>({value:"of"})},{name:"Arguments",symbols:[{literal:"("},"ArgumentList",{literal:")"}],postprocess:e=>e[1]},{name:"ArgumentList",symbols:[],postprocess:()=>[]},{name:"ArgumentList",symbols:["AssignmentExpression"],postprocess:e=>[e[0]]},{name:"ArgumentList",symbols:["ArgumentList",{literal:","},"AssignmentExpression"],postprocess:e=>[...e[0],e[2]]},{name:"ArgumentList",symbols:[{literal:"..."},"AssignmentExpression"],postprocess:e=>[d("SpreadElement",{argument:e[1]})]},{name:"ArgumentList",symbols:["ArgumentList",{literal:","},{literal:"..."},"AssignmentExpression"],postprocess:e=>[...e[0],d("SpreadElement",{argument:e[3]})]},{name:"PrimaryExpression",symbols:[{literal:"this"}],postprocess:()=>d("ThisExpression")},{name:"PrimaryExpression",symbols:[{literal:"super"}],postprocess:()=>d("Super")},{name:"PrimaryExpression",symbols:[y.has("identifier")?{type:"identifier"}:identifier],postprocess:e=>v(e[0].value)},{name:"PrimaryExpression",symbols:["Literal"],postprocess:f},{name:"PrimaryExpression",symbols:["ArrayLiteral"],postprocess:f},{name:"PrimaryExpression",symbols:["ObjectLiteral"],postprocess:f},{name:"PrimaryExpression",symbols:["FunctionExpression"],postprocess:f},{name:"PrimaryExpression",symbols:["TemplateLiteral"],postprocess:f},{name:"PrimaryExpression",symbols:[{literal:"("},"Expression",{literal:")"}],postprocess:e=>e[1]},{name:"FunctionExpression",symbols:[{literal:"function"},{literal:"("},"ParameterList",{literal:")"},"Block"],postprocess:e=>d("FunctionExpression",{async:!1,id:null,params:e[2],body:e[4]})},{name:"FunctionExpression",symbols:[{literal:"async"},{literal:"function"},{literal:"("},"ParameterList",{literal:")"},"Block"],postprocess:e=>d("FunctionExpression",{async:!0,id:null,params:e[3],body:e[5]})},{name:"Literal",symbols:[y.has("number")?{type:"number"}:number],postprocess:e=>g(e[0].value,e[0].text)},{name:"Literal",symbols:[y.has("string")?{type:"string"}:string],postprocess:e=>g(e[0].value,e[0].text)},{name:"Literal",symbols:[y.has("regex")?{type:"regex"}:regex],postprocess:e=>{return t=e[0].value.pattern,s=e[0].value.flags,d("RegexLiteral",{pattern:t,flags:s});var t,s}},{name:"Literal",symbols:[{literal:"true"}],postprocess:()=>g(!0,"true")},{name:"Literal",symbols:[{literal:"false"}],postprocess:()=>g(!1,"false")},{name:"Literal",symbols:[{literal:"null"}],postprocess:()=>g(null,"null")},{name:"Literal",symbols:[{literal:"undefined"}],postprocess:()=>g(void 0,"undefined")},{name:"TemplateLiteral",symbols:[y.has("templateLiteral")?{type:"templateLiteral"}:templateLiteral],postprocess:e=>d("TemplateLiteral",{quasis:[d("TemplateElement",{value:{cooked:e[0].value,raw:e[0].value}})],expressions:[]})},{name:"ArrayLiteral$ebnf$1",symbols:[]},{name:"ArrayLiteral$ebnf$1",symbols:["ArrayLiteral$ebnf$1",y.has("NL")?{type:"NL"}:NL],postprocess:function(e){return e[0].concat([e[1]])}},{name:"ArrayLiteral$ebnf$2",symbols:[]},{name:"ArrayLiteral$ebnf$2",symbols:["ArrayLiteral$ebnf$2",y.has("NL")?{type:"NL"}:NL],postprocess:function(e){return e[0].concat([e[1]])}},{name:"ArrayLiteral",symbols:[{literal:"["},"ArrayLiteral$ebnf$1","ElementList","ArrayLiteral$ebnf$2",{literal:"]"}],postprocess:e=>d("ArrayExpression",{elements:e[2]})},{name:"ElementList",symbols:[],postprocess:()=>[]},{name:"ElementList",symbols:["Element"],postprocess:e=>[e[0]]},{name:"ElementList$ebnf$1",symbols:[]},{name:"ElementList$ebnf$1",symbols:["ElementList$ebnf$1",y.has("NL")?{type:"NL"}:NL],postprocess:function(e){return e[0].concat([e[1]])}},{name:"ElementList$ebnf$2",symbols:[]},{name:"ElementList$ebnf$2",symbols:["ElementList$ebnf$2",y.has("NL")?{type:"NL"}:NL],postprocess:function(e){return e[0].concat([e[1]])}},{name:"ElementList",symbols:["ElementList","ElementList$ebnf$1",{literal:","},"ElementList$ebnf$2","Element"],postprocess:e=>[...e[0],e[4]]},{name:"ElementList$ebnf$3",symbols:[]},{name:"ElementList$ebnf$3",symbols:["ElementList$ebnf$3",y.has("NL")?{type:"NL"}:NL],postprocess:function(e){return e[0].concat([e[1]])}},{name:"ElementList",symbols:["ElementList","ElementList$ebnf$3",{literal:","}],postprocess:e=>[...e[0],null]},{name:"Element",symbols:["AssignmentExpression"],postprocess:f},{name:"Element",symbols:[{literal:"..."},"AssignmentExpression"],postprocess:e=>d("SpreadElement",{argument:e[1]})},{name:"ObjectLiteral$ebnf$1",symbols:[]},{name:"ObjectLiteral$ebnf$1",symbols:["ObjectLiteral$ebnf$1",y.has("NL")?{type:"NL"}:NL],postprocess:function(e){return e[0].concat([e[1]])}},{name:"ObjectLiteral",symbols:[{literal:"{"},"ObjectLiteral$ebnf$1",{literal:"}"}],postprocess:()=>d("ObjectExpression",{properties:[]})},{name:"ObjectLiteral$ebnf$2",symbols:[]},{name:"ObjectLiteral$ebnf$2",symbols:["ObjectLiteral$ebnf$2",y.has("NL")?{type:"NL"}:NL],postprocess:function(e){return e[0].concat([e[1]])}},{name:"ObjectLiteral$ebnf$3",symbols:[]},{name:"ObjectLiteral$ebnf$3",symbols:["ObjectLiteral$ebnf$3",y.has("NL")?{type:"NL"}:NL],postprocess:function(e){return e[0].concat([e[1]])}},{name:"ObjectLiteral",symbols:[{literal:"{"},"ObjectLiteral$ebnf$2","PropertyDefinitionList","ObjectLiteral$ebnf$3",{literal:"}"}],postprocess:e=>d("ObjectExpression",{properties:e[2]})},{name:"PropertyDefinitionList",symbols:["PropertyDef"],postprocess:e=>[e[0]]},{name:"PropertyDefinitionList$ebnf$1",symbols:[]},{name:"PropertyDefinitionList$ebnf$1",symbols:["PropertyDefinitionList$ebnf$1",y.has("NL")?{type:"NL"}:NL],postprocess:function(e){return e[0].concat([e[1]])}},{name:"PropertyDefinitionList$ebnf$2",symbols:[]},{name:"PropertyDefinitionList$ebnf$2",symbols:["PropertyDefinitionList$ebnf$2",y.has("NL")?{type:"NL"}:NL],postprocess:function(e){return e[0].concat([e[1]])}},{name:"PropertyDefinitionList",symbols:["PropertyDefinitionList","PropertyDefinitionList$ebnf$1",{literal:","},"PropertyDefinitionList$ebnf$2","PropertyDef"],postprocess:e=>[...e[0],e[4]]},{name:"PropertyDefinitionList$ebnf$3",symbols:[]},{name:"PropertyDefinitionList$ebnf$3",symbols:["PropertyDefinitionList$ebnf$3",y.has("NL")?{type:"NL"}:NL],postprocess:function(e){return e[0].concat([e[1]])}},{name:"PropertyDefinitionList",symbols:["PropertyDefinitionList","PropertyDefinitionList$ebnf$3",{literal:","}],postprocess:e=>e[0]},{name:"PropertyDef$ebnf$1",symbols:[]},{name:"PropertyDef$ebnf$1",symbols:["PropertyDef$ebnf$1",y.has("NL")?{type:"NL"}:NL],postprocess:function(e){return e[0].concat([e[1]])}},{name:"PropertyDef$ebnf$2",symbols:[]},{name:"PropertyDef$ebnf$2",symbols:["PropertyDef$ebnf$2",y.has("NL")?{type:"NL"}:NL],postprocess:function(e){return e[0].concat([e[1]])}},{name:"PropertyDef",symbols:["ObjectPropertyKey","PropertyDef$ebnf$1",{literal:":"},"PropertyDef$ebnf$2","AssignmentExpression"],postprocess:e=>d("Property",{key:e[0],value:e[4],shorthand:!1})},{name:"PropertyDef",symbols:["PropertyName"],postprocess:e=>d("Property",{key:v(e[0].value),value:v(e[0].value),shorthand:!0})},{name:"PropertyDef",symbols:[{literal:"..."},"AssignmentExpression"],postprocess:e=>d("SpreadElement",{argument:e[1]})},{name:"ObjectPropertyKey",symbols:["PropertyName"],postprocess:e=>v(e[0].value)},{name:"ObjectPropertyKey",symbols:[y.has("string")?{type:"string"}:string],postprocess:e=>g(e[0].value,e[0].text)},{name:"ObjectPropertyKey",symbols:[y.has("number")?{type:"number"}:number],postprocess:e=>g(e[0].value,e[0].text)},{name:"ObjectPropertyKey",symbols:[{literal:"["},"Expression",{literal:"]"}],postprocess:e=>e[1]},{name:"PropertyKey",symbols:[y.has("identifier")?{type:"identifier"}:identifier],postprocess:e=>v(e[0].value)},{name:"PropertyKey",symbols:[y.has("string")?{type:"string"}:string],postprocess:e=>g(e[0].value,e[0].text)},{name:"PropertyKey",symbols:[y.has("number")?{type:"number"}:number],postprocess:e=>g(e[0].value,e[0].text)},{name:"PropertyKey",symbols:[{literal:"["},"Expression",{literal:"]"}],postprocess:e=>e[1]},{name:"Block",symbols:[{literal:"{"},"StatementList",{literal:"}"}],postprocess:e=>d("BlockStatement",{body:e[1]})}],ParserStart:"Program"},w=Object.freeze({__proto__:null,grammar:E,nearley:h});class ${constructor(e={}){this.lastPipelineValue=void 0,this.globalModuleCache=new Map,this.consoleLogs=[],this.moduleResolver=e.moduleResolver||new i,this.globalContext=e.globalContext||this.createContext(),this.currentContext=this.globalContext,this.bindBuiltins(),e.functions&&Object.entries(e.functions).forEach(([e,t])=>{this.bindFunction(e,t)})}createContext(e){return{variables:new Map,variableKinds:new Map,functions:new Map,classes:new Map,exports:new Map,parent:e,moduleCache:new Map}}bindBuiltins(){this.bindFunction("log",(...e)=>{this.consoleLogs.push({type:"log",args:e,timestamp:Date.now()}),console.log(...e)}),this.bindFunction("error",(...e)=>{this.consoleLogs.push({type:"error",args:e,timestamp:Date.now()}),console.error(...e)}),this.bindFunction("warn",(...e)=>{this.consoleLogs.push({type:"warn",args:e,timestamp:Date.now()}),console.warn(...e)}),this.bindFunction("Number",e=>Number(e)),this.bindFunction("String",e=>String(e)),this.bindFunction("Boolean",e=>Boolean(e)),this.bindFunction("isNaN",e=>isNaN(e)),this.bindFunction("isFinite",e=>isFinite(e)),this.bindFunction("isInteger",e=>Number.isInteger(e)),Object.entries(p).forEach(([e,t])=>{this.bindFunction(e,t)});const e=function(t){if(!(this instanceof e))return new Error(t);const s=new Error(t);return Object.setPrototypeOf(this,s),this.message=t||"",this.name="Error",this};this.bindFunction("Error",e),this.currentContext.variables.set("Error",e),this.currentContext.variables.set("Infinity",1/0),this.currentContext.variables.set("NaN",NaN),this.currentContext.variables.set("undefined",void 0),this.currentContext.variables.set("Date",Date),this.currentContext.variables.set("RegExp",RegExp),this.currentContext.variables.set("Promise",{all:e=>Promise.all(e),race:e=>Promise.race(e),resolve:e=>Promise.resolve(e),reject:e=>Promise.reject(e)}),this.bindFunction("filter",async(e,t)=>{const s=[];for(let r=0;r<e.length;r++){const n=t(e[r],r,e);(n instanceof Promise?await n:n)&&s.push(e[r])}return s}),this.bindFunction("map",async(e,t)=>{const s=[];for(let r=0;r<e.length;r++){const n=t(e[r],r,e);s.push(n instanceof Promise?await n:n)}return s}),this.bindFunction("reduce",async(e,t,s)=>{let r=void 0!==s?s:e[0];for(let n=void 0!==s?0:1;n<e.length;n++){const s=t(r,e[n],n,e);r=s instanceof Promise?await s:s}return r}),this.bindFunction("forEach",async(e,t)=>{for(let s=0;s<e.length;s++)await t(e[s],s,e)}),this.bindFunction("find",async(e,t)=>{for(let s=0;s<e.length;s++)if(await t(e[s],s,e))return e[s]}),this.bindFunction("some",async(e,t)=>{for(let s=0;s<e.length;s++)if(await t(e[s],s,e))return!0;return!1}),this.bindFunction("every",async(e,t)=>{for(let s=0;s<e.length;s++)if(!await t(e[s],s,e))return!1;return!0}),this.bindFunction("sort",async(e,t)=>{if(!t)return[...e].sort();const s=[...e];for(let e=0;e<s.length-1;e++)for(let r=e+1;r<s.length;r++){await t(s[e],s[r])>0&&([s[e],s[r]]=[s[r],s[e]])}return s}),this.bindFunction("slice",(e,t,s)=>e.slice(t,s)),this.bindFunction("concat",(...e)=>[].concat(...e)),this.bindFunction("join",(e,t)=>e.join(t)),this.bindFunction("includes",(e,t)=>e.includes(t)),this.bindFunction("indexOf",(e,t)=>Array.isArray(e)?e.indexOf(t):-1),this.bindFunction("push",(e,...t)=>(e.push(...t),e)),this.bindFunction("forEach",(e,t)=>{Array.isArray(e)&&e.forEach(t)}),this.bindFunction("pop",e=>e.pop()),this.bindFunction("shift",e=>e.shift()),this.bindFunction("unshift",(e,...t)=>(e.unshift(...t),e)),this.bindFunction("assign",Object.assign),this.bindFunction("freeze",Object.freeze),this.bindFunction("seal",Object.seal),this.bindFunction("toUpperCase",e=>e.toUpperCase()),this.bindFunction("toLowerCase",e=>e.toLowerCase()),this.bindFunction("trim",e=>e.trim()),this.bindFunction("split",(e,t)=>void 0!==t?e.split(t):e.split("")),this.bindFunction("replace",(e,t,s)=>e.replace(t,s)),this.bindFunction("substring",(e,t,s)=>e.substring(t,s)),this.bindFunction("charAt",(e,t)=>e.charAt(t)),this.bindFunction("charCodeAt",(e,t)=>e.charCodeAt(t)),this.bindFunction("startsWith",(e,t)=>e.startsWith(t)),this.bindFunction("endsWith",(e,t)=>e.endsWith(t)),this.bindFunction("repeat",(e,t)=>e.repeat(t)),this.bindFunction("padStart",(e,t,s)=>e.padStart(t,s)),this.bindFunction("padEnd",(e,t,s)=>e.padEnd(t,s)),this.bindFunction("pow",Math.pow),this.bindFunction("sqrt",Math.sqrt),this.bindFunction("random",Math.random),this.bindFunction("typeof",e=>typeof e),this.bindFunction("isArray",Array.isArray),this.bindFunction("isNaN",isNaN),this.bindFunction("isFinite",isFinite),this.bindFunction("parseInt",parseInt),this.bindFunction("parseFloat",parseFloat),this.bindFunction("parseJSON",JSON.parse),this.bindFunction("stringify",JSON.stringify),this.bindFunction("wait",e=>new Promise(t=>setTimeout(t,e))),this.bindFunction("Promise",Promise)}bindFunction(e,t){this.globalContext.functions.set(e,t)}setVariable(e,t){this.globalContext.variables.set(e,t)}async execute(e,t,s){this.consoleLogs=[];const n=new h.Parser(h.Grammar.fromCompiled(E));try{if(n.feed(e),0===n.results.length)throw new r("No parse found",{type:"ParseError"});n.results.length>1&&console.warn("Ambiguous grammar detected, using first parse");const o=n.results[0],a=t||this.globalContext,i=this.currentContext;this.currentContext=a;try{const e=await this.evaluateNode(o);return s?.withMetadata?{result:e,metadata:{logs:[...this.consoleLogs]}}:e}finally{this.currentContext=i}}catch(e){if(e&&"object"==typeof e&&"return"===e.type)return s?.withMetadata?{result:e.value,metadata:{logs:[...this.consoleLogs]}}:e.value;if(e instanceof r)throw e;const t=e instanceof Error?e.message:JSON.stringify(e);throw new r(`Parse error: ${t}`,{type:"ParseError"},e instanceof Error?e:void 0)}}createSyncFunction(e){const t=this.currentContext,s=this.currentContext.variables.get("this"),r=this,n=function(...o){const a=r.createContext(t);e.id&&e.id.name&&a.variables.set(e.id.name,n),"ArrowFunctionExpression"===e.type?a.variables.set("this",s):a.variables.set("this",this),e.params.forEach((e,t)=>{if("Identifier"===e.type)a.variables.set(e.name,o[t]);else if("RestElement"===e.type)a.variables.set(e.argument.name,o.slice(t));else if("AssignmentPattern"===e.type){const s=void 0!==o[t]?o[t]:r.evaluateNodeSync(e.right);"Identifier"===e.left.type&&a.variables.set(e.left.name,s)}});const i=r.currentContext;r.currentContext=a;try{const t=e.body;if("ArrowFunctionExpression"===e.type&&"BlockStatement"!==t.type)return r.evaluateNodeSync(t);let s;for(const e of t.body)try{s=r.evaluateNodeSync(e)}catch(e){if("return"===e.type)return e.value;throw e}return s}finally{r.currentContext=i}};return n}evaluateNodeSync(e){if(e)switch(e.type){case"Literal":return e.value;case"RegexLiteral":return new RegExp(e.pattern,e.flags);case"Identifier":return this.evaluateIdentifier(e);case"MemberExpression":const t=this.evaluateNodeSync(e.object);if(e.optional&&null==t)return;if(!e.optional&&null==t)throw new Error(`Cannot read properties of ${t} (reading '${e.computed?"computed property":e.property.name}')`);return t[e.computed?this.evaluateNodeSync(e.property):e.property.name];case"BinaryExpression":const s=this.evaluateNodeSync(e.left),r=this.evaluateNodeSync(e.right);switch(e.operator){case"+":return s+r;case"-":return s-r;case"*":return s*r;case"/":return s/r;case"%":return s%r;case"==":return s==r;case"!=":return s!=r;case"===":return s===r;case"!==":return s!==r;case"<":return s<r;case"<=":return s<=r;case">":return s>r;case">=":return s>=r;case"&&":return s&&r;case"||":return s||r;default:throw new Error(`Unknown operator: ${e.operator}`)}case"UnaryExpression":const n=this.evaluateNodeSync(e.argument);switch(e.operator){case"!":return!n;case"-":return-n;case"+":return+n;case"typeof":return typeof n;default:throw new Error(`Unknown unary operator: ${e.operator}`)}case"AssignmentExpression":const o=this.evaluateNodeSync(e.right);if("MemberExpression"===e.left.type){this.evaluateNodeSync(e.left.object)[e.left.computed?this.evaluateNodeSync(e.left.property):e.left.property.name]=o}else"Identifier"===e.left.type&&this.currentContext.variables.set(e.left.name,o);return o;case"ConditionalExpression":return this.evaluateNodeSync(e.test)?this.evaluateNodeSync(e.consequent):this.evaluateNodeSync(e.alternate);case"BlockStatement":let a;for(const t of e.body)a=this.evaluateNodeSync(t);return a;case"ExpressionStatement":return this.evaluateNodeSync(e.expression);case"ReturnStatement":throw{type:"return",value:e.argument?this.evaluateNodeSync(e.argument):void 0};case"IfStatement":return this.evaluateNodeSync(e.test)?this.evaluateNodeSync(e.consequent):e.alternate?this.evaluateNodeSync(e.alternate):void 0;case"CallExpression":let i,l=null;if("MemberExpression"===e.callee.type){const t=this.evaluateNodeSync(e.callee.object),s=e.callee.computed?this.evaluateNodeSync(e.callee.property):e.callee.property.name;i=t?.[s],l=t}else i=this.evaluateNodeSync(e.callee);if("function"!=typeof i)throw new Error(`Not a function: ${e.callee.name||"expression"}`);const c=e.arguments.map(e=>{if("SpreadElement"===e.type){return this.evaluateNodeSync(e.argument)}return this.evaluateNodeSync(e)}),u=c.map(e=>void 0===e&&void 0!==this.lastPipelineValue?this.lastPipelineValue:e),p=[];for(let t=0;t<u.length;t++)"SpreadElement"===e.arguments[t].type?p.push(...u[t]):p.push(u[t]);return i.apply(l,p);case"ThrowStatement":throw this.evaluateNodeSync(e.argument);case"ThisExpression":return this.currentContext.variables.get("this");case"ArrowFunctionExpression":case"FunctionExpression":return this.createSyncFunction(e);case"ObjectExpression":const m={};for(const t of e.properties)if("SpreadElement"===t.type){const e=this.evaluateNodeSync(t.argument);Object.assign(m,e)}else{const e=t.computed?this.evaluateNodeSync(t.key):"Identifier"===t.key.type?t.key.name:this.evaluateNodeSync(t.key);t.shorthand?m[e]=this.evaluateIdentifier(t.key):m[e]=this.evaluateNodeSync(t.value)}return m;case"ArrayExpression":const h=[];for(const t of e.elements)if(null===t)h.push(void 0);else if("SpreadElement"===t.type){const e=this.evaluateNodeSync(t.argument);h.push(...e)}else h.push(this.evaluateNodeSync(t));return h;case"PipelineExpression":const f=this.evaluateNodeSync(e.left),y=this.lastPipelineValue;this.lastPipelineValue=f;try{return this.evaluateNodeSync(e.right)}finally{this.lastPipelineValue=y}default:throw new Error(`Cannot evaluate node type synchronously: ${e.type}`)}}async evaluateNode(e){if(e)switch(e.type){case"Program":return this.evaluateProgram(e);case"VariableDeclaration":return this.evaluateVariableDeclaration(e);case"FunctionDeclaration":return this.evaluateFunctionDeclaration(e);case"ClassDeclaration":return this.evaluateClassDeclaration(e);case"ExpressionStatement":return this.evaluateNode(e.expression);case"BlockStatement":return this.evaluateBlock(e);case"IfStatement":return this.evaluateIfStatement(e);case"ForStatement":case"ForOfStatement":case"ForInStatement":return this.evaluateForStatement(e);case"WhileStatement":return this.evaluateWhileStatement(e);case"DoWhileStatement":return this.evaluateDoWhileStatement(e);case"SwitchStatement":return this.evaluateSwitchStatement(e);case"BreakStatement":throw{type:"break",label:e.label};case"ContinueStatement":throw{type:"continue",label:e.label};case"LabeledStatement":return this.evaluateLabeledStatement(e);case"ReturnStatement":throw{type:"return",value:e.argument?await this.evaluateNode(e.argument):void 0};case"ThrowStatement":throw await this.evaluateNode(e.argument);case"TryStatement":return this.evaluateTryStatement(e);case"ImportDeclaration":return this.evaluateImport(e);case"ExportNamedDeclaration":return this.evaluateExport(e);case"Identifier":return this.evaluateIdentifier(e);case"Literal":return e.value;case"RegexLiteral":return new RegExp(e.pattern,e.flags);case"TemplateLiteral":return this.evaluateTemplateLiteral(e);case"ArrayExpression":return this.evaluateArrayExpression(e);case"ObjectExpression":return this.evaluateObjectExpression(e);case"FunctionExpression":case"ArrowFunctionExpression":return this.createFunction(e);case"CallExpression":return this.evaluateCallExpression(e);case"NewExpression":return this.evaluateNewExpression(e);case"MemberExpression":return this.evaluateMemberExpression(e);case"BinaryExpression":return this.evaluateBinaryExpression(e);case"UnaryExpression":return this.evaluateUnaryExpression(e);case"AssignmentExpression":return this.evaluateAssignmentExpression(e);case"UpdateExpression":return this.evaluateUpdateExpression(e);case"ConditionalExpression":return this.evaluateConditionalExpression(e);case"PipelineExpression":return this.evaluatePipelineExpression(e);case"ThisExpression":return this.currentContext.variables.get("this");case"Super":return this.currentContext.variables.get("__super__");case"SpreadElement":const t=await this.evaluateNode(e.argument);if(!Array.isArray(t))throw new o("array",t,"spread operator");return t;default:throw new r(`Unknown node type: ${e.type}`,{type:"RuntimeError"})}}async evaluateProgram(e){const t=this.processContinuations(e.body);let s;this.hoistVarDeclarations(t);for(const e of t)s=await this.evaluateNode(e);return s}processContinuations(e){const t=[];for(let s=0;s<e.length;s++){const r=e[s];if("PipelineContinuation"===r.type||"MemberContinuation"===r.type){if(t.length>0){const e=t[t.length-1];if("ExpressionStatement"===e.type){if("AssignmentExpression"===e.expression.type){if("PipelineContinuation"===r.type)e.expression.right={type:"PipelineExpression",operator:r.operator,left:e.expression.right,right:r.right};else if("MemberContinuation"===r.type){const t={type:"MemberExpression",object:e.expression.right,property:r.property,computed:!1,optional:r.optional};e.expression.right=r.arguments?{type:"CallExpression",callee:t,arguments:r.arguments}:t}}else if("PipelineContinuation"===r.type)e.expression={type:"PipelineExpression",operator:r.operator,left:e.expression,right:r.right};else if("MemberContinuation"===r.type){const t={type:"MemberExpression",object:e.expression,property:r.property,computed:!1,optional:r.optional};e.expression=r.arguments?{type:"CallExpression",callee:t,arguments:r.arguments}:t}continue}if("VariableDeclaration"===e.type&&e.declarations&&e.declarations.length>0){const t=e.declarations[e.declarations.length-1];if(t.init){if("PipelineContinuation"===r.type)t.init={type:"PipelineExpression",operator:r.operator,left:t.init,right:r.right};else if("MemberContinuation"===r.type){const e={type:"MemberExpression",object:t.init,property:r.property,computed:!1,optional:r.optional};t.init=r.arguments?{type:"CallExpression",callee:e,arguments:r.arguments}:e}continue}}if("ReturnStatement"===e.type&&e.argument){if("PipelineContinuation"===r.type)e.argument={type:"PipelineExpression",operator:r.operator,left:e.argument,right:r.right};else if("MemberContinuation"===r.type){const t={type:"MemberExpression",object:e.argument,property:r.property,computed:!1,optional:r.optional};e.argument=r.arguments?{type:"CallExpression",callee:t,arguments:r.arguments}:t}continue}}throw new Error(`Unexpected continuation operator at statement ${s+1}`)}t.push(r)}return t}hoistVarDeclarations(e){for(const t of e)if("VariableDeclaration"===t.type&&"var"===t.kind)for(const e of t.declarations)this.hoistVarPattern(e.id);else"FunctionDeclaration"===t.type&&this.currentContext.functions.set(t.id.name,this.createFunction(t))}hoistVarPattern(e){if("Identifier"===e.type)this.currentContext.variables.has(e.name)||(this.currentContext.variables.set(e.name,void 0),this.currentContext.variableKinds.set(e.name,"var"));else if("ObjectPattern"===e.type)for(const t of e.properties)if("Property"===t.type)if(t.shorthand&&"string"==typeof t.value)this.currentContext.variables.has(t.value)||(this.currentContext.variables.set(t.value,void 0),this.currentContext.variableKinds.set(t.value,"var"));else{const e="string"==typeof t.value?{type:"Identifier",name:t.value}:t.value;this.hoistVarPattern(e)}else"RestElement"===t.type&&(this.currentContext.variables.has(t.argument)||(this.currentContext.variables.set(t.argument,void 0),this.currentContext.variableKinds.set(t.argument,"var")));else if("ArrayPattern"===e.type)for(const t of e.elements)if(t)if("RestElement"===t.type){const e=t.argument.name||t.argument;this.currentContext.variables.has(e)||(this.currentContext.variables.set(e,void 0),this.currentContext.variableKinds.set(e,"var"))}else this.hoistVarPattern(t)}async evaluateVariableDeclaration(e){for(const t of e.declarations){const s=t.init?await this.evaluateNode(t.init):void 0;this.assignPattern(t.id,s,e.kind)}}assignPattern(e,t,s){if("Identifier"===e.type)if("var"===s){let s=this.currentContext;for(;s;){if(s.variables.has(e.name)){s.variables.set(e.name,t);break}s=s.parent}s||(this.currentContext.variables.set(e.name,t),this.currentContext.variableKinds.set(e.name,"var"))}else this.currentContext.variables.set(e.name,t),s&&this.currentContext.variableKinds.set(e.name,s);else if("ObjectPattern"===e.type){if(null==t)throw new TypeError("Cannot destructure 'null' or 'undefined'");for(const r of e.properties)if("Property"===r.type){const e="Identifier"===r.key.type?r.key.name:r.key.value;if(r.shorthand&&"string"==typeof r.value)this.currentContext.variables.set(r.value,t[e]),s&&this.currentContext.variableKinds.set(r.value,s);else{const n="string"==typeof r.value?{type:"Identifier",name:r.value}:r.value;this.assignPattern(n,t[e],s)}}else if("RestElement"===r.type){const n={...t};for(const t of e.properties)if("Property"===t.type){delete n["Identifier"===t.key.type?t.key.name:t.key.value]}this.currentContext.variables.set(r.argument,n),s&&this.currentContext.variableKinds.set(r.argument,s)}}else if("ArrayPattern"===e.type){if(null==t)throw new TypeError("Cannot destructure 'null' or 'undefined'");const r=Array.isArray(t)?t:[];let n=0;for(const t of e.elements)t&&("RestElement"===t.type?(this.currentContext.variables.set(t.argument.name||t.argument,r.slice(n)),s&&this.currentContext.variableKinds.set(t.argument.name||t.argument,s)):this.assignPattern(t,r[n],s)),n++}}async evaluateFunctionDeclaration(e){const t=this.createFunction(e);this.currentContext.functions.set(e.id.name,t)}createFunction(e){const t=e.params||[],s=e.body,r=e.async,n=this.currentContext,o="ArrowFunctionExpression"===e.type?this.currentContext.variables.get("this"):void 0;if(!r&&"ArrowFunctionExpression"===e.type&&"BlockStatement"!==s.type){return(...e)=>{const r=this.createContext(n);r.variables.set("this",o);const a=this.currentContext;this.currentContext=r;for(let s=0;s<t.length;s++){const n=t[s];if("RestElement"===n.type)r.variables.set(n.argument.name||n.argument,e.slice(s));else if("Identifier"===n.type)r.variables.set(n.name,e[s]);else if("AssignmentPattern"===n.type){const t=void 0!==e[s]?e[s]:this.evaluateNodeSync(n.right);"Identifier"===n.left.type&&r.variables.set(n.left.name,t)}}try{return this.evaluateNodeSync(s)}finally{this.currentContext=a}}}const a=this,i=async function(...r){const l=a.createContext(n);e.id&&e.id.name&&l.variables.set(e.id.name,i),"ArrowFunctionExpression"===e.type?l.variables.set("this",o):l.variables.set("this",this);const c=a.currentContext;a.currentContext=l;for(let e=0;e<t.length;e++){const s=t[e];if("RestElement"===s.type){l.variables.set(s.argument.name||s.argument,r.slice(e));break}if("AssignmentPattern"===s.type){const t=e<r.length&&void 0!==r[e]?r[e]:await a.evaluateNode(s.right);a.assignPattern(s.left,t)}else a.assignPattern(s,r[e])}try{return"BlockStatement"===s.type?(a.hoistVarDeclarations(s.body),void await a.evaluateBlock(s)):await a.evaluateNode(s)}catch(e){if("return"===e?.type)return e.value;throw e}finally{a.currentContext=c}};return r?i:(...e)=>{const t=i(...e);return t instanceof Promise?t:Promise.resolve(t)}}async evaluateClassDeclaration(e){const t=e.id.name,s=e.superClass?this.evaluateIdentifier(e.superClass):null,r=e.body.body.find(e=>"constructor"===e.kind),n=this,o=function(...e){return(async()=>{const t=Object.create(o.prototype);if(r){const o=n.createContext(n.currentContext);o.variables.set("this",t),s&&o.variables.set("__super__",async(...e)=>{const r=await s(...e);Object.assign(t,r),r instanceof Error&&(void 0!==r.message&&(t.message=r.message),void 0!==r.name&&(t.name=r.name),void 0!==r.stack&&(t.stack=r.stack))});for(let t=0;t<r.params.length;t++){const s=r.params[t];"Identifier"===s.type&&o.variables.set(s.name,e[t])}const a=n.currentContext;n.currentContext=o;try{for(const e of r.body.body)await n.evaluateNode(e)}finally{n.currentContext=a}}return t})()};s&&(o.prototype=Object.create(s.prototype),o.prototype.constructor=o);for(const t of e.body.body)if("MethodDefinition"===t.type&&"constructor"!==t.kind){const e=t.key.name;if("get"===t.kind||"set"===t.kind){const s=t.static?o:o.prototype,r=Object.getOwnPropertyDescriptor(s,e)||{configurable:!0,enumerable:!0};"get"===t.kind?r.get=function(){const e=n.createContext(n.currentContext);e.variables.set("this",this);const s=n.currentContext;n.currentContext=e;try{let e;for(const s of t.body.body)try{e=n.evaluateNodeSync(s)}catch(e){if("return"===e.type)return e.value;throw e}return e}finally{n.currentContext=s}}:r.set=function(e){const s=n.createContext(n.currentContext);if(s.variables.set("this",this),t.params.length>0){const r=t.params[0];"Identifier"===r.type&&s.variables.set(r.name,e)}const r=n.currentContext;n.currentContext=s;try{for(const e of t.body.body)if("ExpressionStatement"===e.type)n.evaluateNodeSync(e.expression);else if("IfStatement"===e.type){n.evaluateNodeSync(e.test)?n.evaluateNodeSync(e.consequent):e.alternate&&n.evaluateNodeSync(e.alternate)}else if("ThrowStatement"===e.type)throw n.evaluateNodeSync(e.argument)}finally{n.currentContext=r}},Object.defineProperty(s,e,r)}else{const s=async function(...e){const s=n.createContext(n.currentContext);s.variables.set("this",t.static?o:this);for(let r=0;r<t.params.length;r++){const o=t.params[r];if("Identifier"===o.type)s.variables.set(o.name,e[r]);else if("AssignmentPattern"===o.type){const t=r<e.length&&void 0!==e[r]?e[r]:await n.evaluateNode(o.right);"Identifier"===o.left.type&&s.variables.set(o.left.name,t)}}const r=n.currentContext;n.currentContext=s;try{let e;for(const s of t.body.body)try{e=await n.evaluateNode(s)}catch(e){if("return"===e.type)return e.value;throw e}return e}finally{n.currentContext=r}};t.static?o[e]=s:o.prototype[e]=s}}this.currentContext.classes.set(t,o),this.currentContext.variables.set(t,o)}async evaluateBlock(e){const t=this.createContext(this.currentContext),s=this.currentContext;this.currentContext=t;try{e._processedBody||(e._processedBody=this.processContinuations(e.body));const t=e._processedBody;let s;for(const e of t)s=await this.evaluateNode(e);return s}finally{this.currentContext=s}}async evaluateIfStatement(e){return await this.evaluateNode(e.test)?await this.evaluateNode(e.consequent):e.alternate?await this.evaluateNode(e.alternate):void 0}async evaluateForStatement(e){if("ForOfStatement"===e.type){const t=await this.evaluateNode(e.right);for(const s of t){"VariableDeclaration"===e.left.type&&this.assignPattern(e.left.declarations[0].id,s);try{await this.evaluateNode(e.body)}catch(e){if("break"===e.type&&!e.label)break;if("continue"===e.type&&!e.label)continue;throw e}}}else if("ForInStatement"===e.type){const t=await this.evaluateNode(e.right);for(const s in t){"VariableDeclaration"===e.left.type&&this.assignPattern(e.left.declarations[0].id,s);try{await this.evaluateNode(e.body)}catch(e){if("break"===e.type&&!e.label)break;if("continue"===e.type&&!e.label)continue;throw e}}}else for(e.init&&await this.evaluateNode(e.init);!e.test||await this.evaluateNode(e.test);){try{await this.evaluateNode(e.body)}catch(t){if("break"===t.type&&!t.label)break;if("continue"===t.type&&!t.label){e.update&&await this.evaluateNode(e.update);continue}throw t}e.update&&await this.evaluateNode(e.update)}}async evaluateWhileStatement(e){for(;await this.evaluateNode(e.test);)try{await this.evaluateNode(e.body)}catch(e){if("break"===e.type&&!e.label)break;if("continue"===e.type&&!e.label)continue;throw e}}async evaluateDoWhileStatement(e){do{try{await this.evaluateNode(e.body)}catch(e){if("break"===e.type&&!e.label)break;if("continue"===e.type&&!e.label)continue;throw e}}while(await this.evaluateNode(e.test))}async evaluateLabeledStatement(e){try{return await this.evaluateNode(e.body)}catch(t){if(("break"===t.type||"continue"===t.type)&&t.label===e.label){if("break"===t.type)return;throw t}throw t}}async evaluateSwitchStatement(e){const t=await this.evaluateNode(e.discriminant);let s=!1;for(const r of e.cases){if(!s)if(null===r.test)s=!0;else{t===await this.evaluateNode(r.test)&&(s=!0)}if(s)try{for(const e of r.consequent)await this.evaluateNode(e)}catch(e){if("break"===e.type)break;throw e}}}async evaluateTryStatement(e){let t;try{t=await this.evaluateNode(e.block)}catch(s){if(s&&"object"==typeof s&&("break"===s.type||"continue"===s.type||"return"===s.type))throw s;if(!e.handler)throw s;e.handler.param&&this.assignPattern(e.handler.param,s),t=await this.evaluateNode(e.handler.body)}finally{if(e.finalizer){t=await this.evaluateNode(e.finalizer)}}return t}evaluateIdentifier(e){const t=e.name;if("_"===t)return this.lastPipelineValue;if("this"===t&&console.log("Looking up this, context has:",this.currentContext.variables.has("this"),"value:",this.currentContext.variables.get("this")),this.currentContext.variables.has(t))return this.currentContext.variables.get(t);let s=this.currentContext.parent;for(;s;){if(s.variables.has(t))return s.variables.get(t);s=s.parent}if(this.currentContext.functions.has(t))return this.currentContext.functions.get(t);if(this.globalContext.functions.has(t))return this.globalContext.functions.get(t);if(this.currentContext.classes.has(t))return this.currentContext.classes.get(t);throw new a(t,[...this.currentContext.variables.keys()])}async evaluateCallExpression(e){if("Super"===e.callee.type){const t=this.currentContext.variables.get("__super__");if(!t)throw new r("super() can only be called in a derived class constructor",{type:"RuntimeError"});const s=[];for(const t of e.arguments)if("SpreadElement"===t.type){const e=await this.evaluateNode(t.argument);s.push(...e)}else s.push(await this.evaluateNode(t));return t(...s)}let t,s=null;if("MemberExpression"===e.callee.type){const r=await this.evaluateNode(e.callee.object),n=e.callee.computed?await this.evaluateNode(e.callee.property):e.callee.property.name;t=r?.[n],s=r}else t=await this.evaluateNode(e.callee);if("function"!=typeof t)throw new o("function",t,"call expression");const n=[];for(const t of e.arguments)if("SpreadElement"===t.type){const e=await this.evaluateNode(t.argument);n.push(...e)}else n.push(await this.evaluateNode(t));const a=n.map(e=>void 0===e&&void 0!==this.lastPipelineValue?this.lastPipelineValue:e);return t.apply(s,a)}async evaluatePipelineExpression(e){let t=await this.evaluateNode(e.left);this.lastPipelineValue=t;const s=await this.evaluateNode(e.right);return t="function"==typeof s?await s(t):s,this.lastPipelineValue=t,t}async evaluateBinaryExpression(e){const t=await this.evaluateNode(e.left),s=await this.evaluateNode(e.right);switch(e.operator){case"+":return t+s;case"-":return t-s;case"*":return t*s;case"/":return t/s;case"%":return t%s;case"**":return t**s;case"==":return t==s;case"!=":return t!=s;case"===":return t===s;case"!==":return t!==s;case"<":return t<s;case">":return t>s;case"<=":return t<=s;case">=":return t>=s;case"&&":return t&&s;case"||":return t||s;case"??":return t??s;default:throw new r(`Unknown binary operator: ${e.operator}`,{type:"RuntimeError"})}}async evaluateUnaryExpression(e){if("++"===e.operator||"--"===e.operator){if("Identifier"!==e.argument.type)throw new r("Prefix increment/decrement only supports identifiers",{type:"RuntimeError"});const t=e.argument.name,s=this.evaluateIdentifier(e.argument)||0,n="++"===e.operator?s+1:s-1;let o=this.currentContext;for(;o;){if(o.variables.has(t)){o.variables.set(t,n);break}o=o.parent}return o||this.currentContext.variables.set(t,n),n}if("typeof"===e.operator){if("Identifier"===e.argument.type){const t=e.argument.name;let s=this.currentContext;for(;s;){if(s.variables.has(t)){return typeof s.variables.get(t)}if(s.functions.has(t))return"function";s=s.parent}return this.currentContext.functions.has(t)?"function":"undefined"}return typeof await this.evaluateNode(e.argument)}const t=await this.evaluateNode(e.argument);switch(e.operator){case"!":return!t;case"+":return+t;case"-":return-t;case"await":return await t;default:throw new r(`Unknown unary operator: ${e.operator}`,{type:"RuntimeError"})}}async evaluateAssignmentExpression(e){const t=await this.evaluateNode(e.right);if("Identifier"===e.left.type){const s=e.left.name;switch(e.operator){case"=":let n=this.currentContext,o=!1;for(;n;){if(n.variables.has(s)){if("const"===n.variableKinds.get(s))throw new r(`Cannot reassign const variable "${s}"`);n.variables.set(s,t),o=!0;break}n=n.parent}return o||this.currentContext.variables.set(s,t),t;case"+=":const a=(this.evaluateIdentifier(e.left)||0)+t;let i=this.currentContext;for(;i;){if(i.variables.has(s)){if("const"===i.variableKinds.get(s))throw new r(`Cannot reassign const variable "${s}"`);i.variables.set(s,a);break}i=i.parent}return i||this.currentContext.variables.set(s,a),a;case"-=":const l=(this.evaluateIdentifier(e.left)||0)-t;let c=this.currentContext;for(;c;){if(c.variables.has(s)){if("const"===c.variableKinds.get(s))throw new r(`Cannot reassign const variable "${s}"`);c.variables.set(s,l);break}c=c.parent}return c||this.currentContext.variables.set(s,l),l;case"*=":const u=(this.evaluateIdentifier(e.left)||0)*t;let p=this.currentContext;for(;p;){if(p.variables.has(s)){if("const"===p.variableKinds.get(s))throw new r(`Cannot reassign const variable "${s}"`);p.variables.set(s,u);break}p=p.parent}return p||this.currentContext.variables.set(s,u),u;case"/=":const m=this.evaluateIdentifier(e.left)||0;if(0===t)throw new r("Division by zero in /= operation");const h=m/t;let f=this.currentContext;for(;f;){if(f.variables.has(s)){if("const"===f.variableKinds.get(s))throw new r(`Cannot reassign const variable "${s}"`);f.variables.set(s,h);break}f=f.parent}return f||this.currentContext.variables.set(s,h),h;default:throw new r(`Assignment operator ${e.operator} not implemented`,{type:"RuntimeError"})}}else if("MemberExpression"===e.left.type){const s=await this.evaluateNode(e.left.object),n=e.left.computed?await this.evaluateNode(e.left.property):e.left.property.name;if(null==s)throw new r(`Cannot set property '${n}' on null or undefined`,{type:"RuntimeError"});switch(e.operator){case"=":return s[n]=t,t;case"+=":return s[n]=(s[n]||0)+t,s[n];case"-=":return s[n]=(s[n]||0)-t,s[n];case"*=":return s[n]=(s[n]||0)*t,s[n];case"/=":if(0===t)throw new r("Division by zero in /= operation");return s[n]=(s[n]||0)/t,s[n];default:throw new r(`Assignment operator ${e.operator} not implemented for member expressions`,{type:"RuntimeError"})}}throw new r("Complex assignment patterns not yet implemented",{type:"RuntimeError"})}async evaluateUpdateExpression(e){if("Identifier"===e.argument.type){const t=e.argument.name,s=this.evaluateIdentifier(e.argument)||0,n="++"===e.operator?s+1:s-1;let o=this.currentContext;for(;o;){if(o.variables.has(t)){if("const"===o.variableKinds.get(t))throw new r(`Cannot reassign const variable "${t}"`);o.variables.set(t,n);break}o=o.parent}return o||this.currentContext.variables.set(t,n),e.prefix?n:s}if("MemberExpression"===e.argument.type){const t=await this.evaluateNode(e.argument.object),s=e.argument.computed?await this.evaluateNode(e.argument.property):e.argument.property.name;if(null==t)throw new r(`Cannot update property '${s}' on null or undefined`,{type:"RuntimeError"});const n=t[s]||0,o="++"===e.operator?n+1:n-1;return t[s]=o,e.prefix?o:n}throw new r("Update expression only supports identifiers and member expressions",{type:"RuntimeError"})}async evaluateConditionalExpression(e){return await this.evaluateNode(e.test)?await this.evaluateNode(e.consequent):await this.evaluateNode(e.alternate)}async evaluateMemberExpression(e){const t=await this.evaluateNode(e.object);if(e.optional&&null==t)return;if(!e.optional&&null==t){const s=e.computed?"computed property":e.property.name;throw new Error(`Cannot read properties of ${t} (reading '${s}')`)}return t[e.computed?await this.evaluateNode(e.property):e.property.name]}async evaluateNewExpression(e){const t=await this.evaluateNode(e.callee);if("function"!=typeof t)throw new o("constructor",t,"new expression");const s=[];for(const t of e.arguments)s.push(await this.evaluateNode(t));if(t===Date||t===Error||t===Array||t===Object||t===RegExp||t===Map||t===Set||t===Promise)return new t(...s);return await t(...s)}async evaluateArrayExpression(e){const t=[];for(const s of e.elements)if(s)if("SpreadElement"===s.type){const e=await this.evaluateNode(s.argument);t.push(...e)}else t.push(await this.evaluateNode(s));else t.push(void 0);return t}async evaluateObjectExpression(e){const t={};for(const s of e.properties)if("SpreadElement"===s.type){const e=await this.evaluateNode(s.argument);Object.assign(t,e)}else if("Property"===s.type){const e=s.computed?await this.evaluateNode(s.key):s.key.name||s.key.value||s.key;s.shorthand?t[e]=this.evaluateIdentifier({name:e}):t[e]=await this.evaluateNode(s.value)}return t}async evaluateTemplateLiteral(e){if(e.quasis&&e.quasis.length>0){const t=e.quasis[0].value.raw;return t.includes("${")?await this.interpolateTemplate(t):t}const t=e.raw||e.value;if("string"==typeof t&&t.startsWith("`")&&t.endsWith("`")){const e=t.slice(1,-1);return await this.interpolateTemplate(e)}return e.value||""}async interpolateTemplate(e){const t=/\$\{([^}]+)\}/g;let s,r=e;const n=[];for(;null!==(s=t.exec(e));){const e=s[1];try{const t=e.trim(),r=await this.evaluateTemplateExpression(t);n.push({start:s.index,end:s.index+s[0].length,value:String(r)})}catch(t){console.warn(`Failed to evaluate template expression: ${e}`)}}for(let e=n.length-1;e>=0;e--){const t=n[e];r=r.slice(0,t.start)+t.value+r.slice(t.end)}return r}async evaluateTemplateExpression(e){if(/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(e))return this.evaluateIdentifier({name:e});const t=e.match(/^(.+?)\s*([\+\-\*\/])\s*(.+)$/);if(t){const s=await this.evaluateTemplateExpression(t[1].trim()),r=await this.evaluateTemplateExpression(t[3].trim());switch(t[2]){case"+":return s+r;case"-":return s-r;case"*":return s*r;case"/":return s/r;default:return e}}if(e.includes(".")){const t=e.split(".");let s=await this.evaluateTemplateExpression(t[0]);for(let e=1;e<t.length;e++)s=s[t[e]];return s}const s=Number(e);return isNaN(s)?e.startsWith('"')&&e.endsWith('"')||e.startsWith("'")&&e.endsWith("'")?e.slice(1,-1):e:s}async evaluateImport(e){const t=e.source.value||e.source,s=await this.importModule(t);for(const t of e.specifiers)if("ImportNamespaceSpecifier"===t.type){const e=t.local.name||t.local;this.currentContext.variables.set(e,s)}else if("ImportSpecifier"===t.type){const e=t.imported.name||t.imported,r=t.local.name||t.local,n=s[e];this.currentContext.variables.set(r,n)}}async evaluateExport(e){if(e.declaration)if(await this.evaluateNode(e.declaration),"VariableDeclaration"===e.declaration.type){for(const t of e.declaration.declarations)if("Identifier"===t.id.type){const e=this.currentContext.variables.get(t.id.name);this.currentContext.exports.set(t.id.name,e),this.currentContext.moduleExports&&(this.currentContext.moduleExports[t.id.name]=e)}}else if("FunctionDeclaration"===e.declaration.type){const t=this.currentContext.functions.get(e.declaration.id.name);this.currentContext.exports.set(e.declaration.id.name,t),this.currentContext.moduleExports&&(this.currentContext.moduleExports[e.declaration.id.name]=t)}else if("ClassDeclaration"===e.declaration.type){const t=this.currentContext.classes.get(e.declaration.id.name);this.currentContext.exports.set(e.declaration.id.name,t),this.currentContext.moduleExports&&(this.currentContext.moduleExports[e.declaration.id.name]=t)}for(const t of e.specifiers||[]){const e=this.currentContext.variables.get(t.local)||this.currentContext.functions.get(t.local)||this.currentContext.classes.get(t.local);this.currentContext.exports.set(t.exported,e),this.currentContext.moduleExports&&(this.currentContext.moduleExports[t.exported]=e)}}async importModule(e){if(this.globalModuleCache.has(e))return this.globalModuleCache.get(e);const t={};this.globalModuleCache.set(e,t);const{code:s}=await this.moduleResolver.resolve(e),r=this.createContext(this.globalContext);return r.moduleExports=t,await this.execute(s,r),r.exports.forEach((e,s)=>{t[s]=e}),t}}class S extends ${constructor(e={}){super(e),this.operationCounter=0,this.contextIdMap=new Map,this.idContextMap=new Map,this.nextContextId=0,this.pauseCheckInterval=e.pauseCheckInterval??10,this.executionState={type:"completed",callStack:[]}}pause(){"running"===this.executionState.type&&(this.executionState.pauseRequested=!0)}async resume(){if("paused"!==this.executionState.type)throw new Error("Interpreter is not paused");this.executionState.type="running",this.executionState.pauseRequested=!1;try{const e=await this.resumeFromCallStack();return this.executionState.type="completed",this.executionState.result=e,e}catch(e){throw this.executionState.type="error",this.executionState.error=e,e}}async checkPause(){if(this.operationCounter++,this.operationCounter%this.pauseCheckInterval===0&&await new Promise(e=>setTimeout(e,0)),this.executionState.pauseRequested)throw this.executionState.type="paused",this.executionState.pauseRequested=!1,{type:"pause",state:this.executionState}}async evaluateNode(e){await this.checkPause(),this.executionState.currentNode=e;let t;["FunctionDeclaration","FunctionExpression","ArrowFunctionExpression","BlockStatement","ForStatement","WhileStatement","DoWhileStatement"].includes(e.type)&&(t={type:this.getFrameType(e.type),node:e,context:this.currentContext,name:e.id?.name},this.executionState.callStack.push(t));try{const s=await super.evaluateNode(e);return t&&this.executionState.callStack.pop(),s}catch(e){if(e&&"object"==typeof e&&"pause"===e.type)throw e;throw t&&this.executionState.callStack.pop(),e}}async execute(e,t){this.executionState={type:"running",callStack:[]};const{grammar:s,nearley:r}=await Promise.resolve().then(function(){return w}),n=new r.Parser(r.Grammar.fromCompiled(s));try{if(n.feed(e),0===n.results.length)throw new Error("No parse found");n.results.length>1&&console.warn("Ambiguous grammar detected, using first parse");const s=n.results[0],r=t||this.globalContext,o=this.currentContext;this.currentContext=r;try{const e=await this.evaluateNode(s);return this.executionState.type="completed",this.executionState.result=e,e}finally{this.currentContext=o}}catch(e){if(e&&"object"==typeof e&&"pause"===e.type)return;if(e&&"object"==typeof e&&"return"===e.type)return this.executionState.type="completed",this.executionState.result=e.value,e.value;throw this.executionState.type="error",this.executionState.error=e,e}}getExecutionState(){return{...this.executionState}}serialize(){return this.assignContextIds(this.globalContext),{version:"1.0.0",globalContext:this.serializeContext(this.globalContext),currentContext:this.serializeContext(this.currentContext),executionState:this.serializeExecutionState(),moduleCache:Array.from(this.globalModuleCache.entries()),lastPipelineValue:this.lastPipelineValue,customFunctions:Array.from(this.globalContext.functions.keys())}}static async deserialize(e,t={}){const s=new S({moduleResolver:t.moduleResolver||new i,functions:t.functions});return s.deserializeContexts(e),e.moduleCache.forEach(([e,t])=>{s.globalModuleCache.set(e,t)}),s.executionState=s.deserializeExecutionState(e.executionState),s.lastPipelineValue=e.lastPipelineValue,s}assignContextIds(e,t=new Set){if(t.has(e))return;t.add(e);const s="ctx_"+this.nextContextId++;this.contextIdMap.set(e,s),this.idContextMap.set(s,e),e.parent&&this.assignContextIds(e.parent,t)}serializeContext(e){const t=e.parent?this.contextIdMap.get(e.parent):void 0;return{variables:Array.from(e.variables.entries()).map(([e,t])=>[e,this.serializeValue(t)]),variableKinds:Array.from(e.variableKinds.entries()),functionNames:Array.from(e.functions.keys()),classNames:Array.from(e.classes.keys()),exports:Array.from(e.exports.entries()).map(([e,t])=>[e,this.serializeValue(t)]),parentId:t,moduleCache:Array.from(e.moduleCache.entries())}}serializeValue(e){if(void 0===e)return{__type:"undefined"};if(null===e)return null;if("function"==typeof e)return{__type:"function",name:e.name||"anonymous"};if(e instanceof Date)return{__type:"Date",value:e.toISOString()};if(e instanceof RegExp)return{__type:"RegExp",source:e.source,flags:e.flags};if(e instanceof Map)return{__type:"Map",entries:Array.from(e.entries())};if(e instanceof Set)return{__type:"Set",values:Array.from(e.values())};if("object"==typeof e)try{return JSON.parse(JSON.stringify(e))}catch{return{__type:"circular_reference"}}return e}deserializeValue(e){if(e&&"object"==typeof e&&"__type"in e)switch(e.__type){case"undefined":return;case"function":return()=>{throw new Error(`Function ${e.name} needs to be re-bound`)};case"Date":return new Date(e.value);case"RegExp":return new RegExp(e.source,e.flags);case"Map":return new Map(e.entries);case"Set":return new Set(e.values);case"circular_reference":return null}return e}serializeExecutionState(){return{...this.executionState,callStack:this.executionState.callStack.map(e=>({...e,context:this.serializeContext(e.context)}))}}deserializeExecutionState(e){return{...e,callStack:e.callStack.map(e=>({...e,context:this.idContextMap.get(e.context.parentId)||this.currentContext}))}}deserializeContexts(e){const t=new Map,s=this.createContext();if(this.restoreContextData(s,e.globalContext),t.set("global",s),this.globalContext=s,e.currentContext===e.globalContext)this.currentContext=s;else{const s=this.createContext();this.restoreContextData(s,e.currentContext),t.set("current",s),this.currentContext=s}e.currentContext.parentId&&(this.currentContext.parent=t.get(e.currentContext.parentId))}restoreContextData(e,t){t.variables.forEach(([t,s])=>{const r=this.deserializeValue(s);e.variables.set(t,r)}),t.variableKinds.forEach(([t,s])=>{e.variableKinds.set(t,s)}),t.variables.some(([e])=>"Date"===e)&&e.variables.set("Date",Date),t.variables.some(([e])=>"Error"===e)&&e.variables.set("Error",Error),t.exports.forEach(([t,s])=>{e.exports.set(t,this.deserializeValue(s))}),t.moduleCache.forEach(([t,s])=>{e.moduleCache.set(t,s)})}getFrameType(e){switch(e){case"FunctionDeclaration":case"FunctionExpression":case"ArrowFunctionExpression":return"function";case"BlockStatement":default:return"block";case"ForStatement":case"WhileStatement":case"DoWhileStatement":return"loop";case"Program":return"program"}}async resumeFromCallStack(){const e=this.executionState.callStack[this.executionState.callStack.length-1];if(!e)throw new Error("No frame to resume from");return this.currentContext=e.context,this.evaluateNode(e.node)}getCallStackTrace(){return this.executionState.callStack.map(e=>{const t=e.name||"<anonymous>";return`${e.type}: ${t}`})}getCurrentVariables(){const e={};let t=this.currentContext;for(;t;)t.variables.forEach((t,s)=>{s in e||(e[s]=t)}),t=t.parent;return e}isPaused(){return"paused"===this.executionState.type}isRunning(){return"running"===this.executionState.type}isCompleted(){return"completed"===this.executionState.type}hasError(){return"error"===this.executionState.type}}class C{validate(e,t={}){try{const s=new h.Parser(h.Grammar.fromCompiled(E));return s.feed(e),0===s.results.length?{valid:!1,error:{message:"No valid parse found",line:0,column:0}}:(s.results.length>1&&console.warn(`Grammar ambiguity: ${s.results.length} possible parses found`),{valid:!0,ast:t.includeAST?s.results[0]:void 0})}catch(t){return this.formatError(t,e)}}formatError(e,t){const s=e.message||e.toString(),r=s.match(/line (\d+) col (\d+)/),n=r?parseInt(r[1]):0,o=r?parseInt(r[2]):0,a=t.split("\n");let i,l="";if(r&&n>0){l=`Parse error: Syntax error at line ${n} col ${o}:\n\n`;const e=Math.max(0,n-3),t=Math.min(a.length,n);for(let s=e;s<t;s++){const e=s+1,t=a[s];l+=`${String(e).padStart(String(n).length," ")} ${t}\n`}l+=" ".repeat(String(n).length+o)+"^\n";const r=s.match(/Unexpected (.+?) token: "(.+?)"/);r&&(l+=`Unexpected ${r[1]} token: "${r[2]}". `);const i=s.match(/Instead, I was expecting to see one of the following:([\s\S]*)/);if(i){l+="Instead, I was expecting to see one of the following:\n";const e=i[1].trim(),t=e.split("\n").slice(0,10);for(const e of t)e.trim()&&(l+="\n"+e);e.split("\n").length>10&&(l+="\n... and more")}}else l=s;return(s.includes("Unexpected identifier")||s.includes("Unexpected /"))&&n>0&&a[n-1]&&a[n-1].includes("match(")?i='This appears to be a regex pattern containing HTML tags (e.g., </a>). The parser may be interpreting "</" as operators. Try escaping the forward slash in closing tags: "<\\/a>" instead of "</a>".':s.includes("Unexpected ) token")||s.includes("Unexpected }")?i="Check for missing commas between object properties, or a missing closing brace/bracket earlier in the code.":s.includes("Unexpected NL token")&&s.includes("=>")?i='Arrow functions with newlines require braces. Change "=> \\n expression" to either "=> expression" (single line) or "=> { return expression }" (with braces).':s.includes("Unexpected NL token")&&s.includes("ArrowBody")?i="Multi-line arrow function bodies must use braces. Wrap your expression in { return ... }":s.includes("Unexpected identifier")?i="Check for missing operators, commas, or semicolons between statements.":(s.includes("|>")||s.includes("->"))&&(i="Pipeline operators must be followed by a valid expression or function call."),{valid:!1,error:{message:l,line:n,column:o,suggestion:i}}}checkSyntaxPatterns(e){return{hasMultilineArrows:/=>\s*\n\s*[^{]/.test(e),hasPipelines:/\|>|->/.test(e),hasAsyncAwait:/\basync\b|\bawait\b/.test(e),hasClasses:/\bclass\b/.test(e),hasModules:/\bimport\b|\bexport\b/.test(e)}}suggestFixes(e){const t=[];return this.checkSyntaxPatterns(e).hasMultilineArrows&&t.push("Found multi-line arrow functions without braces. Consider using braces for multi-line arrow function bodies."),/\)\s*\n\s*{/.test(e)&&!/"function"/.test(e)&&t.push("Found newline between closing parenthesis and opening brace. This might cause parsing issues in some contexts."),/,\s*}/.test(e)&&t.push("Found trailing comma before closing brace. While valid in JavaScript, ensure Wang supports this."),t}}const N=new C;e.CircularDependencyError=class extends r{constructor(e){super(`Circular dependency detected:\n   ${e.join(" ‚Üí ")} ‚Üí ${e[0]}`,{type:"ModuleError",suggestions:["Move shared code to a separate module","Use dynamic imports for one direction","Refactor to remove the circular dependency"]})}},e.FunctionNotFoundError=class extends r{constructor(e,t){const s=[],r=t.filter(t=>t.includes(e)||e.includes(t)).slice(0,5);r.length>0&&s.push(`Available similar functions: ${r.join(", ")}`),s.push("Check the function name spelling"),s.push("Ensure the function is imported or defined"),s.push(`Available functions: ${t.slice(0,10).join(", ")}...`),super(`Function "${e}" is not defined`,{type:"RuntimeError",suggestions:s})}},e.InMemoryModuleResolver=i,e.ModuleNotFoundError=n,e.ModuleResolver=t,e.PausableWangInterpreter=S,e.TypeMismatchError=o,e.UndefinedVariableError=a,e.VERSION="0.1.0",e.WangError=r,e.WangInterpreter=$,e.WangValidator=C,e.createInterpreter=function(e){return new $(e)},e.validator=N});
//# sourceMappingURL=wang.min.js.map
