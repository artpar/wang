<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wang Playground - Interactive IDE</title>
    <meta name="description" content="Interactive Wang language playground with professional IDE features">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        'mono': ['JetBrains Mono', 'Monaco', 'Consolas', 'monospace'],
                    }
                }
            }
        }
    </script>
    
    <!-- Monaco Editor -->
    <link rel="stylesheet" data-name="vs/editor/editor.main" href="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/editor/editor.main.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        
        /* Monaco overrides for dark mode */
        .dark .monaco-editor,
        .dark .monaco-editor-background,
        .dark .monaco-editor .inputarea.ime-input {
            background-color: #111827 !important;
        }
        
        /* Glassmorphism effect */
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .dark .glass {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Animations */
        @keyframes slideIn {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        /* Panel resize handle */
        .resize-handle {
            position: relative;
            cursor: col-resize;
            user-select: none;
        }
        
        .resize-handle::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 3px;
            height: 30px;
            background: currentColor;
            border-radius: 3px;
            opacity: 0.3;
            transition: opacity 0.2s;
        }
        
        .resize-handle:hover::after {
            opacity: 0.6;
        }
    </style>
</head>
<body class="h-full bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 font-sans overflow-hidden">
    <!-- Main Container -->
    <div class="h-full flex flex-col">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-4 py-2 flex items-center justify-between flex-shrink-0">
            <div class="flex items-center gap-3">
                <div class="text-emerald-500 dark:text-emerald-400">
                    <i class="fas fa-code text-xl"></i>
                </div>
                <h1 class="text-lg font-semibold">Wang Playground</h1>
                <span class="text-xs px-2 py-1 bg-emerald-100 dark:bg-emerald-900 text-emerald-700 dark:text-emerald-300 rounded-full">v0.14</span>
            </div>
            
            <div class="flex items-center gap-2">
                <!-- Run Button -->
                <button id="run-btn" class="px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg flex items-center gap-2 transition-colors">
                    <i class="fas fa-play text-sm"></i>
                    <span class="hidden sm:inline">Run</span>
                    <kbd class="hidden md:inline text-xs bg-emerald-600 px-1 py-0.5 rounded">Ctrl+Enter</kbd>
                </button>
                
                <!-- Validate Button -->
                <button id="validate-btn" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg flex items-center gap-2 transition-colors">
                    <i class="fas fa-check-circle text-sm"></i>
                    <span class="hidden sm:inline">Validate</span>
                </button>
                
                <!-- Examples Dropdown -->
                <div class="relative">
                    <button id="examples-btn" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg flex items-center gap-2 transition-colors">
                        <i class="fas fa-book text-sm"></i>
                        <span class="hidden sm:inline">Examples</span>
                        <i class="fas fa-chevron-down text-xs"></i>
                    </button>
                    <div id="examples-menu" class="absolute right-0 mt-2 w-64 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 hidden z-50">
                        <div class="p-2">
                            <button data-example="hello" class="w-full text-left px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors">
                                <div class="font-medium text-sm">Hello World</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">Basic Wang syntax</div>
                            </button>
                            <button data-example="pipeline" class="w-full text-left px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors">
                                <div class="font-medium text-sm">Pipeline Operations</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">Using |> and -> operators</div>
                            </button>
                            <button data-example="async" class="w-full text-left px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors">
                                <div class="font-medium text-sm">Async/Await</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">Asynchronous operations</div>
                            </button>
                            <button data-example="class" class="w-full text-left px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors">
                                <div class="font-medium text-sm">Classes</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">OOP with inheritance</div>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Separator -->
                <div class="w-px h-8 bg-gray-300 dark:bg-gray-600"></div>
                
                <!-- Share Button -->
                <button id="share-btn" class="p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg transition-colors">
                    <i class="fas fa-share-nodes"></i>
                </button>
                
                <!-- Settings Button -->
                <button id="settings-btn" class="p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg transition-colors">
                    <i class="fas fa-cog"></i>
                </button>
                
                <!-- Theme Toggle -->
                <button id="theme-btn" class="p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg transition-colors">
                    <i class="fas fa-moon dark:hidden"></i>
                    <i class="fas fa-sun hidden dark:inline"></i>
                </button>
                
                <!-- GitHub Link -->
                <a href="https://github.com/artpar/wang" target="_blank" class="p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg transition-colors">
                    <i class="fab fa-github"></i>
                </a>
            </div>
        </header>
        
        <!-- Main Content Area -->
        <div class="flex-1 flex overflow-hidden">
            <!-- Sidebar -->
            <aside id="sidebar" class="w-12 bg-gray-100 dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex flex-col items-center py-2 gap-1 flex-shrink-0">
                <button class="sidebar-btn p-2.5 rounded hover:bg-gray-200 dark:hover:bg-gray-700 text-emerald-500" title="Editor">
                    <i class="fas fa-code"></i>
                </button>
                <button class="sidebar-btn p-2.5 rounded hover:bg-gray-200 dark:hover:bg-gray-700" title="Output">
                    <i class="fas fa-terminal"></i>
                </button>
                <button class="sidebar-btn p-2.5 rounded hover:bg-gray-200 dark:hover:bg-gray-700" title="Console">
                    <i class="fas fa-bug"></i>
                </button>
                <button class="sidebar-btn p-2.5 rounded hover:bg-gray-200 dark:hover:bg-gray-700" title="Files">
                    <i class="fas fa-folder"></i>
                </button>
                
                <div class="flex-1"></div>
                
                <button id="shortcuts-btn" class="sidebar-btn p-2.5 rounded hover:bg-gray-200 dark:hover:bg-gray-700" title="Shortcuts">
                    <i class="fas fa-keyboard"></i>
                </button>
            </aside>
            
            <!-- Editor and Output Panels -->
            <div class="flex-1 flex overflow-hidden">
                <!-- Editor Panel -->
                <div id="editor-panel" class="flex flex-col bg-white dark:bg-gray-900" style="flex: 2;">
                    <!-- Editor Header -->
                    <div class="bg-gray-50 dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-3 py-1 flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="text-sm font-medium">main.wang</span>
                            <span id="modified-indicator" class="text-xs text-orange-500 hidden">‚óè</span>
                        </div>
                        <div class="flex items-center gap-3 text-xs text-gray-500 dark:text-gray-400">
                            <span id="cursor-position">Ln 1, Col 1</span>
                            <span id="selection-info"></span>
                            <span id="exec-time" class="hidden">
                                <i class="fas fa-clock text-emerald-500"></i>
                                <span id="exec-time-value">0ms</span>
                            </span>
                        </div>
                    </div>
                    <!-- Monaco Editor Container -->
                    <div id="editor-container" class="flex-1"></div>
                </div>
                
                <!-- Resizer -->
                <div id="resizer" class="resize-handle w-1 bg-gray-200 dark:bg-gray-700 hover:bg-emerald-500 transition-colors"></div>
                
                <!-- Output Panel -->
                <div id="output-panel" class="flex flex-col bg-white dark:bg-gray-900" style="flex: 1;">
                    <!-- Output Header -->
                    <div class="bg-gray-50 dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-3 py-1 flex items-center justify-between">
                        <div class="flex gap-4">
                            <button class="tab-btn text-sm font-medium text-emerald-500 border-b-2 border-emerald-500 pb-1" data-tab="output">Output</button>
                            <button class="tab-btn text-sm font-medium text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 pb-1" data-tab="ast">AST</button>
                            <button class="tab-btn text-sm font-medium text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 pb-1" data-tab="console">Console</button>
                        </div>
                        <button id="clear-output" class="p-1 hover:bg-gray-200 dark:hover:bg-gray-700 rounded transition-colors">
                            <i class="fas fa-trash text-xs"></i>
                        </button>
                    </div>
                    <!-- Output Container -->
                    <div id="output-container" class="flex-1 overflow-y-auto p-4 font-mono text-sm">
                        <div class="text-gray-500 dark:text-gray-400">
                            <i class="fas fa-info-circle"></i> Ready. Press <kbd class="px-1 py-0.5 bg-gray-200 dark:bg-gray-700 rounded text-xs">Ctrl+Enter</kbd> to run your code.
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Status Bar -->
        <footer class="bg-gray-100 dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 px-4 py-1 flex items-center justify-between text-xs flex-shrink-0">
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-1">
                    <div id="status-indicator" class="w-2 h-2 rounded-full bg-gray-400"></div>
                    <span id="status-text">Ready</span>
                </div>
                <span class="text-gray-500 dark:text-gray-400">Wang Language</span>
            </div>
            <div class="flex items-center gap-4 text-gray-500 dark:text-gray-400">
                <span>UTF-8</span>
                <span>Spaces: 2</span>
                <span id="memory-usage"></span>
            </div>
        </footer>
    </div>
    
    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md mx-4">
            <div class="border-b border-gray-200 dark:border-gray-700 px-6 py-4">
                <h2 class="text-lg font-semibold">Settings</h2>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Font Size</label>
                    <select id="font-size" class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg">
                        <option value="12">12px</option>
                        <option value="14" selected>14px</option>
                        <option value="16">16px</option>
                        <option value="18">18px</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Tab Size</label>
                    <select id="tab-size" class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg">
                        <option value="2" selected>2 spaces</option>
                        <option value="4">4 spaces</option>
                    </select>
                </div>
                <div class="flex items-center justify-between">
                    <label class="text-sm font-medium">Word Wrap</label>
                    <button id="word-wrap" class="relative inline-flex h-6 w-11 items-center rounded-full bg-gray-300 dark:bg-gray-600 transition-colors">
                        <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-1"></span>
                    </button>
                </div>
                <div class="flex items-center justify-between">
                    <label class="text-sm font-medium">Auto Save</label>
                    <button id="auto-save" class="relative inline-flex h-6 w-11 items-center rounded-full bg-emerald-500 transition-colors">
                        <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-6"></span>
                    </button>
                </div>
                <div class="flex items-center justify-between">
                    <label class="text-sm font-medium">Clear on Run</label>
                    <button id="clear-on-run" class="relative inline-flex h-6 w-11 items-center rounded-full bg-emerald-500 transition-colors">
                        <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-6"></span>
                    </button>
                </div>
            </div>
            <div class="border-t border-gray-200 dark:border-gray-700 px-6 py-3 flex justify-end">
                <button id="close-settings" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg transition-colors">
                    Close
                </button>
            </div>
        </div>
    </div>
    
    <!-- Shortcuts Modal -->
    <div id="shortcuts-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md mx-4">
            <div class="border-b border-gray-200 dark:border-gray-700 px-6 py-4">
                <h2 class="text-lg font-semibold">Keyboard Shortcuts</h2>
            </div>
            <div class="p-6 space-y-2">
                <div class="flex justify-between items-center py-2">
                    <span class="text-sm">Run code</span>
                    <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs">Ctrl+Enter</kbd>
                </div>
                <div class="flex justify-between items-center py-2">
                    <span class="text-sm">Save to localStorage</span>
                    <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs">Ctrl+S</kbd>
                </div>
                <div class="flex justify-between items-center py-2">
                    <span class="text-sm">Toggle comment</span>
                    <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs">Ctrl+/</kbd>
                </div>
                <div class="flex justify-between items-center py-2">
                    <span class="text-sm">Find</span>
                    <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs">Ctrl+F</kbd>
                </div>
                <div class="flex justify-between items-center py-2">
                    <span class="text-sm">Replace</span>
                    <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs">Ctrl+H</kbd>
                </div>
                <div class="flex justify-between items-center py-2">
                    <span class="text-sm">Settings</span>
                    <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs">Ctrl+,</kbd>
                </div>
            </div>
            <div class="border-t border-gray-200 dark:border-gray-700 px-6 py-3 flex justify-end">
                <button id="close-shortcuts" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg transition-colors">
                    Close
                </button>
            </div>
        </div>
    </div>
    
    <!-- Load Wang Language from CDN (always latest) -->
    <script type="module">
        // Always load from unpkg CDN to get the latest published version
        import('https://unpkg.com/wang-lang@latest/dist/browser/wang.min.js')
            .then(module => {
                window.Wang = module;
                console.log('Wang loaded successfully from CDN:', module);
            })
            .catch(error => {
                console.error('Failed to load Wang from CDN:', error);
                // Try jsdelivr as fallback
                return import('https://cdn.jsdelivr.net/npm/wang-lang@latest/dist/browser/wang.min.js');
            })
            .then(module => {
                if (module) {
                    window.Wang = module;
                    console.log('Wang loaded from jsdelivr CDN');
                }
            })
            .catch(error => {
                console.error('Failed to load Wang from any CDN:', error);
                document.body.innerHTML = '<div style="color: red; padding: 20px; text-align: center;">Error: Failed to load Wang library from CDN. Please check your internet connection and refresh the page.</div>' + document.body.innerHTML;
            });
    </script>
    
    <!-- Load Monaco Editor -->
    <script>
        var require = { paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' } };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/editor/editor.main.nls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/editor/editor.main.js"></script>
    
    <!-- Application Script -->
    <script>
        // Initialize when everything is loaded
        function initializeApp() {
            if (typeof window.Wang === 'undefined' || typeof monaco === 'undefined') {
                console.log('Waiting for dependencies...', { Wang: typeof window.Wang, monaco: typeof monaco });
                setTimeout(initializeApp, 100);
                return;
            }
            
            console.log('Initializing app with Wang:', window.Wang);
            
            // Theme management
            const theme = localStorage.getItem('theme') || 'dark';
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            }
            
            // Register Wang language
            monaco.languages.register({ id: 'wang' });
            monaco.languages.setMonarchTokensProvider('wang', {
                keywords: ['let', 'const', 'var', 'function', 'async', 'await', 'if', 'else', 'for', 'while', 'do', 'break', 'continue', 'return', 'class', 'extends', 'new', 'this', 'super', 'import', 'export', 'from', 'try', 'catch', 'finally', 'throw', 'typeof', 'instanceof', 'true', 'false', 'null', 'undefined'],
                operators: ['=', '>', '<', '!', '~', '?', ':', '==', '<=', '>=', '!=', '&&', '||', '++', '--', '+', '-', '*', '/', '&', '|', '^', '%', '<<', '>>', '>>>', '+=', '-=', '*=', '/=', '&=', '|=', '^=', '%=', '<<=', '>>=', '>>>=', '=>', '|>', '->'],
                tokenizer: {
                    root: [
                        [/\/\/.*$/, 'comment'],
                        [/\/\*/, 'comment', '@comment'],
                        [/\b(let|const|var|function|async|await|if|else|for|while|do|break|continue|return|class|extends|new|this|super|import|export|from|try|catch|finally|throw|typeof|instanceof|true|false|null|undefined)\b/, 'keyword'],
                        [/\b\d+(\.\d+)?\b/, 'number'],
                        [/"([^"\\]|\\.)*$/, 'string.invalid'],
                        [/'([^'\\]|\\.)*$/, 'string.invalid'],
                        [/"/, 'string', '@string_double'],
                        [/'/, 'string', '@string_single'],
                        [/`/, 'string', '@string_backtick'],
                        [/[=><!~?:&|+\-*\/\^%]+/, 'operator'],
                        [/[a-zA-Z_$][a-zA-Z0-9_$]*/, 'identifier'],
                        [/[ \t\r\n]+/, 'white'],
                        [/[{}()\[\]]/, '@brackets'],
                        [/[;,.]/, 'delimiter']
                    ],
                    comment: [
                        [/[^\/*]+/, 'comment'],
                        [/\*\//, 'comment', '@pop'],
                        [/[\/*]/, 'comment']
                    ],
                    string_double: [
                        [/[^\\"]+/, 'string'],
                        [/\\./, 'string.escape'],
                        [/"/, 'string', '@pop']
                    ],
                    string_single: [
                        [/[^\\']+/, 'string'],
                        [/\\./, 'string.escape'],
                        [/'/, 'string', '@pop']
                    ],
                    string_backtick: [
                        [/[^\\`$]+/, 'string'],
                        [/\\./, 'string.escape'],
                        [/\$\{/, 'delimiter', '@interpolation'],
                        [/`/, 'string', '@pop']
                    ],
                    interpolation: [
                        [/\}/, 'delimiter', '@pop'],
                        { include: 'root' }
                    ]
                }
            });
            
            // Create Monaco editor
            const editor = monaco.editor.create(document.getElementById('editor-container'), {
                value: localStorage.getItem('wang-code') || `// Welcome to Wang Playground!
// Wang is a modern workflow language with pipeline operators

let message = "Hello, Wang!"
log(message)

// Pipeline example
let numbers = [1, 2, 3, 4, 5]
let result = numbers 
    |> filter(_, x => x > 2)
    |> map(_, x => x * 2)
log("Result:", result)

// Try pressing Ctrl+Enter to run!`,
                language: 'wang',
                theme: theme === 'dark' ? 'vs-dark' : 'vs',
                fontSize: 14,
                minimap: { enabled: false },
                automaticLayout: true,
                lineNumbers: 'on',
                scrollBeyondLastLine: false,
                wordWrap: 'off',
                tabSize: 2,
                insertSpaces: true,
                folding: true,
                bracketPairColorization: { enabled: true }
            });
            
            // Helper functions (define early for error messages)
            function addOutput(type, message) {
                const container = document.getElementById('output-container');
                const entry = document.createElement('div');
                entry.className = `mb-2 p-2 rounded ${
                    type === 'error' ? 'bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300' :
                    type === 'warning' ? 'bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300' :
                    type === 'success' ? 'bg-emerald-100 dark:bg-emerald-900 text-emerald-700 dark:text-emerald-300' :
                    'bg-gray-100 dark:bg-gray-800'
                }`;
                
                const timestamp = new Date().toLocaleTimeString();
                entry.innerHTML = `
                    <div class="text-xs opacity-75 mb-1">${timestamp}</div>
                    <div class="whitespace-pre-wrap break-words">${message}</div>
                `;
                container.appendChild(entry);
                container.scrollTop = container.scrollHeight;
            }
            
            // Initialize Wang interpreter
            const { WangInterpreter, InMemoryModuleResolver, WangValidator } = window.Wang;
            
            if (!WangInterpreter || !InMemoryModuleResolver || !WangValidator) {
                console.error('Wang components not found:', window.Wang);
                addOutput('error', 'Failed to initialize Wang components. Please refresh the page.');
                return;
            }
            const resolver = new InMemoryModuleResolver();
            
            const interpreter = new WangInterpreter({
                moduleResolver: resolver,
                functions: {
                    log: (...args) => {
                        addOutput('log', args.map(a => typeof a === 'object' ? JSON.stringify(a, null, 2) : String(a)).join(' '));
                    },
                    error: (...args) => {
                        addOutput('error', args.join(' '));
                    },
                    warn: (...args) => {
                        addOutput('warning', args.join(' '));
                    },
                    clear: () => {
                        clearOutput();
                    },
                    now: () => Date.now(),
                    filter: (arr, fn) => arr.filter(fn),
                    map: (arr, fn) => arr.map(fn),
                    reduce: (arr, fn, init) => arr.reduce(fn, init)
                }
            });
            
            // Set built-in objects
            interpreter.setVariable('Math', Math);
            interpreter.setVariable('JSON', JSON);
            interpreter.setVariable('Date', Date);
            interpreter.setVariable('console', {
                log: (...args) => addOutput('log', args.join(' ')),
                error: (...args) => addOutput('error', args.join(' ')),
                warn: (...args) => addOutput('warning', args.join(' '))
            });
            
            const validator = new WangValidator();
            
            function clearOutput() {
                document.getElementById('output-container').innerHTML = '';
            }
            
            function updateStatus(state, text) {
                const indicator = document.getElementById('status-indicator');
                const statusText = document.getElementById('status-text');
                
                indicator.className = `w-2 h-2 rounded-full ${
                    state === 'running' ? 'bg-yellow-500 animate-pulse' :
                    state === 'success' ? 'bg-emerald-500' :
                    state === 'error' ? 'bg-red-500' :
                    'bg-gray-400'
                }`;
                statusText.textContent = text;
            }
            
            // Run code
            async function runCode() {
                const code = editor.getValue();
                
                if (document.getElementById('clear-on-run').classList.contains('bg-emerald-500')) {
                    clearOutput();
                }
                
                const startTime = performance.now();
                updateStatus('running', 'Running...');
                document.getElementById('exec-time').classList.remove('hidden');
                
                try {
                    const result = await interpreter.execute(code);
                    
                    const executionTime = Math.round(performance.now() - startTime);
                    document.getElementById('exec-time-value').textContent = `${executionTime}ms`;
                    
                    if (result !== undefined && result !== null) {
                        addOutput('success', `Result: ${typeof result === 'object' ? JSON.stringify(result, null, 2) : result}`);
                    }
                    
                    updateStatus('success', 'Success');
                } catch (error) {
                    addOutput('error', error.message || error.toString());
                    updateStatus('error', 'Error');
                }
            }
            
            // Validate code
            function validateCode() {
                const code = editor.getValue();
                const result = validator.validate(code, { includeAST: true });
                
                if (result.valid) {
                    addOutput('success', '‚úÖ Valid Wang code');
                    if (result.ast) {
                        addOutput('log', 'AST: ' + JSON.stringify(result.ast, null, 2));
                    }
                } else {
                    addOutput('error', `‚ùå ${result.error.message}`);
                    if (result.error.suggestion) {
                        addOutput('warning', `üí° ${result.error.suggestion}`);
                    }
                }
            }
            
            // Examples
            const examples = {
                hello: `// Hello World in Wang
let greeting = "Hello, Wang Language!"
log(greeting)

// String interpolation
let name = "Developer"
let message = \`Welcome, \${name}!\`
log(message)`,
                
                pipeline: `// Pipeline operators in Wang
let data = [1, 2, 3, 4, 5]

// Using the pipe operator |>
let doubled = data |> map(_, x => x * 2)
log("Doubled:", doubled)

// Chain operations
let result = data 
    |> filter(_, x => x > 2)
    |> map(_, x => x * 3)
log("Result:", result)`,
                
                async: `// Async/Await in Wang
async function fetchData() {
    log("Starting async operation...")
    await new Promise(resolve => setTimeout(resolve, 1000))
    return { status: "success", data: [1, 2, 3] }
}

let result = await fetchData()
log("Result:", result)`,
                
                class: `// Classes in Wang
class Animal {
    constructor(name) {
        this.name = name
    }
    
    speak() {
        log(\`\${this.name} makes a sound\`)
    }
}

class Dog extends Animal {
    constructor(name, breed) {
        super(name)
        this.breed = breed
    }
    
    speak() {
        log(\`\${this.name} the \${this.breed} barks!\`)
    }
}

let pet = new Dog("Max", "Golden Retriever")
pet.speak()`
            };
            
            // Event listeners
            document.getElementById('run-btn').addEventListener('click', runCode);
            document.getElementById('validate-btn').addEventListener('click', validateCode);
            document.getElementById('clear-output').addEventListener('click', clearOutput);
            
            // Examples
            document.getElementById('examples-btn').addEventListener('click', () => {
                document.getElementById('examples-menu').classList.toggle('hidden');
            });
            
            document.querySelectorAll('[data-example]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const example = examples[btn.dataset.example];
                    if (example) {
                        editor.setValue(example);
                        document.getElementById('examples-menu').classList.add('hidden');
                    }
                });
            });
            
            // Theme toggle
            document.getElementById('theme-btn').addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                const isDark = document.documentElement.classList.contains('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                monaco.editor.setTheme(isDark ? 'vs-dark' : 'vs');
            });
            
            // Settings
            document.getElementById('settings-btn').addEventListener('click', () => {
                document.getElementById('settings-modal').classList.remove('hidden');
                document.getElementById('settings-modal').classList.add('flex');
            });
            
            document.getElementById('close-settings').addEventListener('click', () => {
                document.getElementById('settings-modal').classList.add('hidden');
                document.getElementById('settings-modal').classList.remove('flex');
            });
            
            // Shortcuts modal
            document.getElementById('shortcuts-btn').addEventListener('click', () => {
                document.getElementById('shortcuts-modal').classList.remove('hidden');
                document.getElementById('shortcuts-modal').classList.add('flex');
            });
            
            document.getElementById('close-shortcuts').addEventListener('click', () => {
                document.getElementById('shortcuts-modal').classList.add('hidden');
                document.getElementById('shortcuts-modal').classList.remove('flex');
            });
            
            // Toggle switches
            document.querySelectorAll('#word-wrap, #auto-save, #clear-on-run').forEach(toggle => {
                toggle.addEventListener('click', () => {
                    const isOn = toggle.classList.contains('bg-emerald-500');
                    if (isOn) {
                        toggle.classList.remove('bg-emerald-500');
                        toggle.classList.add('bg-gray-300', 'dark:bg-gray-600');
                        toggle.querySelector('span').style.transform = 'translateX(0.25rem)';
                    } else {
                        toggle.classList.add('bg-emerald-500');
                        toggle.classList.remove('bg-gray-300', 'dark:bg-gray-600');
                        toggle.querySelector('span').style.transform = 'translateX(1.5rem)';
                    }
                    
                    if (toggle.id === 'word-wrap') {
                        editor.updateOptions({ wordWrap: !isOn ? 'on' : 'off' });
                    }
                });
            });
            
            // Share functionality
            document.getElementById('share-btn').addEventListener('click', () => {
                const code = editor.getValue();
                const encoded = btoa(encodeURIComponent(code));
                const url = `${window.location.origin}${window.location.pathname}#code=${encoded}`;
                
                navigator.clipboard.writeText(url).then(() => {
                    addOutput('success', 'Share URL copied to clipboard!');
                });
            });
            
            // Panel resizing
            const resizer = document.getElementById('resizer');
            const editorPanel = document.getElementById('editor-panel');
            const outputPanel = document.getElementById('output-panel');
            let isResizing = false;
            
            resizer.addEventListener('mousedown', (e) => {
                isResizing = true;
                document.body.style.cursor = 'col-resize';
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                
                const container = editorPanel.parentElement;
                const containerWidth = container.offsetWidth;
                const pointerRelativeXpos = e.clientX - container.offsetLeft;
                const editorWidth = Math.max(200, Math.min(containerWidth - 200, pointerRelativeXpos));
                
                editorPanel.style.flex = `0 0 ${editorWidth}px`;
                outputPanel.style.flex = '1';
            });
            
            document.addEventListener('mouseup', () => {
                isResizing = false;
                document.body.style.cursor = '';
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    runCode();
                }
                
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    localStorage.setItem('wang-code', editor.getValue());
                    addOutput('success', 'Code saved to localStorage');
                }
                
                if ((e.ctrlKey || e.metaKey) && e.key === ',') {
                    e.preventDefault();
                    document.getElementById('settings-btn').click();
                }
                
                if (e.key === 'Escape') {
                    document.getElementById('settings-modal').classList.add('hidden');
                    document.getElementById('shortcuts-modal').classList.add('hidden');
                    document.getElementById('examples-menu').classList.add('hidden');
                }
            });
            
            // Auto-save
            editor.onDidChangeModelContent(() => {
                document.getElementById('modified-indicator').classList.remove('hidden');
                if (document.getElementById('auto-save').classList.contains('bg-emerald-500')) {
                    localStorage.setItem('wang-code', editor.getValue());
                    setTimeout(() => {
                        document.getElementById('modified-indicator').classList.add('hidden');
                    }, 1000);
                }
            });
            
            // Update cursor position
            editor.onDidChangeCursorPosition((e) => {
                document.getElementById('cursor-position').textContent = `Ln ${e.position.lineNumber}, Col ${e.position.column}`;
            });
            
            // Update selection info
            editor.onDidChangeCursorSelection((e) => {
                const selection = e.selection;
                const model = editor.getModel();
                const selectedText = model.getValueInRange(selection);
                
                if (selectedText.length > 0) {
                    document.getElementById('selection-info').textContent = `${selectedText.length} chars selected`;
                } else {
                    document.getElementById('selection-info').textContent = '';
                }
            });
            
            // Load shared code
            if (window.location.hash.startsWith('#code=')) {
                try {
                    const encoded = window.location.hash.slice(6);
                    const code = decodeURIComponent(atob(encoded));
                    editor.setValue(code);
                } catch (e) {
                    console.error('Failed to load shared code:', e);
                }
            }
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#examples-btn') && !e.target.closest('#examples-menu')) {
                    document.getElementById('examples-menu').classList.add('hidden');
                }
            });
        }
        
        // Start initialization
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
</body>
</html>