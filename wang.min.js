!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Wang={})}(this,function(e){"use strict";class t{}function s(e,t=".wang"){return e.endsWith(t)||e.includes(".")?e:e+t}class n extends Error{constructor(e,t={type:"RuntimeError"},s){super(e),this.name="WangError",this.context=t,this.originalError=s,Error.captureStackTrace&&Error.captureStackTrace(this,n)}toString(){return this.message}getFormattedMessage(e){let t=this.message;return this.context.suggestions&&this.context.suggestions.length>0&&(t+="\n\n💡 Suggestions:\n",this.context.suggestions.forEach((e,s)=>{t+=`   ${s+1}. ${e}\n`})),this.context.variables&&Object.keys(this.context.variables).length>0&&(t+="\n\n📊 Variables in scope:\n",Object.entries(this.context.variables).forEach(([e,s])=>{const n=this.formatValue(s);t+=`   • ${e}: ${n}\n`})),this.context.stackTrace&&this.context.stackTrace.length>0&&(t+="\n\n📍 Stack trace:\n",this.context.stackTrace.forEach(e=>{t+=`   ${e}\n`})),t}formatValue(e){return null===e?"null":void 0===e?"undefined":"string"==typeof e?`"${e}"`:"number"==typeof e||"boolean"==typeof e?String(e):Array.isArray(e)?`[array of ${e.length} items]`:"object"==typeof e?`{${Object.keys(e).join(", ")}}`:typeof e}}class r extends n{constructor(e,t=[]){const s=[];if(t.length>0){const n=t.filter(t=>t.includes(e.split("/").pop()||"")).slice(0,3);n.length>0&&s.push(`Did you mean one of these? ${n.join(", ")}`)}s.push("Check that the module path is correct"),s.push("Ensure the module has been added to the resolver"),super(`Module not found: "${e}"`,{type:"ModuleError",suggestions:s})}}class o extends n{constructor(e,t,s){const n=typeof t;let r="undefined";try{r=void 0===t?"undefined":null===t?"null":JSON.stringify(t).substring(0,50)}catch(e){r=String(t).substring(0,50)}super(`Type mismatch in ${s}:\n   Expected: ${e}\n   Received: ${n} (${r})`,{type:"RuntimeError",suggestions:[`Check that the value is of type ${e}`,"Use type conversion if necessary","Verify the data source"]})}}class a extends n{constructor(e,t){const s=[],n=t.filter(t=>t.includes(e)||e.includes(t)).slice(0,3);n.length>0&&s.push(`Did you mean: ${n.join(", ")}?`),s.push("Check for typos in the variable name"),s.push("Ensure the variable is declared before use"),super(`Variable "${e}" is not defined`,{type:"RuntimeError",suggestions:s,variables:Object.fromEntries(t.slice(0,10).map(e=>[e,"..."]))})}}class i extends t{constructor(){super(),this.modules=new Map,this.metadata=new Map}addModule(e,t,n){const r=s(e);return this.modules.set(r,t),n&&this.metadata.set(r,n),this}addModules(e){return Object.entries(e).forEach(([e,t])=>{this.addModule(e,t)}),this}removeModule(e){const t=s(e);return this.metadata.delete(t),this.modules.delete(t)}async resolve(e,t){const n=function(e,t){return t&&e.startsWith(".")?function(e){const t=e.split("/"),s=[];for(const e of t)".."===e?s.pop():e&&"."!==e&&s.push(e);return s.join("/")}(t.split("/").slice(0,-1).join("/")+"/"+e):e}(e,t),o=s(n);if(this.modules.has(o))return{code:this.modules.get(o),path:o,metadata:this.metadata.get(o)};if(this.modules.has(n))return{code:this.modules.get(n),path:n,metadata:this.metadata.get(n)};const a=s(n+"/index");if(this.modules.has(a))return{code:this.modules.get(a),path:a,metadata:this.metadata.get(a)};const i=await this.list();throw new r(e,i)}async exists(e,t){try{return await this.resolve(e,t),!0}catch{return!1}}async list(e){const t=Array.from(this.modules.keys());return e?t.filter(t=>t.startsWith(e)):t}clearCache(){this.modules.clear(),this.metadata.clear()}async getMetadata(e){const t=s(e);return this.metadata.get(t)||null}get size(){return this.modules.size}get isEmpty(){return 0===this.modules.size}exportModules(){const e={};return this.modules.forEach((t,s)=>{e[s]={code:t,metadata:this.metadata.get(s)}}),e}importModules(e){return Object.entries(e).forEach(([e,{code:t,metadata:s}])=>{this.modules.set(e,t),s&&this.metadata.set(e,s)}),this}}function l(e){const t=[...e];for(let e=t.length-1;e>0;e--){const s=Math.floor(Math.random()*(e+1));[t[e],t[s]]=[t[s],t[e]]}return t}function c(e){return e.reduce((e,t)=>e+t,0)}function p(e){return new Promise(t=>setTimeout(t,e))}const u={sort_by:function(e,t){const s=[...e];if(!t)return s.sort();const n="string"==typeof t?e=>e?.[t]:t;return s.sort((e,t)=>{const s=n(e),r=n(t);return s<r?-1:s>r?1:0})},reverse:function(e){return[...e].reverse()},unique:function(e){return[...new Set(e)]},unique_by:function(e,t){const s="string"==typeof t?e=>e?.[t]:t,n=new Set,r=[];for(const t of e){const e=s(t);n.has(e)||(n.add(e),r.push(t))}return r},group_by:function(e,t){const s="string"==typeof t?e=>e?.[t]:t,n={};for(const t of e){const e=String(s(t));n[e]||(n[e]=[]),n[e].push(t)}return n},chunk:function(e,t=1){const s=[];for(let n=0;n<e.length;n+=t)s.push(e.slice(n,n+t));return s},flatten:function e(t,s=1){return s<=0?[...t]:t.reduce((t,n)=>Array.isArray(n)?t.concat(e(n,s-1)):t.concat(n),[])},first:function(e,t=1){return 1===t?e[0]:e.slice(0,t)},last:function(e,t=1){return 1===t?e[e.length-1]:e.slice(-t)},take:function(e,t){return e.slice(0,t)},drop:function(e,t){return e.slice(t)},shuffle:l,sample:function(e,t=1){const s=l(e);return 1===t?s[0]:s.slice(0,t)},zip:function(...e){const t=Math.min(...e.map(e=>e.length)),s=[];for(let n=0;n<t;n++)s.push(e.map(e=>e[n]));return s},partition:function(e,t){const s=[],n=[];for(const r of e)(t(r)?s:n).push(r);return[s,n]},keys:function(e){return Object.keys(e||{})},values:function(e){return Object.values(e||{})},entries:function(e){return Object.entries(e||{})},pick:function(e,t){const s={};for(const n of t)n in e&&(s[n]=e[n]);return s},omit:function(e,t){const s={...e};for(const e of t)delete s[e];return s},merge:function(...e){return Object.assign({},...e)},get:function(e,t,s){if("number"==typeof t){const n=e?.[t];return void 0===n?s:n}const n=String(t).split(".");let r=e;for(const e of n){if(null==r)return s;r=r[e]}return void 0===r?s:r},set:function(e,t,s){const n=t.split("."),r={...e};let o=r;for(let e=0;e<n.length-1;e++){const t=n[e];t in o&&"object"==typeof o[t]||(o[t]={}),o[t]={...o[t]},o=o[t]}return o[n[n.length-1]]=s,r},clone:function e(t){if(null===t||"object"!=typeof t)return t;if(t instanceof Date)return new Date(t.getTime());if(Array.isArray(t))return t.map(t=>e(t));const s={};for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&(s[n]=e(t[n]));return s},split:function(e,t=""){return e.split(t)},join:function(e,t=","){return e.join(t)},trim:function(e){return e.trim()},trim_start:function(e){return e.trimStart()},trim_end:function(e){return e.trimEnd()},replace_all:function(e,t,s){return e.split(t).join(s)},upper:function(e){return e.toUpperCase()},lower:function(e){return e.toLowerCase()},capitalize:function(e){return e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()},starts_with:function(e,t){return e.startsWith(t)},ends_with:function(e,t){return e.endsWith(t)},includes:function(e,t){return e.includes(t)},pad_start:function(e,t,s=" "){return e.padStart(t,s)},pad_end:function(e,t,s=" "){return e.padEnd(t,s)},truncate:function(e,t,s="..."){return e.length<=t?e:e.slice(0,t-s.length)+s},map:async function(e,t){const s=[];for(let n=0;n<e.length;n++)s.push(await t(e[n],n));return s},filter:async function(e,t){const s=[];for(let n=0;n<e.length;n++)await t(e[n],n)&&s.push(e[n]);return s},reduce:async function(e,t,s){let n=arguments.length>2?s:e[0];for(let s=arguments.length>2?0:1;s<e.length;s++)n=await t(n,e[s],s);return n},find:async function(e,t){for(let s=0;s<e.length;s++)if(await t(e[s],s))return e[s]},find_index:async function(e,t){for(let s=0;s<e.length;s++)if(await t(e[s],s))return s;return-1},every:async function(e,t){for(let s=0;s<e.length;s++)if(!await t(e[s],s))return!1;return!0},some:async function(e,t){for(let s=0;s<e.length;s++)if(await t(e[s],s))return!0;return!1},count:async function(e,t){if(!t)return e.length;let s=0;for(const n of e)await t(n)&&s++;return s},is_array:function(e){return Array.isArray(e)},is_object:function(e){return null!==e&&"object"==typeof e&&!Array.isArray(e)},is_string:function(e){return"string"==typeof e},is_number:function(e){return"number"==typeof e&&!isNaN(e)},is_boolean:function(e){return"boolean"==typeof e},is_function:function(e){return"function"==typeof e},is_null:function(e){return null===e},is_empty:function(e){return null==e||(Array.isArray(e)||"string"==typeof e?0===e.length:"object"==typeof e&&0===Object.keys(e).length)},min:function(e){return 0===e.length?1/0:Math.min(...e)},max:function(e){return 0===e.length?-1/0:Math.max(...e)},sum:c,avg:function(e){return 0===e.length?0:c(e)/e.length},median:function(e){if(0===e.length)return 0;const t=[...e].sort((e,t)=>e-t),s=Math.floor(t.length/2);return t.length%2==0?(t[s-1]+t[s])/2:t[s]},round:function(e,t=0){const s=Math.pow(10,t);return Math.round(e*s)/s},floor:function(e){return Math.floor(e)},ceil:function(e){return Math.ceil(e)},abs:function(e){return Math.abs(e)},clamp:function(e,t,s){return Math.min(Math.max(e,t),s)},range:function(e,t,s=1){void 0===t&&(t=e,e=0);const n=[];if(s>0)for(let r=e;r<t;r+=s)n.push(r);else if(s<0)for(let r=e;r>t;r+=s)n.push(r);return n},sleep:p,wait:function(e){return p(e)},uuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})},to_json:function(e,t=!1){return t?JSON.stringify(e,null,2):JSON.stringify(e)},from_json:function(e){return JSON.parse(e)},to_base64:function(e){return"undefined"!=typeof btoa?btoa(e):Buffer.from(e,"utf8").toString("base64")},from_base64:function(e){return"undefined"!=typeof atob?atob(e):Buffer.from(e,"base64").toString("utf8")}},m=function(){function e(t,s,n){return this.id=++e.highestId,this.name=t,this.symbols=s,this.postprocess=n,this}function t(e,t,s,n){this.rule=e,this.dot=t,this.reference=s,this.data=[],this.wantedBy=n,this.isComplete=this.dot===e.symbols.length}function s(e,t){this.grammar=e,this.index=t,this.states=[],this.wants={},this.scannable=[],this.completed={}}function n(e,t){this.rules=e,this.start=t||this.rules[0].name;var s=this.byName={};this.rules.forEach(function(e){s.hasOwnProperty(e.name)||(s[e.name]=[]),s[e.name].push(e)})}function r(){this.reset("")}function o(e,t,o){if(e instanceof n){var a=e;o=t}else a=n.fromCompiled(e,t);for(var i in this.grammar=a,this.options={keepHistory:!1,lexer:a.lexer||new r},o||{})this.options[i]=o[i];this.lexer=this.options.lexer,this.lexerState=void 0;var l=new s(a,0);this.table=[l],l.wants[a.start]=[],l.predict(a.start),l.process(),this.current=0}function a(e){var t=typeof e;if("string"===t)return e;if("object"===t){if(e.literal)return JSON.stringify(e.literal);if(e instanceof RegExp)return e.toString();if(e.type)return"%"+e.type;if(e.test)return"<"+String(e.test)+">";throw new Error("Unknown symbol type: "+e)}}return e.highestId=0,e.prototype.toString=function(e){var t=void 0===e?this.symbols.map(a).join(" "):this.symbols.slice(0,e).map(a).join(" ")+" ● "+this.symbols.slice(e).map(a).join(" ");return this.name+" → "+t},t.prototype.toString=function(){return"{"+this.rule.toString(this.dot)+"}, from: "+(this.reference||0)},t.prototype.nextState=function(e){var s=new t(this.rule,this.dot+1,this.reference,this.wantedBy);return s.left=this,s.right=e,s.isComplete&&(s.data=s.build(),s.right=void 0),s},t.prototype.build=function(){var e=[],t=this;do{e.push(t.right.data),t=t.left}while(t.left);return e.reverse(),e},t.prototype.finish=function(){this.rule.postprocess&&(this.data=this.rule.postprocess(this.data,this.reference,o.fail))},s.prototype.process=function(e){for(var t=this.states,s=this.wants,n=this.completed,r=0;r<t.length;r++){var a=t[r];if(a.isComplete){if(a.finish(),a.data!==o.fail){for(var i=a.wantedBy,l=i.length;l--;){var c=i[l];this.complete(c,a)}if(a.reference===this.index){var p=a.rule.name;(this.completed[p]=this.completed[p]||[]).push(a)}}}else{if("string"!=typeof(p=a.rule.symbols[a.dot])){this.scannable.push(a);continue}if(s[p]){if(s[p].push(a),n.hasOwnProperty(p)){var u=n[p];for(l=0;l<u.length;l++){var m=u[l];this.complete(a,m)}}}else s[p]=[a],this.predict(p)}}},s.prototype.predict=function(e){for(var s=this.grammar.byName[e]||[],n=0;n<s.length;n++){var r=s[n],o=this.wants[e],a=new t(r,0,this.index,o);this.states.push(a)}},s.prototype.complete=function(e,t){var s=e.nextState(t);this.states.push(s)},n.fromCompiled=function(t,s){var r=t.Lexer;t.ParserStart&&(s=t.ParserStart,t=t.ParserRules);var o=new n(t=t.map(function(t){return new e(t.name,t.symbols,t.postprocess)}),s);return o.lexer=r,o},r.prototype.reset=function(e,t){this.buffer=e,this.index=0,this.line=t?t.line:1,this.lastLineBreak=t?-t.col:0},r.prototype.next=function(){if(this.index<this.buffer.length){var e=this.buffer[this.index++];return"\n"===e&&(this.line+=1,this.lastLineBreak=this.index),{value:e}}},r.prototype.save=function(){return{line:this.line,col:this.index-this.lastLineBreak}},r.prototype.formatError=function(e,t){var s=this.buffer;if("string"==typeof s){var n=s.split("\n").slice(Math.max(0,this.line-5),this.line),r=s.indexOf("\n",this.index);-1===r&&(r=s.length);var o=this.index-this.lastLineBreak,a=String(this.line).length;return t+=" at line "+this.line+" col "+o+":\n\n",t+=n.map(function(e,t){return i(this.line-n.length+t+1,a)+" "+e},this).join("\n"),t+="\n"+i("",a+o)+"^\n"}return t+" at index "+(this.index-1);function i(e,t){var s=String(e);return Array(t-s.length+1).join(" ")+s}},o.fail={},o.prototype.feed=function(e){var t,n=this.lexer;for(n.reset(e,this.lexerState);;){try{if(!(t=n.next()))break}catch(e){var o=new s(this.grammar,this.current+1);throw this.table.push(o),(l=new Error(this.reportLexerError(e))).offset=this.current,l.token=e.token,l}var a=this.table[this.current];this.options.keepHistory||delete this.table[this.current-1];var i=this.current+1;o=new s(this.grammar,i);this.table.push(o);for(var l,c=void 0!==t.text?t.text:t.value,p=n.constructor===r?t.value:t,u=a.scannable,m=u.length;m--;){var y=u[m],h=y.rule.symbols[y.dot];if(h.test?h.test(p):h.type?h.type===t.type:h.literal===c){var f=y.nextState({data:p,token:t,isToken:!0,reference:i-1});o.states.push(f)}}if(o.process(),0===o.states.length)throw(l=new Error(this.reportError(t))).offset=this.current,l.token=t,l;this.options.keepHistory&&(a.lexerState=n.save()),this.current++}return a&&(this.lexerState=n.save()),this.results=this.finish(),this},o.prototype.reportLexerError=function(e){var t,s,n=e.token;return n?(t="input "+JSON.stringify(n.text[0])+" (lexer error)",s=this.lexer.formatError(n,"Syntax error")):(t="input (lexer error)",s=e.message),this.reportErrorCommon(s,t)},o.prototype.reportError=function(e){var t=(e.type?e.type+" token: ":"")+JSON.stringify(void 0!==e.value?e.value:e),s=this.lexer.formatError(e,"Syntax error");return this.reportErrorCommon(s,t)},o.prototype.reportErrorCommon=function(e,t){var s=[];s.push(e);var n=this.table.length-2,r=this.table[n],o=r.states.filter(function(e){var t=e.rule.symbols[e.dot];return t&&"string"!=typeof t});0===o.length?(s.push("Unexpected "+t+". I did not expect any more input. Here is the state of my parse table:\n"),this.displayStateStack(r.states,s)):(s.push("Unexpected "+t+". Instead, I was expecting to see one of the following:\n"),o.map(function(e){return this.buildFirstStateStack(e,[])||[e]},this).forEach(function(e){var t=e[0],n=t.rule.symbols[t.dot],r=this.getSymbolDisplay(n);s.push("A "+r+" based on:"),this.displayStateStack(e,s)},this));return s.push(""),s.join("\n")},o.prototype.displayStateStack=function(e,t){for(var s,n=0,r=0;r<e.length;r++){var o=e[r],a=o.rule.toString(o.dot);a===s?n++:(n>0&&t.push("    ^ "+n+" more lines identical to this"),n=0,t.push("    "+a)),s=a}},o.prototype.getSymbolDisplay=function(e){return function(e){var t=typeof e;if("string"===t)return e;if("object"===t){if(e.literal)return JSON.stringify(e.literal);if(e instanceof RegExp)return"character matching "+e;if(e.type)return e.type+" token";if(e.test)return"token matching "+String(e.test);throw new Error("Unknown symbol type: "+e)}}(e)},o.prototype.buildFirstStateStack=function(e,t){if(-1!==t.indexOf(e))return null;if(0===e.wantedBy.length)return[e];var s=e.wantedBy[0],n=[e].concat(t),r=this.buildFirstStateStack(s,n);return null===r?null:[e].concat(r)},o.prototype.save=function(){var e=this.table[this.current];return e.lexerState=this.lexerState,e},o.prototype.restore=function(e){var t=e.index;this.current=t,this.table[t]=e,this.table.splice(t+1),this.lexerState=e.lexerState,this.results=this.finish()},o.prototype.rewind=function(e){if(!this.options.keepHistory)throw new Error("set option `keepHistory` to enable rewinding");this.restore(this.table[e])},o.prototype.finish=function(){var e=[],t=this.grammar.start;return this.table[this.table.length-1].states.forEach(function(s){s.rule.name===t&&s.dot===s.rule.symbols.length&&0===s.reference&&s.data!==o.fail&&e.push(s)}),e.map(function(e){return e.data})},{Parser:o,Grammar:n,Rule:e}}();function y(e){return e[0]}const h=require("moo"),f=h.compile({WS:/[ \t\r]+/u,NL:{match:/\n/u,lineBreaks:!0},lineComment:/\/\/.*$/u,blockComment:{match:/\/\*[^]*?\*\//u,lineBreaks:!0},string:[{match:/"(?:[^"\\]|\\[^])*"/u,value:e=>e.slice(1,-1).replace(/\\(.)/g,(e,t)=>{switch(t){case"n":return"\n";case"t":return"\t";case"r":return"\r";case"\\":return"\\";case'"':return'"';case"'":return"'";default:return t}})},{match:/'(?:[^'\\]|\\[^])*'/u,value:e=>e.slice(1,-1).replace(/\\(.)/g,(e,t)=>{switch(t){case"n":return"\n";case"t":return"\t";case"r":return"\r";case"\\":return"\\";case'"':return'"';case"'":return"'";default:return t}})}],templateLiteral:{match:/`(?:[^`\\]|\\[^])*`/u,value:e=>e.slice(1,-1)},regex:{match:/\/(?:\\[^]|[^\s\/])(?:[^\/\\\r\n]|\\[^])*\/[gimsuy]*/u,value:e=>{const t=e.lastIndexOf("/");return{pattern:e.slice(1,t),flags:e.slice(t+1)}}},number:{match:/(?:0|[1-9]\d*)(?:\.\d+)?(?:[eE][+-]?\d+)?/u,value:e=>parseFloat(e)},identifier:{match:/[\p{L}\p{Nl}$_][\p{L}\p{Mn}\p{Mc}\p{Nd}\p{Pc}$_]*/u,type:h.keywords({let:"let",const:"const",var:"var",if:"if",else:"else",for:"for",while:"while",do:"do",break:"break",continue:"continue",return:"return",function:"function",class:"class",extends:"extends",constructor:"constructor",async:"async",await:"await",import:"import",export:"export",from:"from",as:"as",try:"try",catch:"catch",finally:"finally",throw:"throw",true:"true",false:"false",null:"null",undefined:"undefined",this:"this",super:"super",new:"new",typeof:"typeof",instanceof:"instanceof",in:"in",of:"of"})},"+=":/\+=/u,"-=":/-=/u,"*=":/\*=/u,"/=":/\/=/u,"===":/===/u,"!==":/!==/u,"==":/==/u,"!=":/!=/u,"<=":/<=/u,">=":/>=/u,"<<":/<</u,">>":/>>/u,">>>":/>>>/u,"&&":/&&/u,"||":/\|\|/u,"??":/\?\?/u,"?.":/\?\./u,"...":/\.\.\./u,"++":/\+\+/u,"--":/--/u,"**":/\*\*/u,"|>":/\|>/u,"->":/->/u,"=>":/=>/u,"=":/=/u,"<":/</u,">":/>/u,"+":/\+/u,"-":/-/u,"*":/\*/u,"/":/\//u,"%":/%/u,"&":/&/u,"|":/\|/u,"^":/\^/u,"~":/~/u,"!":/!/u,"?":/\?/u,":":/:/u,"(":/\(/u,")":/\)/u,"[":/\[/u,"]":/\]/u,"{":/\{/u,"}":/\}/u,",":/,/u,".":/\./u,";":/;/u});var b;function d(e,t={}){return{type:e,...t}}function x(e,t,s){return d("BinaryExpression",{operator:t,left:e,right:s})}function v(e){return d("Identifier",{name:e})}function g(e,t){return d("Literal",{value:e,raw:t})}f.next=(b=f.next,()=>{let e;for(;(e=b.call(f))&&("WS"===e.type||"lineComment"===e.type||"blockComment"===e.type););return e});var E={Lexer:f,ParserRules:[{name:"Program",symbols:["StatementList"],postprocess:e=>d("Program",{body:e[0]})},{name:"StatementList",symbols:[],postprocess:()=>[]},{name:"StatementList",symbols:["Statement"],postprocess:e=>[e[0]]},{name:"StatementList",symbols:["StatementList",f.has("NL")?{type:"NL"}:NL,"Statement"],postprocess:e=>[...e[0],e[2]]},{name:"StatementList",symbols:["StatementList",f.has("NL")?{type:"NL"}:NL],postprocess:e=>e[0]},{name:"Statement",symbols:["Declaration"],postprocess:y},{name:"Statement",symbols:["LabeledStatement"],postprocess:y},{name:"Statement",symbols:["ControlStatement"],postprocess:y},{name:"Statement",symbols:["ExpressionStatement"],postprocess:y},{name:"Statement",symbols:["Block"],postprocess:y},{name:"Statement",symbols:["PipelineContinuation"],postprocess:y},{name:"Statement",symbols:["MemberContinuation"],postprocess:y},{name:"PipelineContinuation$subexpression$1",symbols:[{literal:"|>"}]},{name:"PipelineContinuation$subexpression$1",symbols:[{literal:"->"}]},{name:"PipelineContinuation$ebnf$1",symbols:[]},{name:"PipelineContinuation$ebnf$1",symbols:["PipelineContinuation$ebnf$1",f.has("NL")?{type:"NL"}:NL],postprocess:function(e){return e[0].concat([e[1]])}},{name:"PipelineContinuation",symbols:["PipelineContinuation$subexpression$1","PipelineContinuation$ebnf$1","AssignmentExpression"],postprocess:e=>d("PipelineContinuation",{operator:e[0][0].value,right:e[2]})},{name:"MemberContinuation$ebnf$1",symbols:["Arguments"],postprocess:y},{name:"MemberContinuation$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"MemberContinuation",symbols:[{literal:"."},"PropertyName","MemberContinuation$ebnf$1"],postprocess:e=>d("MemberContinuation",{property:v(e[1].value),arguments:e[2]||null})},{name:"MemberContinuation$ebnf$2",symbols:["Arguments"],postprocess:y},{name:"MemberContinuation$ebnf$2",symbols:[],postprocess:function(e){return null}},{name:"MemberContinuation",symbols:[{literal:"?."},"PropertyName","MemberContinuation$ebnf$2"],postprocess:e=>d("MemberContinuation",{property:v(e[1].value),arguments:e[2]||null,optional:!0})},{name:"LabeledStatement",symbols:[f.has("identifier")?{type:"identifier"}:identifier,{literal:":"},"LoopStatement"],postprocess:e=>d("LabeledStatement",{label:v(e[0].value),body:e[2]})},{name:"LoopStatement",symbols:["WhileStatement"],postprocess:y},{name:"LoopStatement",symbols:["DoWhileStatement"],postprocess:y},{name:"LoopStatement",symbols:["ForStatement"],postprocess:y},{name:"Declaration",symbols:["VariableDeclaration"],postprocess:y},{name:"Declaration",symbols:["FunctionDeclaration"],postprocess:y},{name:"Declaration",symbols:["ClassDeclaration"],postprocess:y},{name:"Declaration",symbols:["ImportDeclaration"],postprocess:y},{name:"Declaration",symbols:["ExportDeclaration"],postprocess:y},{name:"VariableDeclaration$subexpression$1",symbols:[{literal:"let"}]},{name:"VariableDeclaration$subexpression$1",symbols:[{literal:"const"}]},{name:"VariableDeclaration$subexpression$1",symbols:[{literal:"var"}]},{name:"VariableDeclaration",symbols:["VariableDeclaration$subexpression$1","VariableDeclaratorList"],postprocess:e=>d("VariableDeclaration",{kind:e[0][0].value,declarations:e[1]})},{name:"VariableDeclaratorList",symbols:["VariableDeclarator"],postprocess:e=>[e[0]]},{name:"VariableDeclaratorList",symbols:["VariableDeclaratorList",{literal:","},"VariableDeclarator"],postprocess:e=>[...e[0],e[2]]},{name:"VariableDeclarator$ebnf$1$subexpression$1",symbols:[{literal:"="},"AssignmentExpression"]},{name:"VariableDeclarator$ebnf$1",symbols:["VariableDeclarator$ebnf$1$subexpression$1"],postprocess:y},{name:"VariableDeclarator$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"VariableDeclarator",symbols:["BindingPattern","VariableDeclarator$ebnf$1"],postprocess:e=>d("VariableDeclarator",{id:e[0],init:e[1]?e[1][1]:null})},{name:"BindingPattern",symbols:[f.has("identifier")?{type:"identifier"}:identifier],postprocess:e=>v(e[0].value)},{name:"BindingPattern",symbols:["ArrayPattern"],postprocess:y},{name:"BindingPattern",symbols:["ObjectPattern"],postprocess:y},{name:"ArrayPattern",symbols:[{literal:"["},"ArrayPatternElementList",{literal:"]"}],postprocess:e=>d("ArrayPattern",{elements:e[1]})},{name:"ArrayPatternElementList",symbols:[],postprocess:()=>[]},{name:"ArrayPatternElementList",symbols:["ArrayPatternElement"],postprocess:e=>[e[0]]},{name:"ArrayPatternElementList",symbols:["ArrayPatternElementList",{literal:","},"ArrayPatternElement"],postprocess:e=>[...e[0],e[2]]},{name:"ArrayPatternElementList",symbols:["ArrayPatternElementList",{literal:","}],postprocess:e=>[...e[0],null]},{name:"ArrayPatternElement",symbols:["BindingPattern"],postprocess:y},{name:"ArrayPatternElement",symbols:[{literal:"..."},"BindingPattern"],postprocess:e=>d("RestElement",{argument:e[1]})},{name:"ObjectPattern",symbols:[{literal:"{"},"ObjectPatternPropertyList",{literal:"}"}],postprocess:e=>d("ObjectPattern",{properties:e[1]})},{name:"ObjectPatternPropertyList",symbols:[],postprocess:()=>[]},{name:"ObjectPatternPropertyList",symbols:["ObjectPatternProperty"],postprocess:e=>[e[0]]},{name:"ObjectPatternPropertyList",symbols:["ObjectPatternPropertyList",{literal:","},"ObjectPatternProperty"],postprocess:e=>[...e[0],e[2]]},{name:"ObjectPatternProperty",symbols:[f.has("identifier")?{type:"identifier"}:identifier],postprocess:e=>d("Property",{key:v(e[0].value),value:v(e[0].value),shorthand:!0})},{name:"ObjectPatternProperty",symbols:["PropertyKey",{literal:":"},"BindingPattern"],postprocess:e=>d("Property",{key:e[0],value:e[2],shorthand:!1})},{name:"FunctionDeclaration$ebnf$1",symbols:[{literal:"async"}],postprocess:y},{name:"FunctionDeclaration$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"FunctionDeclaration",symbols:["FunctionDeclaration$ebnf$1",{literal:"function"},f.has("identifier")?{type:"identifier"}:identifier,{literal:"("},"ParameterList",{literal:")"},"Block"],postprocess:e=>d("FunctionDeclaration",{async:!!e[0],id:v(e[2].value),params:e[4],body:e[6]})},{name:"ParameterList",symbols:[],postprocess:()=>[]},{name:"ParameterList",symbols:["Parameter"],postprocess:e=>[e[0]]},{name:"ParameterList",symbols:["ParameterList",{literal:","},"Parameter"],postprocess:e=>[...e[0],e[2]]},{name:"Parameter",symbols:["BindingPattern"],postprocess:y},{name:"Parameter",symbols:["BindingPattern",{literal:"="},"AssignmentExpression"],postprocess:e=>d("AssignmentPattern",{left:e[0],right:e[2]})},{name:"Parameter",symbols:[{literal:"..."},"BindingPattern"],postprocess:e=>d("RestElement",{argument:e[1]})},{name:"ClassDeclaration$ebnf$1$subexpression$1",symbols:[{literal:"extends"},f.has("identifier")?{type:"identifier"}:identifier]},{name:"ClassDeclaration$ebnf$1",symbols:["ClassDeclaration$ebnf$1$subexpression$1"],postprocess:y},{name:"ClassDeclaration$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"ClassDeclaration",symbols:[{literal:"class"},f.has("identifier")?{type:"identifier"}:identifier,"ClassDeclaration$ebnf$1","ClassBody"],postprocess:e=>d("ClassDeclaration",{id:v(e[1].value),superClass:e[2]?v(e[2][1].value):null,body:e[3]})},{name:"ClassBody",symbols:[{literal:"{"},"ClassMemberListWithNewlines",{literal:"}"}],postprocess:e=>d("ClassBody",{body:e[1]})},{name:"ClassMemberListWithNewlines$ebnf$1",symbols:[]},{name:"ClassMemberListWithNewlines$ebnf$1",symbols:["ClassMemberListWithNewlines$ebnf$1",f.has("NL")?{type:"NL"}:NL],postprocess:function(e){return e[0].concat([e[1]])}},{name:"ClassMemberListWithNewlines$ebnf$2",symbols:["ClassMemberNonEmpty"],postprocess:y},{name:"ClassMemberListWithNewlines$ebnf$2",symbols:[],postprocess:function(e){return null}},{name:"ClassMemberListWithNewlines$ebnf$3",symbols:[]},{name:"ClassMemberListWithNewlines$ebnf$3",symbols:["ClassMemberListWithNewlines$ebnf$3",f.has("NL")?{type:"NL"}:NL],postprocess:function(e){return e[0].concat([e[1]])}},{name:"ClassMemberListWithNewlines",symbols:["ClassMemberListWithNewlines$ebnf$1","ClassMemberListWithNewlines$ebnf$2","ClassMemberListWithNewlines$ebnf$3"],postprocess:e=>e[1]?e[1]:[]},{name:"ClassMemberNonEmpty",symbols:["ClassMember"],postprocess:e=>[e[0]]},{name:"ClassMemberNonEmpty$ebnf$1",symbols:[f.has("NL")?{type:"NL"}:NL]},{name:"ClassMemberNonEmpty$ebnf$1",symbols:["ClassMemberNonEmpty$ebnf$1",f.has("NL")?{type:"NL"}:NL],postprocess:function(e){return e[0].concat([e[1]])}},{name:"ClassMemberNonEmpty",symbols:["ClassMember","ClassMemberNonEmpty$ebnf$1","ClassMemberNonEmpty"],postprocess:e=>[e[0],...e[2]]},{name:"ClassMember",symbols:["MethodDefinition"],postprocess:y},{name:"ClassMember",symbols:["PropertyDefinition"],postprocess:y},{name:"MethodDefinition$ebnf$1",symbols:[{literal:"async"}],postprocess:y},{name:"MethodDefinition$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"MethodDefinition",symbols:["MethodDefinition$ebnf$1","PropertyKey",{literal:"("},"ParameterList",{literal:")"},"Block"],postprocess:e=>d("MethodDefinition",{async:!!e[0],kind:"method",key:e[1],params:e[3],body:e[5]})},{name:"MethodDefinition",symbols:[{literal:"constructor"},{literal:"("},"ParameterList",{literal:")"},"Block"],postprocess:e=>d("MethodDefinition",{kind:"constructor",key:v("constructor"),params:e[2],body:e[4]})},{name:"PropertyDefinition",symbols:["PropertyKey",{literal:"="},"AssignmentExpression"],postprocess:e=>d("PropertyDefinition",{key:e[0],value:e[2]})},{name:"ImportDeclaration",symbols:[{literal:"import"},{literal:"{"},"ImportsList",{literal:"}"},{literal:"from"},f.has("string")?{type:"string"}:string],postprocess:e=>d("ImportDeclaration",{specifiers:e[2],source:g(e[5].value,e[5].text)})},{name:"ImportsList",symbols:[],postprocess:()=>[]},{name:"ImportsList",symbols:["ImportSpecifier"],postprocess:e=>[e[0]]},{name:"ImportsList",symbols:["ImportsList",{literal:","},"ImportSpecifier"],postprocess:e=>[...e[0],e[2]]},{name:"ImportSpecifier$ebnf$1$subexpression$1",symbols:[{literal:"as"},f.has("identifier")?{type:"identifier"}:identifier]},{name:"ImportSpecifier$ebnf$1",symbols:["ImportSpecifier$ebnf$1$subexpression$1"],postprocess:y},{name:"ImportSpecifier$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"ImportSpecifier",symbols:[f.has("identifier")?{type:"identifier"}:identifier,"ImportSpecifier$ebnf$1"],postprocess:e=>d("ImportSpecifier",{imported:v(e[0].value),local:v(e[1]?e[1][1].value:e[0].value)})},{name:"ExportDeclaration",symbols:[{literal:"export"},"Declaration"],postprocess:e=>d("ExportNamedDeclaration",{declaration:e[1]})},{name:"ExportDeclaration",symbols:[{literal:"export"},{literal:"{"},"ExportsList",{literal:"}"}],postprocess:e=>d("ExportNamedDeclaration",{specifiers:e[2],source:null})},{name:"ExportsList",symbols:[],postprocess:()=>[]},{name:"ExportsList",symbols:["ExportSpecifier"],postprocess:e=>[e[0]]},{name:"ExportsList",symbols:["ExportsList",{literal:","},"ExportSpecifier"],postprocess:e=>[...e[0],e[2]]},{name:"ExportSpecifier$ebnf$1$subexpression$1",symbols:[{literal:"as"},f.has("identifier")?{type:"identifier"}:identifier]},{name:"ExportSpecifier$ebnf$1",symbols:["ExportSpecifier$ebnf$1$subexpression$1"],postprocess:y},{name:"ExportSpecifier$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"ExportSpecifier",symbols:[f.has("identifier")?{type:"identifier"}:identifier,"ExportSpecifier$ebnf$1"],postprocess:e=>d("ExportSpecifier",{local:v(e[0].value),exported:v(e[1]?e[1][1].value:e[0].value)})},{name:"ControlStatement",symbols:["IfStatement"],postprocess:y},{name:"ControlStatement",symbols:["WhileStatement"],postprocess:y},{name:"ControlStatement",symbols:["DoWhileStatement"],postprocess:y},{name:"ControlStatement",symbols:["ForStatement"],postprocess:y},{name:"ControlStatement",symbols:["TryStatement"],postprocess:y},{name:"ControlStatement",symbols:["ThrowStatement"],postprocess:y},{name:"ControlStatement",symbols:["ReturnStatement"],postprocess:y},{name:"ControlStatement",symbols:["BreakStatement"],postprocess:y},{name:"ControlStatement",symbols:["ContinueStatement"],postprocess:y},{name:"IfStatement$ebnf$1$subexpression$1",symbols:[{literal:"else"},"Statement"]},{name:"IfStatement$ebnf$1",symbols:["IfStatement$ebnf$1$subexpression$1"],postprocess:y},{name:"IfStatement$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"IfStatement",symbols:[{literal:"if"},{literal:"("},"Expression",{literal:")"},"Statement","IfStatement$ebnf$1"],postprocess:e=>d("IfStatement",{test:e[2],consequent:e[4],alternate:e[5]?e[5][1]:null})},{name:"WhileStatement",symbols:[{literal:"while"},{literal:"("},"Expression",{literal:")"},"Statement"],postprocess:e=>d("WhileStatement",{test:e[2],body:e[4]})},{name:"DoWhileStatement",symbols:[{literal:"do"},"Statement",{literal:"while"},{literal:"("},"Expression",{literal:")"}],postprocess:e=>d("DoWhileStatement",{body:e[1],test:e[4]})},{name:"ForStatement$subexpression$1",symbols:["VariableDeclaration"]},{name:"ForStatement$subexpression$1",symbols:["Expression"]},{name:"ForStatement$subexpression$1",symbols:[]},{name:"ForStatement$subexpression$2",symbols:["Expression"]},{name:"ForStatement$subexpression$2",symbols:[]},{name:"ForStatement$subexpression$3",symbols:["Expression"]},{name:"ForStatement$subexpression$3",symbols:[]},{name:"ForStatement",symbols:[{literal:"for"},{literal:"("},"ForStatement$subexpression$1",{literal:";"},"ForStatement$subexpression$2",{literal:";"},"ForStatement$subexpression$3",{literal:")"},"Statement"],postprocess:e=>d("ForStatement",{init:e[2]?e[2][0]:null,test:e[4]?e[4][0]:null,update:e[6]?e[6][0]:null,body:e[8]})},{name:"ForStatement$subexpression$4",symbols:[{literal:"let"}]},{name:"ForStatement$subexpression$4",symbols:[{literal:"const"}]},{name:"ForStatement$subexpression$4",symbols:[{literal:"var"}]},{name:"ForStatement",symbols:[{literal:"for"},{literal:"("},"ForStatement$subexpression$4","BindingPattern",{literal:"of"},"Expression",{literal:")"},"Statement"],postprocess:e=>d("ForOfStatement",{left:d("VariableDeclaration",{kind:e[2][0].value,declarations:[d("VariableDeclarator",{id:e[3],init:null})]}),right:e[5],body:e[7]})},{name:"TryStatement",symbols:[{literal:"try"},"Block","CatchFinally"],postprocess:e=>d("TryStatement",{block:e[1],handler:e[2].handler,finalizer:e[2].finalizer})},{name:"CatchFinally$ebnf$1$subexpression$1",symbols:[{literal:"("},"BindingPattern",{literal:")"}]},{name:"CatchFinally$ebnf$1",symbols:["CatchFinally$ebnf$1$subexpression$1"],postprocess:y},{name:"CatchFinally$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"CatchFinally$ebnf$2$subexpression$1",symbols:[{literal:"finally"},"Block"]},{name:"CatchFinally$ebnf$2",symbols:["CatchFinally$ebnf$2$subexpression$1"],postprocess:y},{name:"CatchFinally$ebnf$2",symbols:[],postprocess:function(e){return null}},{name:"CatchFinally",symbols:[{literal:"catch"},"CatchFinally$ebnf$1","Block","CatchFinally$ebnf$2"],postprocess:e=>({handler:d("CatchClause",{param:e[1]?e[1][1]:null,body:e[2]}),finalizer:e[3]?e[3][1]:null})},{name:"CatchFinally",symbols:[{literal:"finally"},"Block"],postprocess:e=>({handler:null,finalizer:e[1]})},{name:"ThrowStatement",symbols:[{literal:"throw"},"Expression"],postprocess:e=>d("ThrowStatement",{argument:e[1]})},{name:"ReturnStatement$ebnf$1",symbols:["Expression"],postprocess:y},{name:"ReturnStatement$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"ReturnStatement",symbols:[{literal:"return"},"ReturnStatement$ebnf$1"],postprocess:e=>d("ReturnStatement",{argument:e[1]})},{name:"BreakStatement$ebnf$1",symbols:[f.has("identifier")?{type:"identifier"}:identifier],postprocess:y},{name:"BreakStatement$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"BreakStatement",symbols:[{literal:"break"},"BreakStatement$ebnf$1"],postprocess:e=>d("BreakStatement",{label:e[1]?v(e[1].value):null})},{name:"ContinueStatement$ebnf$1",symbols:[f.has("identifier")?{type:"identifier"}:identifier],postprocess:y},{name:"ContinueStatement$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"ContinueStatement",symbols:[{literal:"continue"},"ContinueStatement$ebnf$1"],postprocess:e=>d("ContinueStatement",{label:e[1]?v(e[1].value):null})},{name:"ExpressionStatement",symbols:["Expression"],postprocess:e=>d("ExpressionStatement",{expression:e[0]})},{name:"Expression",symbols:["AssignmentExpression"],postprocess:y},{name:"AssignmentExpression",symbols:["PipelineExpression"],postprocess:y},{name:"AssignmentExpression",symbols:["ArrowFunction"],postprocess:y},{name:"AssignmentExpression",symbols:["LeftHandSideExpression","AssignmentOperator","AssignmentExpression"],postprocess:e=>d("AssignmentExpression",{operator:e[1],left:e[0],right:e[2]})},{name:"PipelineExpression",symbols:["ConditionalExpression"],postprocess:y},{name:"PipelineExpression$subexpression$1",symbols:[{literal:"|>"}]},{name:"PipelineExpression$subexpression$1",symbols:[{literal:"->"}]},{name:"PipelineExpression",symbols:["PipelineExpression","PipelineExpression$subexpression$1","ConditionalExpression"],postprocess:e=>{return t=e[0],s=e[1][0].value,n=e[2],d("PipelineExpression",{operator:s,left:t,right:n});var t,s,n}},{name:"AssignmentOperator",symbols:[{literal:"="}],postprocess:e=>e[0].value},{name:"AssignmentOperator",symbols:[{literal:"+="}],postprocess:e=>e[0].value},{name:"AssignmentOperator",symbols:[{literal:"-="}],postprocess:e=>e[0].value},{name:"AssignmentOperator",symbols:[{literal:"*="}],postprocess:e=>e[0].value},{name:"AssignmentOperator",symbols:[{literal:"/="}],postprocess:e=>e[0].value},{name:"ArrowFunction",symbols:["ArrowParameters",{literal:"=>"},"ArrowBody"],postprocess:e=>d("ArrowFunctionExpression",{async:!1,params:e[0],body:e[2]})},{name:"ArrowFunction",symbols:[{literal:"async"},"ArrowParameters",{literal:"=>"},"ArrowBody"],postprocess:e=>d("ArrowFunctionExpression",{async:!0,params:e[1],body:e[3]})},{name:"ArrowParameters",symbols:[f.has("identifier")?{type:"identifier"}:identifier],postprocess:e=>[v(e[0].value)]},{name:"ArrowParameters",symbols:[{literal:"("},"ParameterList",{literal:")"}],postprocess:e=>e[1]},{name:"ArrowBody",symbols:["Block"],postprocess:y},{name:"ArrowBody",symbols:["AssignmentExpression"],postprocess:y},{name:"ConditionalExpression",symbols:["LogicalOrExpression"],postprocess:y},{name:"ConditionalExpression",symbols:["LogicalOrExpression",{literal:"?"},"AssignmentExpression",{literal:":"},"ConditionalExpression"],postprocess:e=>d("ConditionalExpression",{test:e[0],consequent:e[2],alternate:e[4]})},{name:"LogicalOrExpression",symbols:["LogicalAndExpression"],postprocess:y},{name:"LogicalOrExpression$subexpression$1",symbols:[{literal:"||"}]},{name:"LogicalOrExpression$subexpression$1",symbols:[{literal:"??"}]},{name:"LogicalOrExpression",symbols:["LogicalOrExpression","LogicalOrExpression$subexpression$1","LogicalAndExpression"],postprocess:e=>x(e[0],e[1][0].value,e[2])},{name:"LogicalAndExpression",symbols:["EqualityExpression"],postprocess:y},{name:"LogicalAndExpression",symbols:["LogicalAndExpression",{literal:"&&"},"EqualityExpression"],postprocess:e=>x(e[0],e[1].value,e[2])},{name:"EqualityExpression",symbols:["RelationalExpression"],postprocess:y},{name:"EqualityExpression$subexpression$1",symbols:[{literal:"=="}]},{name:"EqualityExpression$subexpression$1",symbols:[{literal:"!="}]},{name:"EqualityExpression$subexpression$1",symbols:[{literal:"==="}]},{name:"EqualityExpression$subexpression$1",symbols:[{literal:"!=="}]},{name:"EqualityExpression",symbols:["EqualityExpression","EqualityExpression$subexpression$1","RelationalExpression"],postprocess:e=>x(e[0],e[1][0].value,e[2])},{name:"RelationalExpression",symbols:["AdditiveExpression"],postprocess:y},{name:"RelationalExpression$subexpression$1",symbols:[{literal:"<"}]},{name:"RelationalExpression$subexpression$1",symbols:[{literal:">"}]},{name:"RelationalExpression$subexpression$1",symbols:[{literal:"<="}]},{name:"RelationalExpression$subexpression$1",symbols:[{literal:">="}]},{name:"RelationalExpression",symbols:["RelationalExpression","RelationalExpression$subexpression$1","AdditiveExpression"],postprocess:e=>x(e[0],e[1][0].value,e[2])},{name:"RelationalExpression$subexpression$2",symbols:[{literal:"instanceof"}]},{name:"RelationalExpression$subexpression$2",symbols:[{literal:"in"}]},{name:"RelationalExpression",symbols:["RelationalExpression","RelationalExpression$subexpression$2","AdditiveExpression"],postprocess:e=>x(e[0],e[1][0].value,e[2])},{name:"AdditiveExpression",symbols:["MultiplicativeExpression"],postprocess:y},{name:"AdditiveExpression$subexpression$1",symbols:[{literal:"+"}]},{name:"AdditiveExpression$subexpression$1",symbols:[{literal:"-"}]},{name:"AdditiveExpression",symbols:["AdditiveExpression","AdditiveExpression$subexpression$1","MultiplicativeExpression"],postprocess:e=>x(e[0],e[1][0].value,e[2])},{name:"MultiplicativeExpression",symbols:["ExponentiationExpression"],postprocess:y},{name:"MultiplicativeExpression$subexpression$1",symbols:[{literal:"*"}]},{name:"MultiplicativeExpression$subexpression$1",symbols:[{literal:"/"}]},{name:"MultiplicativeExpression$subexpression$1",symbols:[{literal:"%"}]},{name:"MultiplicativeExpression",symbols:["MultiplicativeExpression","MultiplicativeExpression$subexpression$1","ExponentiationExpression"],postprocess:e=>x(e[0],e[1][0].value,e[2])},{name:"ExponentiationExpression",symbols:["UnaryExpression"],postprocess:y},{name:"ExponentiationExpression",symbols:["UnaryExpression",{literal:"**"},"ExponentiationExpression"],postprocess:e=>x(e[0],e[1].value,e[2])},{name:"UnaryExpression",symbols:["PostfixExpression"],postprocess:y},{name:"UnaryExpression$subexpression$1",symbols:[{literal:"!"}]},{name:"UnaryExpression$subexpression$1",symbols:[{literal:"+"}]},{name:"UnaryExpression$subexpression$1",symbols:[{literal:"-"}]},{name:"UnaryExpression$subexpression$1",symbols:[{literal:"~"}]},{name:"UnaryExpression$subexpression$1",symbols:[{literal:"typeof"}]},{name:"UnaryExpression$subexpression$1",symbols:[{literal:"await"}]},{name:"UnaryExpression",symbols:["UnaryExpression$subexpression$1","UnaryExpression"],postprocess:e=>function(e,t,s=!0){return d("UnaryExpression",{operator:e,argument:t,prefix:s})}(e[0][0].value,e[1])},{name:"UnaryExpression$subexpression$2",symbols:[{literal:"++"}]},{name:"UnaryExpression$subexpression$2",symbols:[{literal:"--"}]},{name:"UnaryExpression",symbols:["UnaryExpression$subexpression$2","UnaryExpression"],postprocess:e=>d("UpdateExpression",{operator:e[0][0].value,argument:e[1],prefix:!0})},{name:"PostfixExpression",symbols:["LeftHandSideExpression"],postprocess:y},{name:"PostfixExpression$subexpression$1",symbols:[{literal:"++"}]},{name:"PostfixExpression$subexpression$1",symbols:[{literal:"--"}]},{name:"PostfixExpression",symbols:["LeftHandSideExpression","PostfixExpression$subexpression$1"],postprocess:e=>d("UpdateExpression",{operator:e[1][0].value,argument:e[0],prefix:!1})},{name:"LeftHandSideExpression",symbols:["CallExpression"],postprocess:y},{name:"LeftHandSideExpression",symbols:["NewExpression"],postprocess:y},{name:"CallExpression",symbols:["MemberExpression","Arguments"],postprocess:e=>d("CallExpression",{callee:e[0],arguments:e[1]})},{name:"CallExpression",symbols:["CallExpression","Arguments"],postprocess:e=>d("CallExpression",{callee:e[0],arguments:e[1]})},{name:"CallExpression",symbols:["CallExpression",{literal:"["},"Expression",{literal:"]"}],postprocess:e=>d("MemberExpression",{object:e[0],property:e[2],computed:!0})},{name:"CallExpression$ebnf$1",symbols:[]},{name:"CallExpression$ebnf$1",symbols:["CallExpression$ebnf$1",f.has("NL")?{type:"NL"}:NL],postprocess:function(e){return e[0].concat([e[1]])}},{name:"CallExpression",symbols:["CallExpression","CallExpression$ebnf$1",{literal:"."},"PropertyName"],postprocess:e=>d("MemberExpression",{object:e[0],property:v(e[3].value),computed:!1})},{name:"CallExpression$ebnf$2",symbols:[]},{name:"CallExpression$ebnf$2",symbols:["CallExpression$ebnf$2",f.has("NL")?{type:"NL"}:NL],postprocess:function(e){return e[0].concat([e[1]])}},{name:"CallExpression",symbols:["CallExpression","CallExpression$ebnf$2",{literal:"?."},"OptionalMemberAccess"],postprocess:e=>d("MemberExpression",{object:e[0],property:e[3].property,computed:e[3].computed,optional:!0})},{name:"NewExpression$ebnf$1",symbols:["Arguments"],postprocess:y},{name:"NewExpression$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"NewExpression",symbols:[{literal:"new"},"MemberExpression","NewExpression$ebnf$1"],postprocess:e=>d("NewExpression",{callee:e[1],arguments:e[2]||[]})},{name:"NewExpression",symbols:["MemberExpression"],postprocess:y},{name:"MemberExpression",symbols:["PrimaryExpression"],postprocess:y},{name:"MemberExpression",symbols:["MemberExpression",{literal:"["},"Expression",{literal:"]"}],postprocess:e=>d("MemberExpression",{object:e[0],property:e[2],computed:!0})},{name:"MemberExpression$ebnf$1",symbols:[]},{name:"MemberExpression$ebnf$1",symbols:["MemberExpression$ebnf$1",f.has("NL")?{type:"NL"}:NL],postprocess:function(e){return e[0].concat([e[1]])}},{name:"MemberExpression",symbols:["MemberExpression","MemberExpression$ebnf$1",{literal:"."},"PropertyName"],postprocess:e=>d("MemberExpression",{object:e[0],property:v(e[3].value),computed:!1})},{name:"MemberExpression$ebnf$2",symbols:[]},{name:"MemberExpression$ebnf$2",symbols:["MemberExpression$ebnf$2",f.has("NL")?{type:"NL"}:NL],postprocess:function(e){return e[0].concat([e[1]])}},{name:"MemberExpression",symbols:["MemberExpression","MemberExpression$ebnf$2",{literal:"?."},"OptionalMemberAccess"],postprocess:e=>d("MemberExpression",{object:e[0],property:e[3].property,computed:e[3].computed,optional:!0})},{name:"OptionalMemberAccess",symbols:["PropertyName"],postprocess:e=>({property:v(e[0].value),computed:!1})},{name:"OptionalMemberAccess",symbols:[{literal:"["},"Expression",{literal:"]"}],postprocess:e=>({property:e[1],computed:!0})},{name:"PropertyName",symbols:[f.has("identifier")?{type:"identifier"}:identifier],postprocess:e=>e[0]},{name:"PropertyName",symbols:["ReservedKeyword"],postprocess:e=>e[0]},{name:"ReservedKeyword",symbols:[{literal:"let"}],postprocess:e=>({value:"let"})},{name:"ReservedKeyword",symbols:[{literal:"const"}],postprocess:e=>({value:"const"})},{name:"ReservedKeyword",symbols:[{literal:"var"}],postprocess:e=>({value:"var"})},{name:"ReservedKeyword",symbols:[{literal:"if"}],postprocess:e=>({value:"if"})},{name:"ReservedKeyword",symbols:[{literal:"else"}],postprocess:e=>({value:"else"})},{name:"ReservedKeyword",symbols:[{literal:"for"}],postprocess:e=>({value:"for"})},{name:"ReservedKeyword",symbols:[{literal:"while"}],postprocess:e=>({value:"while"})},{name:"ReservedKeyword",symbols:[{literal:"do"}],postprocess:e=>({value:"do"})},{name:"ReservedKeyword",symbols:[{literal:"break"}],postprocess:e=>({value:"break"})},{name:"ReservedKeyword",symbols:[{literal:"continue"}],postprocess:e=>({value:"continue"})},{name:"ReservedKeyword",symbols:[{literal:"return"}],postprocess:e=>({value:"return"})},{name:"ReservedKeyword",symbols:[{literal:"function"}],postprocess:e=>({value:"function"})},{name:"ReservedKeyword",symbols:[{literal:"class"}],postprocess:e=>({value:"class"})},{name:"ReservedKeyword",symbols:[{literal:"extends"}],postprocess:e=>({value:"extends"})},{name:"ReservedKeyword",symbols:[{literal:"constructor"}],postprocess:e=>({value:"constructor"})},{name:"ReservedKeyword",symbols:[{literal:"async"}],postprocess:e=>({value:"async"})},{name:"ReservedKeyword",symbols:[{literal:"await"}],postprocess:e=>({value:"await"})},{name:"ReservedKeyword",symbols:[{literal:"import"}],postprocess:e=>({value:"import"})},{name:"ReservedKeyword",symbols:[{literal:"export"}],postprocess:e=>({value:"export"})},{name:"ReservedKeyword",symbols:[{literal:"from"}],postprocess:e=>({value:"from"})},{name:"ReservedKeyword",symbols:[{literal:"as"}],postprocess:e=>({value:"as"})},{name:"ReservedKeyword",symbols:[{literal:"try"}],postprocess:e=>({value:"try"})},{name:"ReservedKeyword",symbols:[{literal:"catch"}],postprocess:e=>({value:"catch"})},{name:"ReservedKeyword",symbols:[{literal:"finally"}],postprocess:e=>({value:"finally"})},{name:"ReservedKeyword",symbols:[{literal:"throw"}],postprocess:e=>({value:"throw"})},{name:"ReservedKeyword",symbols:[{literal:"true"}],postprocess:e=>({value:"true"})},{name:"ReservedKeyword",symbols:[{literal:"false"}],postprocess:e=>({value:"false"})},{name:"ReservedKeyword",symbols:[{literal:"null"}],postprocess:e=>({value:"null"})},{name:"ReservedKeyword",symbols:[{literal:"undefined"}],postprocess:e=>({value:"undefined"})},{name:"ReservedKeyword",symbols:[{literal:"this"}],postprocess:e=>({value:"this"})},{name:"ReservedKeyword",symbols:[{literal:"super"}],postprocess:e=>({value:"super"})},{name:"ReservedKeyword",symbols:[{literal:"new"}],postprocess:e=>({value:"new"})},{name:"ReservedKeyword",symbols:[{literal:"typeof"}],postprocess:e=>({value:"typeof"})},{name:"ReservedKeyword",symbols:[{literal:"instanceof"}],postprocess:e=>({value:"instanceof"})},{name:"ReservedKeyword",symbols:[{literal:"in"}],postprocess:e=>({value:"in"})},{name:"ReservedKeyword",symbols:[{literal:"of"}],postprocess:e=>({value:"of"})},{name:"Arguments",symbols:[{literal:"("},"ArgumentList",{literal:")"}],postprocess:e=>e[1]},{name:"ArgumentList",symbols:[],postprocess:()=>[]},{name:"ArgumentList",symbols:["AssignmentExpression"],postprocess:e=>[e[0]]},{name:"ArgumentList",symbols:["ArgumentList",{literal:","},"AssignmentExpression"],postprocess:e=>[...e[0],e[2]]},{name:"ArgumentList",symbols:[{literal:"..."},"AssignmentExpression"],postprocess:e=>[d("SpreadElement",{argument:e[1]})]},{name:"ArgumentList",symbols:["ArgumentList",{literal:","},{literal:"..."},"AssignmentExpression"],postprocess:e=>[...e[0],d("SpreadElement",{argument:e[3]})]},{name:"PrimaryExpression",symbols:[{literal:"this"}],postprocess:()=>d("ThisExpression")},{name:"PrimaryExpression",symbols:[{literal:"super"}],postprocess:()=>d("Super")},{name:"PrimaryExpression",symbols:[f.has("identifier")?{type:"identifier"}:identifier],postprocess:e=>v(e[0].value)},{name:"PrimaryExpression",symbols:["Literal"],postprocess:y},{name:"PrimaryExpression",symbols:["ArrayLiteral"],postprocess:y},{name:"PrimaryExpression",symbols:["ObjectLiteral"],postprocess:y},{name:"PrimaryExpression",symbols:["FunctionExpression"],postprocess:y},{name:"PrimaryExpression",symbols:["TemplateLiteral"],postprocess:y},{name:"PrimaryExpression",symbols:[{literal:"("},"Expression",{literal:")"}],postprocess:e=>e[1]},{name:"FunctionExpression",symbols:[{literal:"function"},{literal:"("},"ParameterList",{literal:")"},"Block"],postprocess:e=>d("FunctionExpression",{async:!1,id:null,params:e[2],body:e[4]})},{name:"FunctionExpression",symbols:[{literal:"async"},{literal:"function"},{literal:"("},"ParameterList",{literal:")"},"Block"],postprocess:e=>d("FunctionExpression",{async:!0,id:null,params:e[3],body:e[5]})},{name:"Literal",symbols:[f.has("number")?{type:"number"}:number],postprocess:e=>g(e[0].value,e[0].text)},{name:"Literal",symbols:[f.has("string")?{type:"string"}:string],postprocess:e=>g(e[0].value,e[0].text)},{name:"Literal",symbols:[f.has("regex")?{type:"regex"}:regex],postprocess:e=>{return t=e[0].value.pattern,s=e[0].value.flags,d("RegexLiteral",{pattern:t,flags:s});var t,s}},{name:"Literal",symbols:[{literal:"true"}],postprocess:()=>g(!0,"true")},{name:"Literal",symbols:[{literal:"false"}],postprocess:()=>g(!1,"false")},{name:"Literal",symbols:[{literal:"null"}],postprocess:()=>g(null,"null")},{name:"Literal",symbols:[{literal:"undefined"}],postprocess:()=>g(void 0,"undefined")},{name:"TemplateLiteral",symbols:[f.has("templateLiteral")?{type:"templateLiteral"}:templateLiteral],postprocess:e=>d("TemplateLiteral",{quasis:[d("TemplateElement",{value:{cooked:e[0].value,raw:e[0].value}})],expressions:[]})},{name:"ArrayLiteral$ebnf$1",symbols:[]},{name:"ArrayLiteral$ebnf$1",symbols:["ArrayLiteral$ebnf$1",f.has("NL")?{type:"NL"}:NL],postprocess:function(e){return e[0].concat([e[1]])}},{name:"ArrayLiteral$ebnf$2",symbols:[]},{name:"ArrayLiteral$ebnf$2",symbols:["ArrayLiteral$ebnf$2",f.has("NL")?{type:"NL"}:NL],postprocess:function(e){return e[0].concat([e[1]])}},{name:"ArrayLiteral",symbols:[{literal:"["},"ArrayLiteral$ebnf$1","ElementList","ArrayLiteral$ebnf$2",{literal:"]"}],postprocess:e=>d("ArrayExpression",{elements:e[2]})},{name:"ElementList",symbols:[],postprocess:()=>[]},{name:"ElementList",symbols:["Element"],postprocess:e=>[e[0]]},{name:"ElementList$ebnf$1",symbols:[]},{name:"ElementList$ebnf$1",symbols:["ElementList$ebnf$1",f.has("NL")?{type:"NL"}:NL],postprocess:function(e){return e[0].concat([e[1]])}},{name:"ElementList$ebnf$2",symbols:[]},{name:"ElementList$ebnf$2",symbols:["ElementList$ebnf$2",f.has("NL")?{type:"NL"}:NL],postprocess:function(e){return e[0].concat([e[1]])}},{name:"ElementList",symbols:["ElementList","ElementList$ebnf$1",{literal:","},"ElementList$ebnf$2","Element"],postprocess:e=>[...e[0],e[4]]},{name:"ElementList$ebnf$3",symbols:[]},{name:"ElementList$ebnf$3",symbols:["ElementList$ebnf$3",f.has("NL")?{type:"NL"}:NL],postprocess:function(e){return e[0].concat([e[1]])}},{name:"ElementList",symbols:["ElementList","ElementList$ebnf$3",{literal:","}],postprocess:e=>[...e[0],null]},{name:"Element",symbols:["AssignmentExpression"],postprocess:y},{name:"Element",symbols:[{literal:"..."},"AssignmentExpression"],postprocess:e=>d("SpreadElement",{argument:e[1]})},{name:"ObjectLiteral$ebnf$1",symbols:[]},{name:"ObjectLiteral$ebnf$1",symbols:["ObjectLiteral$ebnf$1",f.has("NL")?{type:"NL"}:NL],postprocess:function(e){return e[0].concat([e[1]])}},{name:"ObjectLiteral",symbols:[{literal:"{"},"ObjectLiteral$ebnf$1",{literal:"}"}],postprocess:()=>d("ObjectExpression",{properties:[]})},{name:"ObjectLiteral$ebnf$2",symbols:[]},{name:"ObjectLiteral$ebnf$2",symbols:["ObjectLiteral$ebnf$2",f.has("NL")?{type:"NL"}:NL],postprocess:function(e){return e[0].concat([e[1]])}},{name:"ObjectLiteral$ebnf$3",symbols:[]},{name:"ObjectLiteral$ebnf$3",symbols:["ObjectLiteral$ebnf$3",f.has("NL")?{type:"NL"}:NL],postprocess:function(e){return e[0].concat([e[1]])}},{name:"ObjectLiteral",symbols:[{literal:"{"},"ObjectLiteral$ebnf$2","PropertyDefinitionList","ObjectLiteral$ebnf$3",{literal:"}"}],postprocess:e=>d("ObjectExpression",{properties:e[2]})},{name:"PropertyDefinitionList",symbols:["PropertyDef"],postprocess:e=>[e[0]]},{name:"PropertyDefinitionList$ebnf$1",symbols:[]},{name:"PropertyDefinitionList$ebnf$1",symbols:["PropertyDefinitionList$ebnf$1",f.has("NL")?{type:"NL"}:NL],postprocess:function(e){return e[0].concat([e[1]])}},{name:"PropertyDefinitionList$ebnf$2",symbols:[]},{name:"PropertyDefinitionList$ebnf$2",symbols:["PropertyDefinitionList$ebnf$2",f.has("NL")?{type:"NL"}:NL],postprocess:function(e){return e[0].concat([e[1]])}},{name:"PropertyDefinitionList",symbols:["PropertyDefinitionList","PropertyDefinitionList$ebnf$1",{literal:","},"PropertyDefinitionList$ebnf$2","PropertyDef"],postprocess:e=>[...e[0],e[4]]},{name:"PropertyDefinitionList$ebnf$3",symbols:[]},{name:"PropertyDefinitionList$ebnf$3",symbols:["PropertyDefinitionList$ebnf$3",f.has("NL")?{type:"NL"}:NL],postprocess:function(e){return e[0].concat([e[1]])}},{name:"PropertyDefinitionList",symbols:["PropertyDefinitionList","PropertyDefinitionList$ebnf$3",{literal:","}],postprocess:e=>e[0]},{name:"PropertyDef$ebnf$1",symbols:[]},{name:"PropertyDef$ebnf$1",symbols:["PropertyDef$ebnf$1",f.has("NL")?{type:"NL"}:NL],postprocess:function(e){return e[0].concat([e[1]])}},{name:"PropertyDef$ebnf$2",symbols:[]},{name:"PropertyDef$ebnf$2",symbols:["PropertyDef$ebnf$2",f.has("NL")?{type:"NL"}:NL],postprocess:function(e){return e[0].concat([e[1]])}},{name:"PropertyDef",symbols:["ObjectPropertyKey","PropertyDef$ebnf$1",{literal:":"},"PropertyDef$ebnf$2","AssignmentExpression"],postprocess:e=>d("Property",{key:e[0],value:e[4],shorthand:!1})},{name:"PropertyDef",symbols:["PropertyName"],postprocess:e=>d("Property",{key:v(e[0].value),value:v(e[0].value),shorthand:!0})},{name:"PropertyDef",symbols:[{literal:"..."},"AssignmentExpression"],postprocess:e=>d("SpreadElement",{argument:e[1]})},{name:"ObjectPropertyKey",symbols:["PropertyName"],postprocess:e=>v(e[0].value)},{name:"ObjectPropertyKey",symbols:[f.has("string")?{type:"string"}:string],postprocess:e=>g(e[0].value,e[0].text)},{name:"ObjectPropertyKey",symbols:[f.has("number")?{type:"number"}:number],postprocess:e=>g(e[0].value,e[0].text)},{name:"ObjectPropertyKey",symbols:[{literal:"["},"Expression",{literal:"]"}],postprocess:e=>e[1]},{name:"PropertyKey",symbols:[f.has("identifier")?{type:"identifier"}:identifier],postprocess:e=>v(e[0].value)},{name:"PropertyKey",symbols:[f.has("string")?{type:"string"}:string],postprocess:e=>g(e[0].value,e[0].text)},{name:"PropertyKey",symbols:[f.has("number")?{type:"number"}:number],postprocess:e=>g(e[0].value,e[0].text)},{name:"PropertyKey",symbols:[{literal:"["},"Expression",{literal:"]"}],postprocess:e=>e[1]},{name:"Block",symbols:[{literal:"{"},"StatementList",{literal:"}"}],postprocess:e=>d("BlockStatement",{body:e[1]})}],ParserStart:"Program"},$=Object.freeze({__proto__:null,grammar:E,nearley:m});class w{constructor(e={}){this.lastPipelineValue=void 0,this.globalModuleCache=new Map,this.consoleLogs=[],this.moduleResolver=e.moduleResolver||new i,this.globalContext=e.globalContext||this.createContext(),this.currentContext=this.globalContext,this.bindBuiltins(),e.functions&&Object.entries(e.functions).forEach(([e,t])=>{this.bindFunction(e,t)})}createContext(e){return{variables:new Map,variableKinds:new Map,functions:new Map,classes:new Map,exports:new Map,parent:e,moduleCache:new Map}}bindBuiltins(){this.bindFunction("log",(...e)=>{this.consoleLogs.push({type:"log",args:e,timestamp:Date.now()}),console.log(...e)}),this.bindFunction("error",(...e)=>{this.consoleLogs.push({type:"error",args:e,timestamp:Date.now()}),console.error(...e)}),this.bindFunction("warn",(...e)=>{this.consoleLogs.push({type:"warn",args:e,timestamp:Date.now()}),console.warn(...e)}),this.bindFunction("Number",e=>Number(e)),this.bindFunction("String",e=>String(e)),this.bindFunction("Boolean",e=>Boolean(e)),this.bindFunction("isNaN",e=>isNaN(e)),this.bindFunction("isFinite",e=>isFinite(e)),this.bindFunction("isInteger",e=>Number.isInteger(e)),Object.entries(u).forEach(([e,t])=>{this.bindFunction(e,t)});const e=function(t){if(!(this instanceof e))return new Error(t);const s=new Error(t);return Object.setPrototypeOf(this,s),this.message=t||"",this.name="Error",this};this.bindFunction("Error",e),this.currentContext.variables.set("Error",e),this.currentContext.variables.set("Infinity",1/0),this.currentContext.variables.set("NaN",NaN),this.currentContext.variables.set("undefined",void 0),this.currentContext.variables.set("Date",Date),this.currentContext.variables.set("RegExp",RegExp),this.currentContext.variables.set("Promise",{all:e=>Promise.all(e),race:e=>Promise.race(e),resolve:e=>Promise.resolve(e),reject:e=>Promise.reject(e)}),this.bindFunction("filter",async(e,t)=>{const s=[];for(let n=0;n<e.length;n++){const r=t(e[n],n,e);(r instanceof Promise?await r:r)&&s.push(e[n])}return s}),this.bindFunction("map",async(e,t)=>{const s=[];for(let n=0;n<e.length;n++){const r=t(e[n],n,e);s.push(r instanceof Promise?await r:r)}return s}),this.bindFunction("reduce",async(e,t,s)=>{let n=void 0!==s?s:e[0];for(let r=void 0!==s?0:1;r<e.length;r++){const s=t(n,e[r],r,e);n=s instanceof Promise?await s:s}return n}),this.bindFunction("forEach",async(e,t)=>{for(let s=0;s<e.length;s++)await t(e[s],s,e)}),this.bindFunction("find",async(e,t)=>{for(let s=0;s<e.length;s++)if(await t(e[s],s,e))return e[s]}),this.bindFunction("some",async(e,t)=>{for(let s=0;s<e.length;s++)if(await t(e[s],s,e))return!0;return!1}),this.bindFunction("every",async(e,t)=>{for(let s=0;s<e.length;s++)if(!await t(e[s],s,e))return!1;return!0}),this.bindFunction("sort",async(e,t)=>{if(!t)return[...e].sort();const s=[...e];for(let e=0;e<s.length-1;e++)for(let n=e+1;n<s.length;n++){await t(s[e],s[n])>0&&([s[e],s[n]]=[s[n],s[e]])}return s}),this.bindFunction("slice",(e,t,s)=>e.slice(t,s)),this.bindFunction("concat",(...e)=>[].concat(...e)),this.bindFunction("join",(e,t)=>e.join(t)),this.bindFunction("includes",(e,t)=>e.includes(t)),this.bindFunction("indexOf",(e,t)=>Array.isArray(e)?e.indexOf(t):-1),this.bindFunction("push",(e,...t)=>(e.push(...t),e)),this.bindFunction("forEach",(e,t)=>{Array.isArray(e)&&e.forEach(t)}),this.bindFunction("pop",e=>e.pop()),this.bindFunction("shift",e=>e.shift()),this.bindFunction("unshift",(e,...t)=>(e.unshift(...t),e)),this.bindFunction("assign",Object.assign),this.bindFunction("freeze",Object.freeze),this.bindFunction("seal",Object.seal),this.bindFunction("toUpperCase",e=>e.toUpperCase()),this.bindFunction("toLowerCase",e=>e.toLowerCase()),this.bindFunction("trim",e=>e.trim()),this.bindFunction("split",(e,t)=>void 0!==t?e.split(t):e.split("")),this.bindFunction("replace",(e,t,s)=>e.replace(t,s)),this.bindFunction("substring",(e,t,s)=>e.substring(t,s)),this.bindFunction("charAt",(e,t)=>e.charAt(t)),this.bindFunction("charCodeAt",(e,t)=>e.charCodeAt(t)),this.bindFunction("startsWith",(e,t)=>e.startsWith(t)),this.bindFunction("endsWith",(e,t)=>e.endsWith(t)),this.bindFunction("repeat",(e,t)=>e.repeat(t)),this.bindFunction("padStart",(e,t,s)=>e.padStart(t,s)),this.bindFunction("padEnd",(e,t,s)=>e.padEnd(t,s)),this.bindFunction("pow",Math.pow),this.bindFunction("sqrt",Math.sqrt),this.bindFunction("random",Math.random),this.bindFunction("typeof",e=>typeof e),this.bindFunction("isArray",Array.isArray),this.bindFunction("isNaN",isNaN),this.bindFunction("isFinite",isFinite),this.bindFunction("parseInt",parseInt),this.bindFunction("parseFloat",parseFloat),this.bindFunction("parseJSON",JSON.parse),this.bindFunction("stringify",JSON.stringify),this.bindFunction("wait",e=>new Promise(t=>setTimeout(t,e))),this.bindFunction("Promise",Promise)}bindFunction(e,t){this.globalContext.functions.set(e,t)}setVariable(e,t){this.globalContext.variables.set(e,t)}async execute(e,t,s){this.consoleLogs=[];const r=new m.Parser(m.Grammar.fromCompiled(E));try{if(r.feed(e),0===r.results.length)throw new n("No parse found",{type:"ParseError"});r.results.length>1&&console.warn("Ambiguous grammar detected, using first parse");const o=r.results[0],a=t||this.globalContext,i=this.currentContext;this.currentContext=a;try{const e=await this.evaluateNode(o);return s?.withMetadata?{result:e,metadata:{logs:[...this.consoleLogs]}}:e}finally{this.currentContext=i}}catch(e){if(e&&"object"==typeof e&&"return"===e.type)return s?.withMetadata?{result:e.value,metadata:{logs:[...this.consoleLogs]}}:e.value;if(e instanceof n)throw e;const t=e instanceof Error?e.message:JSON.stringify(e);throw new n(`Parse error: ${t}`,{type:"ParseError"},e instanceof Error?e:void 0)}}createSyncFunction(e){const t=this.currentContext,s=this.currentContext.variables.get("this"),n=this,r=function(...o){const a=n.createContext(t);e.id&&e.id.name&&a.variables.set(e.id.name,r),"ArrowFunctionExpression"===e.type?a.variables.set("this",s):a.variables.set("this",this),e.params.forEach((e,t)=>{if("Identifier"===e.type)a.variables.set(e.name,o[t]);else if("RestElement"===e.type)a.variables.set(e.argument.name,o.slice(t));else if("AssignmentPattern"===e.type){const s=void 0!==o[t]?o[t]:n.evaluateNodeSync(e.right);"Identifier"===e.left.type&&a.variables.set(e.left.name,s)}});const i=n.currentContext;n.currentContext=a;try{const t=e.body;if("ArrowFunctionExpression"===e.type&&"BlockStatement"!==t.type)return n.evaluateNodeSync(t);let s;for(const e of t.body)try{s=n.evaluateNodeSync(e)}catch(e){if("return"===e.type)return e.value;throw e}return s}finally{n.currentContext=i}};return r}evaluateNodeSync(e){if(e)switch(e.type){case"Literal":return e.value;case"RegexLiteral":return new RegExp(e.pattern,e.flags);case"Identifier":return this.evaluateIdentifier(e);case"MemberExpression":const t=this.evaluateNodeSync(e.object);if(e.optional&&null==t)return;if(!e.optional&&null==t)throw new Error(`Cannot read properties of ${t} (reading '${e.computed?"computed property":e.property.name}')`);return t[e.computed?this.evaluateNodeSync(e.property):e.property.name];case"BinaryExpression":const s=this.evaluateNodeSync(e.left),n=this.evaluateNodeSync(e.right);switch(e.operator){case"+":return s+n;case"-":return s-n;case"*":return s*n;case"/":return s/n;case"%":return s%n;case"==":return s==n;case"!=":return s!=n;case"===":return s===n;case"!==":return s!==n;case"<":return s<n;case"<=":return s<=n;case">":return s>n;case">=":return s>=n;case"&&":return s&&n;case"||":return s||n;default:throw new Error(`Unknown operator: ${e.operator}`)}case"UnaryExpression":const r=this.evaluateNodeSync(e.argument);switch(e.operator){case"!":return!r;case"-":return-r;case"+":return+r;case"typeof":return typeof r;default:throw new Error(`Unknown unary operator: ${e.operator}`)}case"AssignmentExpression":const o=this.evaluateNodeSync(e.right);if("MemberExpression"===e.left.type){this.evaluateNodeSync(e.left.object)[e.left.computed?this.evaluateNodeSync(e.left.property):e.left.property.name]=o}else"Identifier"===e.left.type&&this.currentContext.variables.set(e.left.name,o);return o;case"ConditionalExpression":return this.evaluateNodeSync(e.test)?this.evaluateNodeSync(e.consequent):this.evaluateNodeSync(e.alternate);case"BlockStatement":let a;for(const t of e.body)a=this.evaluateNodeSync(t);return a;case"ExpressionStatement":return this.evaluateNodeSync(e.expression);case"ReturnStatement":throw{type:"return",value:e.argument?this.evaluateNodeSync(e.argument):void 0};case"IfStatement":return this.evaluateNodeSync(e.test)?this.evaluateNodeSync(e.consequent):e.alternate?this.evaluateNodeSync(e.alternate):void 0;case"CallExpression":let i,l=null;if("MemberExpression"===e.callee.type){const t=this.evaluateNodeSync(e.callee.object),s=e.callee.computed?this.evaluateNodeSync(e.callee.property):e.callee.property.name;i=t?.[s],l=t}else i=this.evaluateNodeSync(e.callee);if("function"!=typeof i)throw new Error(`Not a function: ${e.callee.name||"expression"}`);const c=e.arguments.map(e=>{if("SpreadElement"===e.type){return this.evaluateNodeSync(e.argument)}return this.evaluateNodeSync(e)}),p=c.map(e=>void 0===e&&void 0!==this.lastPipelineValue?this.lastPipelineValue:e),u=[];for(let t=0;t<p.length;t++)"SpreadElement"===e.arguments[t].type?u.push(...p[t]):u.push(p[t]);return i.apply(l,u);case"ThrowStatement":throw this.evaluateNodeSync(e.argument);case"ThisExpression":return this.currentContext.variables.get("this");case"ArrowFunctionExpression":case"FunctionExpression":return this.createSyncFunction(e);case"ObjectExpression":const m={};for(const t of e.properties)if("SpreadElement"===t.type){const e=this.evaluateNodeSync(t.argument);Object.assign(m,e)}else{const e=t.computed?this.evaluateNodeSync(t.key):"Identifier"===t.key.type?t.key.name:this.evaluateNodeSync(t.key);t.shorthand?m[e]=this.evaluateIdentifier(t.key):m[e]=this.evaluateNodeSync(t.value)}return m;case"ArrayExpression":const y=[];for(const t of e.elements)if(null===t)y.push(void 0);else if("SpreadElement"===t.type){const e=this.evaluateNodeSync(t.argument);y.push(...e)}else y.push(this.evaluateNodeSync(t));return y;case"PipelineExpression":const h=this.evaluateNodeSync(e.left),f=this.lastPipelineValue;this.lastPipelineValue=h;try{return this.evaluateNodeSync(e.right)}finally{this.lastPipelineValue=f}default:throw new Error(`Cannot evaluate node type synchronously: ${e.type}`)}}async evaluateNode(e){if(e)switch(e.type){case"Program":return this.evaluateProgram(e);case"VariableDeclaration":return this.evaluateVariableDeclaration(e);case"FunctionDeclaration":return this.evaluateFunctionDeclaration(e);case"ClassDeclaration":return this.evaluateClassDeclaration(e);case"ExpressionStatement":return this.evaluateNode(e.expression);case"BlockStatement":return this.evaluateBlock(e);case"IfStatement":return this.evaluateIfStatement(e);case"ForStatement":case"ForOfStatement":case"ForInStatement":return this.evaluateForStatement(e);case"WhileStatement":return this.evaluateWhileStatement(e);case"DoWhileStatement":return this.evaluateDoWhileStatement(e);case"SwitchStatement":return this.evaluateSwitchStatement(e);case"BreakStatement":throw{type:"break",label:e.label};case"ContinueStatement":throw{type:"continue",label:e.label};case"LabeledStatement":return this.evaluateLabeledStatement(e);case"ReturnStatement":throw{type:"return",value:e.argument?await this.evaluateNode(e.argument):void 0};case"ThrowStatement":throw await this.evaluateNode(e.argument);case"TryStatement":return this.evaluateTryStatement(e);case"ImportDeclaration":return this.evaluateImport(e);case"ExportNamedDeclaration":return this.evaluateExport(e);case"Identifier":return this.evaluateIdentifier(e);case"Literal":return e.value;case"RegexLiteral":return new RegExp(e.pattern,e.flags);case"TemplateLiteral":return this.evaluateTemplateLiteral(e);case"ArrayExpression":return this.evaluateArrayExpression(e);case"ObjectExpression":return this.evaluateObjectExpression(e);case"FunctionExpression":case"ArrowFunctionExpression":return this.createFunction(e);case"CallExpression":return this.evaluateCallExpression(e);case"NewExpression":return this.evaluateNewExpression(e);case"MemberExpression":return this.evaluateMemberExpression(e);case"BinaryExpression":return this.evaluateBinaryExpression(e);case"UnaryExpression":return this.evaluateUnaryExpression(e);case"AssignmentExpression":return this.evaluateAssignmentExpression(e);case"UpdateExpression":return this.evaluateUpdateExpression(e);case"ConditionalExpression":return this.evaluateConditionalExpression(e);case"PipelineExpression":return this.evaluatePipelineExpression(e);case"ThisExpression":return this.currentContext.variables.get("this");case"Super":return this.currentContext.variables.get("__super__");case"SpreadElement":const t=await this.evaluateNode(e.argument);if(!Array.isArray(t))throw new o("array",t,"spread operator");return t;default:throw new n(`Unknown node type: ${e.type}`,{type:"RuntimeError"})}}async evaluateProgram(e){const t=this.processContinuations(e.body);let s;this.hoistVarDeclarations(t);for(const e of t)s=await this.evaluateNode(e);return s}processContinuations(e){const t=[];for(let s=0;s<e.length;s++){const n=e[s];if("PipelineContinuation"===n.type||"MemberContinuation"===n.type){if(t.length>0){const e=t[t.length-1];if("ExpressionStatement"===e.type){if("AssignmentExpression"===e.expression.type){if("PipelineContinuation"===n.type)e.expression.right={type:"PipelineExpression",operator:n.operator,left:e.expression.right,right:n.right};else if("MemberContinuation"===n.type){const t={type:"MemberExpression",object:e.expression.right,property:n.property,computed:!1,optional:n.optional};e.expression.right=n.arguments?{type:"CallExpression",callee:t,arguments:n.arguments}:t}}else if("PipelineContinuation"===n.type)e.expression={type:"PipelineExpression",operator:n.operator,left:e.expression,right:n.right};else if("MemberContinuation"===n.type){const t={type:"MemberExpression",object:e.expression,property:n.property,computed:!1,optional:n.optional};e.expression=n.arguments?{type:"CallExpression",callee:t,arguments:n.arguments}:t}continue}if("VariableDeclaration"===e.type&&e.declarations&&e.declarations.length>0){const t=e.declarations[e.declarations.length-1];if(t.init){if("PipelineContinuation"===n.type)t.init={type:"PipelineExpression",operator:n.operator,left:t.init,right:n.right};else if("MemberContinuation"===n.type){const e={type:"MemberExpression",object:t.init,property:n.property,computed:!1,optional:n.optional};t.init=n.arguments?{type:"CallExpression",callee:e,arguments:n.arguments}:e}continue}}if("ReturnStatement"===e.type&&e.argument){if("PipelineContinuation"===n.type)e.argument={type:"PipelineExpression",operator:n.operator,left:e.argument,right:n.right};else if("MemberContinuation"===n.type){const t={type:"MemberExpression",object:e.argument,property:n.property,computed:!1,optional:n.optional};e.argument=n.arguments?{type:"CallExpression",callee:t,arguments:n.arguments}:t}continue}}throw new Error(`Unexpected continuation operator at statement ${s+1}`)}t.push(n)}return t}hoistVarDeclarations(e){for(const t of e)if("VariableDeclaration"===t.type&&"var"===t.kind)for(const e of t.declarations)this.hoistVarPattern(e.id);else"FunctionDeclaration"===t.type&&this.currentContext.functions.set(t.id.name,this.createFunction(t))}hoistVarPattern(e){if("Identifier"===e.type)this.currentContext.variables.has(e.name)||(this.currentContext.variables.set(e.name,void 0),this.currentContext.variableKinds.set(e.name,"var"));else if("ObjectPattern"===e.type)for(const t of e.properties)if("Property"===t.type)if(t.shorthand&&"string"==typeof t.value)this.currentContext.variables.has(t.value)||(this.currentContext.variables.set(t.value,void 0),this.currentContext.variableKinds.set(t.value,"var"));else{const e="string"==typeof t.value?{type:"Identifier",name:t.value}:t.value;this.hoistVarPattern(e)}else"RestElement"===t.type&&(this.currentContext.variables.has(t.argument)||(this.currentContext.variables.set(t.argument,void 0),this.currentContext.variableKinds.set(t.argument,"var")));else if("ArrayPattern"===e.type)for(const t of e.elements)if(t)if("RestElement"===t.type){const e=t.argument.name||t.argument;this.currentContext.variables.has(e)||(this.currentContext.variables.set(e,void 0),this.currentContext.variableKinds.set(e,"var"))}else this.hoistVarPattern(t)}async evaluateVariableDeclaration(e){for(const t of e.declarations){const s=t.init?await this.evaluateNode(t.init):void 0;this.assignPattern(t.id,s,e.kind)}}assignPattern(e,t,s){if("Identifier"===e.type)if("var"===s){let s=this.currentContext;for(;s;){if(s.variables.has(e.name)){s.variables.set(e.name,t);break}s=s.parent}s||(this.currentContext.variables.set(e.name,t),this.currentContext.variableKinds.set(e.name,"var"))}else this.currentContext.variables.set(e.name,t),s&&this.currentContext.variableKinds.set(e.name,s);else if("ObjectPattern"===e.type){if(null==t)throw new TypeError("Cannot destructure 'null' or 'undefined'");for(const n of e.properties)if("Property"===n.type){const e="Identifier"===n.key.type?n.key.name:n.key.value;if(n.shorthand&&"string"==typeof n.value)this.currentContext.variables.set(n.value,t[e]),s&&this.currentContext.variableKinds.set(n.value,s);else{const r="string"==typeof n.value?{type:"Identifier",name:n.value}:n.value;this.assignPattern(r,t[e],s)}}else if("RestElement"===n.type){const r={...t};for(const t of e.properties)if("Property"===t.type){delete r["Identifier"===t.key.type?t.key.name:t.key.value]}this.currentContext.variables.set(n.argument,r),s&&this.currentContext.variableKinds.set(n.argument,s)}}else if("ArrayPattern"===e.type){if(null==t)throw new TypeError("Cannot destructure 'null' or 'undefined'");const n=Array.isArray(t)?t:[];let r=0;for(const t of e.elements)t&&("RestElement"===t.type?(this.currentContext.variables.set(t.argument.name||t.argument,n.slice(r)),s&&this.currentContext.variableKinds.set(t.argument.name||t.argument,s)):this.assignPattern(t,n[r],s)),r++}}async evaluateFunctionDeclaration(e){const t=this.createFunction(e);this.currentContext.functions.set(e.id.name,t)}createFunction(e){const t=e.params||[],s=e.body,n=e.async,r=this.currentContext,o="ArrowFunctionExpression"===e.type?this.currentContext.variables.get("this"):void 0;if(!n&&"ArrowFunctionExpression"===e.type&&"BlockStatement"!==s.type){return(...e)=>{const n=this.createContext(r);n.variables.set("this",o);const a=this.currentContext;this.currentContext=n;for(let s=0;s<t.length;s++){const r=t[s];if("RestElement"===r.type)n.variables.set(r.argument.name||r.argument,e.slice(s));else if("Identifier"===r.type)n.variables.set(r.name,e[s]);else if("AssignmentPattern"===r.type){const t=void 0!==e[s]?e[s]:this.evaluateNodeSync(r.right);"Identifier"===r.left.type&&n.variables.set(r.left.name,t)}}try{return this.evaluateNodeSync(s)}finally{this.currentContext=a}}}const a=this,i=async function(...n){const l=a.createContext(r);e.id&&e.id.name&&l.variables.set(e.id.name,i),"ArrowFunctionExpression"===e.type?l.variables.set("this",o):l.variables.set("this",this);const c=a.currentContext;a.currentContext=l;for(let e=0;e<t.length;e++){const s=t[e];if("RestElement"===s.type){l.variables.set(s.argument.name||s.argument,n.slice(e));break}if("AssignmentPattern"===s.type){const t=e<n.length&&void 0!==n[e]?n[e]:await a.evaluateNode(s.right);a.assignPattern(s.left,t)}else a.assignPattern(s,n[e])}try{return"BlockStatement"===s.type?(a.hoistVarDeclarations(s.body),void await a.evaluateBlock(s)):await a.evaluateNode(s)}catch(e){if("return"===e?.type)return e.value;throw e}finally{a.currentContext=c}};return n?i:(...e)=>{const t=i(...e);return t instanceof Promise?t:Promise.resolve(t)}}async evaluateClassDeclaration(e){const t=e.id.name,s=e.superClass?this.evaluateIdentifier(e.superClass):null,n=e.body.body.find(e=>"constructor"===e.kind),r=this,o=function(...e){return(async()=>{const t=Object.create(o.prototype);if(n){const o=r.createContext(r.currentContext);o.variables.set("this",t),s&&o.variables.set("__super__",async(...e)=>{const n=await s(...e);Object.assign(t,n),n instanceof Error&&(void 0!==n.message&&(t.message=n.message),void 0!==n.name&&(t.name=n.name),void 0!==n.stack&&(t.stack=n.stack))});for(let t=0;t<n.params.length;t++){const s=n.params[t];"Identifier"===s.type&&o.variables.set(s.name,e[t])}const a=r.currentContext;r.currentContext=o;try{for(const e of n.body.body)await r.evaluateNode(e)}finally{r.currentContext=a}}return t})()};s&&(o.prototype=Object.create(s.prototype),o.prototype.constructor=o);for(const t of e.body.body)if("MethodDefinition"===t.type&&"constructor"!==t.kind){const e=t.key.name;if("get"===t.kind||"set"===t.kind){const s=t.static?o:o.prototype,n=Object.getOwnPropertyDescriptor(s,e)||{configurable:!0,enumerable:!0};"get"===t.kind?n.get=function(){const e=r.createContext(r.currentContext);e.variables.set("this",this);const s=r.currentContext;r.currentContext=e;try{let e;for(const s of t.body.body)try{e=r.evaluateNodeSync(s)}catch(e){if("return"===e.type)return e.value;throw e}return e}finally{r.currentContext=s}}:n.set=function(e){const s=r.createContext(r.currentContext);if(s.variables.set("this",this),t.params.length>0){const n=t.params[0];"Identifier"===n.type&&s.variables.set(n.name,e)}const n=r.currentContext;r.currentContext=s;try{for(const e of t.body.body)if("ExpressionStatement"===e.type)r.evaluateNodeSync(e.expression);else if("IfStatement"===e.type){r.evaluateNodeSync(e.test)?r.evaluateNodeSync(e.consequent):e.alternate&&r.evaluateNodeSync(e.alternate)}else if("ThrowStatement"===e.type)throw r.evaluateNodeSync(e.argument)}finally{r.currentContext=n}},Object.defineProperty(s,e,n)}else{const s=async function(...e){const s=r.createContext(r.currentContext);s.variables.set("this",t.static?o:this);for(let n=0;n<t.params.length;n++){const o=t.params[n];if("Identifier"===o.type)s.variables.set(o.name,e[n]);else if("AssignmentPattern"===o.type){const t=n<e.length&&void 0!==e[n]?e[n]:await r.evaluateNode(o.right);"Identifier"===o.left.type&&s.variables.set(o.left.name,t)}}const n=r.currentContext;r.currentContext=s;try{let e;for(const s of t.body.body)try{e=await r.evaluateNode(s)}catch(e){if("return"===e.type)return e.value;throw e}return e}finally{r.currentContext=n}};t.static?o[e]=s:o.prototype[e]=s}}this.currentContext.classes.set(t,o),this.currentContext.variables.set(t,o)}async evaluateBlock(e){const t=this.createContext(this.currentContext),s=this.currentContext;this.currentContext=t;try{e._processedBody||(e._processedBody=this.processContinuations(e.body));const t=e._processedBody;let s;for(const e of t)s=await this.evaluateNode(e);return s}finally{this.currentContext=s}}async evaluateIfStatement(e){return await this.evaluateNode(e.test)?await this.evaluateNode(e.consequent):e.alternate?await this.evaluateNode(e.alternate):void 0}async evaluateForStatement(e){if("ForOfStatement"===e.type){const t=await this.evaluateNode(e.right);for(const s of t){"VariableDeclaration"===e.left.type&&this.assignPattern(e.left.declarations[0].id,s);try{await this.evaluateNode(e.body)}catch(e){if("break"===e.type&&!e.label)break;if("continue"===e.type&&!e.label)continue;throw e}}}else if("ForInStatement"===e.type){const t=await this.evaluateNode(e.right);for(const s in t){"VariableDeclaration"===e.left.type&&this.assignPattern(e.left.declarations[0].id,s);try{await this.evaluateNode(e.body)}catch(e){if("break"===e.type&&!e.label)break;if("continue"===e.type&&!e.label)continue;throw e}}}else for(e.init&&await this.evaluateNode(e.init);!e.test||await this.evaluateNode(e.test);){try{await this.evaluateNode(e.body)}catch(t){if("break"===t.type&&!t.label)break;if("continue"===t.type&&!t.label){e.update&&await this.evaluateNode(e.update);continue}throw t}e.update&&await this.evaluateNode(e.update)}}async evaluateWhileStatement(e){for(;await this.evaluateNode(e.test);)try{await this.evaluateNode(e.body)}catch(e){if("break"===e.type&&!e.label)break;if("continue"===e.type&&!e.label)continue;throw e}}async evaluateDoWhileStatement(e){do{try{await this.evaluateNode(e.body)}catch(e){if("break"===e.type&&!e.label)break;if("continue"===e.type&&!e.label)continue;throw e}}while(await this.evaluateNode(e.test))}async evaluateLabeledStatement(e){try{return await this.evaluateNode(e.body)}catch(t){if(("break"===t.type||"continue"===t.type)&&t.label===e.label){if("break"===t.type)return;throw t}throw t}}async evaluateSwitchStatement(e){const t=await this.evaluateNode(e.discriminant);let s=!1;for(const n of e.cases){if(!s)if(null===n.test)s=!0;else{t===await this.evaluateNode(n.test)&&(s=!0)}if(s)try{for(const e of n.consequent)await this.evaluateNode(e)}catch(e){if("break"===e.type)break;throw e}}}async evaluateTryStatement(e){let t;try{t=await this.evaluateNode(e.block)}catch(s){if(s&&"object"==typeof s&&("break"===s.type||"continue"===s.type||"return"===s.type))throw s;if(!e.handler)throw s;e.handler.param&&this.assignPattern(e.handler.param,s),t=await this.evaluateNode(e.handler.body)}finally{if(e.finalizer){t=await this.evaluateNode(e.finalizer)}}return t}evaluateIdentifier(e){const t=e.name;if("_"===t)return this.lastPipelineValue;if("this"===t&&console.log("Looking up this, context has:",this.currentContext.variables.has("this"),"value:",this.currentContext.variables.get("this")),this.currentContext.variables.has(t))return this.currentContext.variables.get(t);let s=this.currentContext.parent;for(;s;){if(s.variables.has(t))return s.variables.get(t);s=s.parent}if(this.currentContext.functions.has(t))return this.currentContext.functions.get(t);if(this.globalContext.functions.has(t))return this.globalContext.functions.get(t);if(this.currentContext.classes.has(t))return this.currentContext.classes.get(t);throw new a(t,[...this.currentContext.variables.keys()])}async evaluateCallExpression(e){if("Super"===e.callee.type){const t=this.currentContext.variables.get("__super__");if(!t)throw new n("super() can only be called in a derived class constructor",{type:"RuntimeError"});const s=[];for(const t of e.arguments)if("SpreadElement"===t.type){const e=await this.evaluateNode(t.argument);s.push(...e)}else s.push(await this.evaluateNode(t));return t(...s)}let t,s=null;if("MemberExpression"===e.callee.type){const n=await this.evaluateNode(e.callee.object),r=e.callee.computed?await this.evaluateNode(e.callee.property):e.callee.property.name;t=n?.[r],s=n}else t=await this.evaluateNode(e.callee);if("function"!=typeof t)throw new o("function",t,"call expression");const r=[];for(const t of e.arguments)if("SpreadElement"===t.type){const e=await this.evaluateNode(t.argument);r.push(...e)}else r.push(await this.evaluateNode(t));const a=r.map(e=>void 0===e&&void 0!==this.lastPipelineValue?this.lastPipelineValue:e);return t.apply(s,a)}async evaluatePipelineExpression(e){let t=await this.evaluateNode(e.left);this.lastPipelineValue=t;const s=await this.evaluateNode(e.right);return t="function"==typeof s?await s(t):s,this.lastPipelineValue=t,t}async evaluateBinaryExpression(e){const t=await this.evaluateNode(e.left),s=await this.evaluateNode(e.right);switch(e.operator){case"+":return t+s;case"-":return t-s;case"*":return t*s;case"/":return t/s;case"%":return t%s;case"**":return t**s;case"==":return t==s;case"!=":return t!=s;case"===":return t===s;case"!==":return t!==s;case"<":return t<s;case">":return t>s;case"<=":return t<=s;case">=":return t>=s;case"&&":return t&&s;case"||":return t||s;case"??":return t??s;default:throw new n(`Unknown binary operator: ${e.operator}`,{type:"RuntimeError"})}}async evaluateUnaryExpression(e){if("++"===e.operator||"--"===e.operator){if("Identifier"!==e.argument.type)throw new n("Prefix increment/decrement only supports identifiers",{type:"RuntimeError"});const t=e.argument.name,s=this.evaluateIdentifier(e.argument)||0,r="++"===e.operator?s+1:s-1;let o=this.currentContext;for(;o;){if(o.variables.has(t)){o.variables.set(t,r);break}o=o.parent}return o||this.currentContext.variables.set(t,r),r}if("typeof"===e.operator){if("Identifier"===e.argument.type){const t=e.argument.name;let s=this.currentContext;for(;s;){if(s.variables.has(t)){return typeof s.variables.get(t)}if(s.functions.has(t))return"function";s=s.parent}return this.currentContext.functions.has(t)?"function":"undefined"}return typeof await this.evaluateNode(e.argument)}const t=await this.evaluateNode(e.argument);switch(e.operator){case"!":return!t;case"+":return+t;case"-":return-t;case"await":return await t;default:throw new n(`Unknown unary operator: ${e.operator}`,{type:"RuntimeError"})}}async evaluateAssignmentExpression(e){const t=await this.evaluateNode(e.right);if("Identifier"===e.left.type){const s=e.left.name;switch(e.operator){case"=":let r=this.currentContext,o=!1;for(;r;){if(r.variables.has(s)){if("const"===r.variableKinds.get(s))throw new n(`Cannot reassign const variable "${s}"`);r.variables.set(s,t),o=!0;break}r=r.parent}return o||this.currentContext.variables.set(s,t),t;case"+=":const a=(this.evaluateIdentifier(e.left)||0)+t;let i=this.currentContext;for(;i;){if(i.variables.has(s)){if("const"===i.variableKinds.get(s))throw new n(`Cannot reassign const variable "${s}"`);i.variables.set(s,a);break}i=i.parent}return i||this.currentContext.variables.set(s,a),a;case"-=":const l=(this.evaluateIdentifier(e.left)||0)-t;let c=this.currentContext;for(;c;){if(c.variables.has(s)){if("const"===c.variableKinds.get(s))throw new n(`Cannot reassign const variable "${s}"`);c.variables.set(s,l);break}c=c.parent}return c||this.currentContext.variables.set(s,l),l;case"*=":const p=(this.evaluateIdentifier(e.left)||0)*t;let u=this.currentContext;for(;u;){if(u.variables.has(s)){if("const"===u.variableKinds.get(s))throw new n(`Cannot reassign const variable "${s}"`);u.variables.set(s,p);break}u=u.parent}return u||this.currentContext.variables.set(s,p),p;case"/=":const m=this.evaluateIdentifier(e.left)||0;if(0===t)throw new n("Division by zero in /= operation");const y=m/t;let h=this.currentContext;for(;h;){if(h.variables.has(s)){if("const"===h.variableKinds.get(s))throw new n(`Cannot reassign const variable "${s}"`);h.variables.set(s,y);break}h=h.parent}return h||this.currentContext.variables.set(s,y),y;default:throw new n(`Assignment operator ${e.operator} not implemented`,{type:"RuntimeError"})}}else if("MemberExpression"===e.left.type){const s=await this.evaluateNode(e.left.object),r=e.left.computed?await this.evaluateNode(e.left.property):e.left.property.name;if(null==s)throw new n(`Cannot set property '${r}' on null or undefined`,{type:"RuntimeError"});switch(e.operator){case"=":return s[r]=t,t;case"+=":return s[r]=(s[r]||0)+t,s[r];case"-=":return s[r]=(s[r]||0)-t,s[r];case"*=":return s[r]=(s[r]||0)*t,s[r];case"/=":if(0===t)throw new n("Division by zero in /= operation");return s[r]=(s[r]||0)/t,s[r];default:throw new n(`Assignment operator ${e.operator} not implemented for member expressions`,{type:"RuntimeError"})}}throw new n("Complex assignment patterns not yet implemented",{type:"RuntimeError"})}async evaluateUpdateExpression(e){if("Identifier"===e.argument.type){const t=e.argument.name,s=this.evaluateIdentifier(e.argument)||0,r="++"===e.operator?s+1:s-1;let o=this.currentContext;for(;o;){if(o.variables.has(t)){if("const"===o.variableKinds.get(t))throw new n(`Cannot reassign const variable "${t}"`);o.variables.set(t,r);break}o=o.parent}return o||this.currentContext.variables.set(t,r),e.prefix?r:s}if("MemberExpression"===e.argument.type){const t=await this.evaluateNode(e.argument.object),s=e.argument.computed?await this.evaluateNode(e.argument.property):e.argument.property.name;if(null==t)throw new n(`Cannot update property '${s}' on null or undefined`,{type:"RuntimeError"});const r=t[s]||0,o="++"===e.operator?r+1:r-1;return t[s]=o,e.prefix?o:r}throw new n("Update expression only supports identifiers and member expressions",{type:"RuntimeError"})}async evaluateConditionalExpression(e){return await this.evaluateNode(e.test)?await this.evaluateNode(e.consequent):await this.evaluateNode(e.alternate)}async evaluateMemberExpression(e){const t=await this.evaluateNode(e.object);if(e.optional&&null==t)return;if(!e.optional&&null==t){const s=e.computed?"computed property":e.property.name;throw new Error(`Cannot read properties of ${t} (reading '${s}')`)}return t[e.computed?await this.evaluateNode(e.property):e.property.name]}async evaluateNewExpression(e){const t=await this.evaluateNode(e.callee);if("function"!=typeof t)throw new o("constructor",t,"new expression");const s=[];for(const t of e.arguments)s.push(await this.evaluateNode(t));if(t===Date||t===Error||t===Array||t===Object||t===RegExp||t===Map||t===Set||t===Promise)return new t(...s);return await t(...s)}async evaluateArrayExpression(e){const t=[];for(const s of e.elements)if(s)if("SpreadElement"===s.type){const e=await this.evaluateNode(s.argument);t.push(...e)}else t.push(await this.evaluateNode(s));else t.push(void 0);return t}async evaluateObjectExpression(e){const t={};for(const s of e.properties)if("SpreadElement"===s.type){const e=await this.evaluateNode(s.argument);Object.assign(t,e)}else if("Property"===s.type){const e=s.computed?await this.evaluateNode(s.key):s.key.name||s.key.value||s.key;s.shorthand?t[e]=this.evaluateIdentifier({name:e}):t[e]=await this.evaluateNode(s.value)}return t}async evaluateTemplateLiteral(e){if(e.quasis&&e.quasis.length>0){const t=e.quasis[0].value.raw;return t.includes("${")?await this.interpolateTemplate(t):t}const t=e.raw||e.value;if("string"==typeof t&&t.startsWith("`")&&t.endsWith("`")){const e=t.slice(1,-1);return await this.interpolateTemplate(e)}return e.value||""}async interpolateTemplate(e){const t=/\$\{([^}]+)\}/g;let s,n=e;const r=[];for(;null!==(s=t.exec(e));){const e=s[1];try{const t=e.trim(),n=await this.evaluateTemplateExpression(t);r.push({start:s.index,end:s.index+s[0].length,value:String(n)})}catch(t){console.warn(`Failed to evaluate template expression: ${e}`)}}for(let e=r.length-1;e>=0;e--){const t=r[e];n=n.slice(0,t.start)+t.value+n.slice(t.end)}return n}async evaluateTemplateExpression(e){if(/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(e))return this.evaluateIdentifier({name:e});const t=e.match(/^(.+?)\s*([\+\-\*\/])\s*(.+)$/);if(t){const s=await this.evaluateTemplateExpression(t[1].trim()),n=await this.evaluateTemplateExpression(t[3].trim());switch(t[2]){case"+":return s+n;case"-":return s-n;case"*":return s*n;case"/":return s/n;default:return e}}if(e.includes(".")){const t=e.split(".");let s=await this.evaluateTemplateExpression(t[0]);for(let e=1;e<t.length;e++)s=s[t[e]];return s}const s=Number(e);return isNaN(s)?e.startsWith('"')&&e.endsWith('"')||e.startsWith("'")&&e.endsWith("'")?e.slice(1,-1):e:s}async evaluateImport(e){const t=e.source.value||e.source,s=await this.importModule(t);for(const t of e.specifiers)if("ImportNamespaceSpecifier"===t.type){const e=t.local.name||t.local;this.currentContext.variables.set(e,s)}else if("ImportSpecifier"===t.type){const e=t.imported.name||t.imported,n=t.local.name||t.local,r=s[e];this.currentContext.variables.set(n,r)}}async evaluateExport(e){if(e.declaration)if(await this.evaluateNode(e.declaration),"VariableDeclaration"===e.declaration.type){for(const t of e.declaration.declarations)if("Identifier"===t.id.type){const e=this.currentContext.variables.get(t.id.name);this.currentContext.exports.set(t.id.name,e),this.currentContext.moduleExports&&(this.currentContext.moduleExports[t.id.name]=e)}}else if("FunctionDeclaration"===e.declaration.type){const t=this.currentContext.functions.get(e.declaration.id.name);this.currentContext.exports.set(e.declaration.id.name,t),this.currentContext.moduleExports&&(this.currentContext.moduleExports[e.declaration.id.name]=t)}else if("ClassDeclaration"===e.declaration.type){const t=this.currentContext.classes.get(e.declaration.id.name);this.currentContext.exports.set(e.declaration.id.name,t),this.currentContext.moduleExports&&(this.currentContext.moduleExports[e.declaration.id.name]=t)}for(const t of e.specifiers||[]){const e=this.currentContext.variables.get(t.local)||this.currentContext.functions.get(t.local)||this.currentContext.classes.get(t.local);this.currentContext.exports.set(t.exported,e),this.currentContext.moduleExports&&(this.currentContext.moduleExports[t.exported]=e)}}async importModule(e){if(this.globalModuleCache.has(e))return this.globalModuleCache.get(e);const t={};this.globalModuleCache.set(e,t);const{code:s}=await this.moduleResolver.resolve(e),n=this.createContext(this.globalContext);return n.moduleExports=t,await this.execute(s,n),n.exports.forEach((e,s)=>{t[s]=e}),t}}class C extends w{constructor(e={}){super(e),this.operationCounter=0,this.contextIdMap=new Map,this.idContextMap=new Map,this.nextContextId=0,this.pauseCheckInterval=e.pauseCheckInterval??10,this.executionState={type:"completed",callStack:[]}}pause(){"running"===this.executionState.type&&(this.executionState.pauseRequested=!0)}async resume(){if("paused"!==this.executionState.type)throw new Error("Interpreter is not paused");this.executionState.type="running",this.executionState.pauseRequested=!1;try{const e=await this.resumeFromCallStack();return this.executionState.type="completed",this.executionState.result=e,e}catch(e){throw this.executionState.type="error",this.executionState.error=e,e}}async checkPause(){if(this.operationCounter++,this.operationCounter%this.pauseCheckInterval===0&&await new Promise(e=>setTimeout(e,0)),this.executionState.pauseRequested)throw this.executionState.type="paused",this.executionState.pauseRequested=!1,{type:"pause",state:this.executionState}}async evaluateNode(e){await this.checkPause(),this.executionState.currentNode=e;let t;["FunctionDeclaration","FunctionExpression","ArrowFunctionExpression","BlockStatement","ForStatement","WhileStatement","DoWhileStatement"].includes(e.type)&&(t={type:this.getFrameType(e.type),node:e,context:this.currentContext,name:e.id?.name},this.executionState.callStack.push(t));try{const s=await super.evaluateNode(e);return t&&this.executionState.callStack.pop(),s}catch(e){if(e&&"object"==typeof e&&"pause"===e.type)throw e;throw t&&this.executionState.callStack.pop(),e}}async execute(e,t){this.executionState={type:"running",callStack:[]};const{grammar:s,nearley:n}=await Promise.resolve().then(function(){return $}),r=new n.Parser(n.Grammar.fromCompiled(s));try{if(r.feed(e),0===r.results.length)throw new Error("No parse found");r.results.length>1&&console.warn("Ambiguous grammar detected, using first parse");const s=r.results[0],n=t||this.globalContext,o=this.currentContext;this.currentContext=n;try{const e=await this.evaluateNode(s);return this.executionState.type="completed",this.executionState.result=e,e}finally{this.currentContext=o}}catch(e){if(e&&"object"==typeof e&&"pause"===e.type)return;if(e&&"object"==typeof e&&"return"===e.type)return this.executionState.type="completed",this.executionState.result=e.value,e.value;throw this.executionState.type="error",this.executionState.error=e,e}}getExecutionState(){return{...this.executionState}}serialize(){return this.assignContextIds(this.globalContext),{version:"1.0.0",globalContext:this.serializeContext(this.globalContext),currentContext:this.serializeContext(this.currentContext),executionState:this.serializeExecutionState(),moduleCache:Array.from(this.globalModuleCache.entries()),lastPipelineValue:this.lastPipelineValue,customFunctions:Array.from(this.globalContext.functions.keys())}}static async deserialize(e,t={}){const s=new C({moduleResolver:t.moduleResolver||new i,functions:t.functions});return s.deserializeContexts(e),e.moduleCache.forEach(([e,t])=>{s.globalModuleCache.set(e,t)}),s.executionState=s.deserializeExecutionState(e.executionState),s.lastPipelineValue=e.lastPipelineValue,s}assignContextIds(e,t=new Set){if(t.has(e))return;t.add(e);const s="ctx_"+this.nextContextId++;this.contextIdMap.set(e,s),this.idContextMap.set(s,e),e.parent&&this.assignContextIds(e.parent,t)}serializeContext(e){const t=e.parent?this.contextIdMap.get(e.parent):void 0;return{variables:Array.from(e.variables.entries()).map(([e,t])=>[e,this.serializeValue(t)]),variableKinds:Array.from(e.variableKinds.entries()),functionNames:Array.from(e.functions.keys()),classNames:Array.from(e.classes.keys()),exports:Array.from(e.exports.entries()).map(([e,t])=>[e,this.serializeValue(t)]),parentId:t,moduleCache:Array.from(e.moduleCache.entries())}}serializeValue(e){if(void 0===e)return{__type:"undefined"};if(null===e)return null;if("function"==typeof e)return{__type:"function",name:e.name||"anonymous"};if(e instanceof Date)return{__type:"Date",value:e.toISOString()};if(e instanceof RegExp)return{__type:"RegExp",source:e.source,flags:e.flags};if(e instanceof Map)return{__type:"Map",entries:Array.from(e.entries())};if(e instanceof Set)return{__type:"Set",values:Array.from(e.values())};if("object"==typeof e)try{return JSON.parse(JSON.stringify(e))}catch{return{__type:"circular_reference"}}return e}deserializeValue(e){if(e&&"object"==typeof e&&"__type"in e)switch(e.__type){case"undefined":return;case"function":return()=>{throw new Error(`Function ${e.name} needs to be re-bound`)};case"Date":return new Date(e.value);case"RegExp":return new RegExp(e.source,e.flags);case"Map":return new Map(e.entries);case"Set":return new Set(e.values);case"circular_reference":return null}return e}serializeExecutionState(){return{...this.executionState,callStack:this.executionState.callStack.map(e=>({...e,context:this.serializeContext(e.context)}))}}deserializeExecutionState(e){return{...e,callStack:e.callStack.map(e=>({...e,context:this.idContextMap.get(e.context.parentId)||this.currentContext}))}}deserializeContexts(e){const t=new Map,s=this.createContext();if(this.restoreContextData(s,e.globalContext),t.set("global",s),this.globalContext=s,e.currentContext===e.globalContext)this.currentContext=s;else{const s=this.createContext();this.restoreContextData(s,e.currentContext),t.set("current",s),this.currentContext=s}e.currentContext.parentId&&(this.currentContext.parent=t.get(e.currentContext.parentId))}restoreContextData(e,t){t.variables.forEach(([t,s])=>{const n=this.deserializeValue(s);e.variables.set(t,n)}),t.variableKinds.forEach(([t,s])=>{e.variableKinds.set(t,s)}),t.variables.some(([e])=>"Date"===e)&&e.variables.set("Date",Date),t.variables.some(([e])=>"Error"===e)&&e.variables.set("Error",Error),t.exports.forEach(([t,s])=>{e.exports.set(t,this.deserializeValue(s))}),t.moduleCache.forEach(([t,s])=>{e.moduleCache.set(t,s)})}getFrameType(e){switch(e){case"FunctionDeclaration":case"FunctionExpression":case"ArrowFunctionExpression":return"function";case"BlockStatement":default:return"block";case"ForStatement":case"WhileStatement":case"DoWhileStatement":return"loop";case"Program":return"program"}}async resumeFromCallStack(){const e=this.executionState.callStack[this.executionState.callStack.length-1];if(!e)throw new Error("No frame to resume from");return this.currentContext=e.context,this.evaluateNode(e.node)}getCallStackTrace(){return this.executionState.callStack.map(e=>{const t=e.name||"<anonymous>";return`${e.type}: ${t}`})}getCurrentVariables(){const e={};let t=this.currentContext;for(;t;)t.variables.forEach((t,s)=>{s in e||(e[s]=t)}),t=t.parent;return e}isPaused(){return"paused"===this.executionState.type}isRunning(){return"running"===this.executionState.type}isCompleted(){return"completed"===this.executionState.type}hasError(){return"error"===this.executionState.type}}class S{validate(e,t={}){try{const s=new m.Parser(m.Grammar.fromCompiled(E));return s.feed(e),0===s.results.length?{valid:!1,error:{message:"No valid parse found",line:0,column:0}}:(s.results.length>1&&console.warn(`Grammar ambiguity: ${s.results.length} possible parses found`),{valid:!0,ast:t.includeAST?s.results[0]:void 0})}catch(t){return this.formatError(t,e)}}formatError(e,t){const s=e.message||e.toString(),n=s.match(/line (\d+) col (\d+)/),r=n?parseInt(n[1]):0,o=n?parseInt(n[2]):0;let a;s.includes("Unexpected NL token")&&s.includes("=>")?a='Arrow functions with newlines require braces. Change "=> \\n expression" to either "=> expression" (single line) or "=> { return expression }" (with braces).':s.includes("Unexpected NL token")&&s.includes("ArrowBody")?a="Multi-line arrow function bodies must use braces. Wrap your expression in { return ... }":s.includes("Unexpected }")?a="Check for missing commas between object properties or unclosed parentheses/brackets.":s.includes("Unexpected identifier")?a="Check for missing operators, commas, or semicolons between statements.":(s.includes("|>")||s.includes("->"))&&(a="Pipeline operators must be followed by a valid expression or function call.");const i=t.split("\\n")[r-1];let l=s.split("\\n")[0];return i&&(l+=`\\n\\nProblematic line ${r}:\\n${i}\\n${" ".repeat(o-1)}^`),{valid:!1,error:{message:l,line:r,column:o,suggestion:a}}}checkSyntaxPatterns(e){return{hasMultilineArrows:/=>\s*\n\s*[^{]/.test(e),hasPipelines:/\|>|->/.test(e),hasAsyncAwait:/\basync\b|\bawait\b/.test(e),hasClasses:/\bclass\b/.test(e),hasModules:/\bimport\b|\bexport\b/.test(e)}}suggestFixes(e){const t=[];return this.checkSyntaxPatterns(e).hasMultilineArrows&&t.push("Found multi-line arrow functions without braces. Consider using braces for multi-line arrow function bodies."),/\)\s*\n\s*{/.test(e)&&!/"function"/.test(e)&&t.push("Found newline between closing parenthesis and opening brace. This might cause parsing issues in some contexts."),/,\s*}/.test(e)&&t.push("Found trailing comma before closing brace. While valid in JavaScript, ensure Wang supports this."),t}}const N=new S;e.CircularDependencyError=class extends n{constructor(e){super(`Circular dependency detected:\n   ${e.join(" → ")} → ${e[0]}`,{type:"ModuleError",suggestions:["Move shared code to a separate module","Use dynamic imports for one direction","Refactor to remove the circular dependency"]})}},e.FunctionNotFoundError=class extends n{constructor(e,t){const s=[],n=t.filter(t=>t.includes(e)||e.includes(t)).slice(0,5);n.length>0&&s.push(`Available similar functions: ${n.join(", ")}`),s.push("Check the function name spelling"),s.push("Ensure the function is imported or defined"),s.push(`Available functions: ${t.slice(0,10).join(", ")}...`),super(`Function "${e}" is not defined`,{type:"RuntimeError",suggestions:s})}},e.InMemoryModuleResolver=i,e.ModuleNotFoundError=r,e.ModuleResolver=t,e.PausableWangInterpreter=C,e.TypeMismatchError=o,e.UndefinedVariableError=a,e.VERSION="0.1.0",e.WangError=n,e.WangInterpreter=w,e.WangValidator=S,e.createInterpreter=function(e){return new w(e)},e.validator=N});
//# sourceMappingURL=wang.min.js.map
